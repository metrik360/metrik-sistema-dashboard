<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema M茅TRIK - Dashboard + CRM</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        :root {
            /* Colores M茅TRIK */
            --color-primary: #1A1A1A;
            --color-accent: #10B981;
            --color-secondary: #6B7280;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-danger: #EF4444;
            --color-info: #3B82F6;
            --color-bg-primary: #F9FAFB;
            --color-bg-secondary: #FFFFFF;
            --color-bg-hover: #F3F4F6;
            --color-border: #E5E7EB;
            --color-border-dark: #D1D5DB;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-green: 0 4px 14px 0 rgba(16, 185, 129, 0.25);
        }

        * {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: var(--color-bg-primary);
            color: var(--color-primary);
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar-nav a {
            transition: all 0.2s;
        }

        .sidebar-nav a:hover {
            background: var(--color-bg-hover);
            transform: translateX(4px);
        }

        .sidebar-nav a.active {
            background: #D1FAE5;
            color: #065F46;
            font-weight: 600;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold text-gray-900">Sistema M茅TRIK</h2>
            <p class="text-gray-600 mt-2">Cargando...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden fixed inset-0 flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">M茅TRIK</h1>
                <p class="text-gray-600">Sistema de Gesti贸n Interno</p>
            </div>

            <button
                id="login-button"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-200 flex items-center justify-center gap-3"
                style="box-shadow: var(--shadow-green);"
            >
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/>
                </svg>
                Iniciar sesi贸n con Google
            </button>

            <p class="text-sm text-gray-500 text-center mt-6">
                Usa tu cuenta de Google para acceder al sistema
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle" class="lg:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-900">M茅TRIK</h1>
                </div>

                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-gray-600 hidden sm:block"></span>
                    <button id="logout-button" class="text-sm text-gray-600 hover:text-gray-900 font-semibold">
                        Cerrar sesi贸n
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 min-h-screen sticky top-16">
                <nav class="p-4 sidebar-nav">
                    <a href="#" data-view="dashboard" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2 active">
                        <span class="text-xl"></span>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" data-view="pipeline" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Pipeline</span>
                    </a>
                    <a href="#" data-view="proyectos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Proyectos</span>
                    </a>
                    <a href="#" data-view="facturacion" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Facturaci贸n</span>
                    </a>
                    <a href="#" data-view="contactos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Contactos</span>
                    </a>
                    <a href="#" data-view="promotores" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Promotores</span>
                    </a>
                    <a href="#" data-view="gastos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Gastos</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-content">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h2>

                    <!-- KPIs Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- KPI Card 1 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Leads Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-leads">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+12% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 2 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Pipeline Value</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-pipeline">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+8% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 3 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Proyectos Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-proyectos">-</h3>
                                    <p class="text-xs text-gray-600 mt-1">En ejecuci贸n</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 4 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Facturaci贸n Mes</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-facturacion">-</h3>
                                    <p class="text-xs text-green-600 mt-1">Mes actual</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Chart 1: Pipeline por Etapa -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pipeline por Etapa</h3>
                            <canvas id="chart-pipeline"></canvas>
                        </div>

                        <!-- Chart 2: Proyectos por Estado -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Proyectos por Estado</h3>
                            <canvas id="chart-proyectos"></canvas>
                        </div>

                        <!-- Chart 3: Facturaci贸n 煤ltimos 12 meses -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Facturaci贸n ltimos 12 Meses</h3>
                            <canvas id="chart-facturacion"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pipeline View -->
                <div id="view-pipeline" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Pipeline (CRM)</h2>
                    <p class="text-gray-600">Vista en construcci贸n...</p>
                </div>

                <!-- Proyectos View -->
                <div id="view-proyectos" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Proyectos</h2>
                    <p class="text-gray-600">Vista en construcci贸n...</p>
                </div>

                <!-- Facturaci贸n View -->
                <div id="view-facturacion" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Facturaci贸n</h2>
                    <p class="text-gray-600">Vista en construcci贸n...</p>
                </div>

                <!-- Contactos View -->
                <div id="view-contactos" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Contactos</h2>
                    <p class="text-gray-600">Vista en construcci贸n...</p>
                </div>

                <!-- Promotores View -->
                <div id="view-promotores" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Promotores</h2>
                    <p class="text-gray-600">Vista en construcci贸n...</p>
                </div>

                <!-- Gastos View -->
                <div id="view-gastos" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Gastos</h2>
                    <p class="text-gray-600">Vista en construcci贸n...</p>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            CLIENT_ID: '482658322972-3nst66clokld9b2rcjarg8i5v5ngo540.apps.googleusercontent.com',
            API_KEY: '', // No needed for OAuth 2.0
            SHEET_ID: '16uKHN5v6DhGCMjuyUaC84yIw9Fx-DKjayP2NRINrAJc',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email',
            DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
        };

        // Global variables
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Initialize on load
        window.onload = function() {
            gapiLoadClient();
            gisInit();
        };

        // Load the Google API client
        function gapiLoadClient() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: CONFIG.DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        // Initialize Google Identity Services
        function gisInit() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    onAuthSuccess();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        // Login button
        document.getElementById('login-button').addEventListener('click', () => {
            tokenClient.requestAccessToken();
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    accessToken = null;
                    document.getElementById('main-app').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                });
            }
        });

        // On successful authentication
        async function onAuthSuccess() {
            // Hide login, show main app
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            // Get user info
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const userInfo = await response.json();
                document.getElementById('user-email').textContent = userInfo.email;
            } catch (error) {
                console.error('Error getting user info:', error);
            }

            // Initialize navigation
            initNavigation();

            // Load dashboard data
            loadDashboardData();
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // TODO: Read data from Google Sheets
                // For now, show placeholder data
                document.getElementById('kpi-leads').textContent = '24';
                document.getElementById('kpi-pipeline').textContent = '$45M';
                document.getElementById('kpi-proyectos').textContent = '8';
                document.getElementById('kpi-facturacion').textContent = '$12M';

                // Initialize charts
                initCharts();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Initialize charts
        function initCharts() {
            // Chart 1: Pipeline por Etapa
            const ctx1 = document.getElementById('chart-pipeline').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Contacto', 'Propuesta', 'Negociaci贸n', 'Cierre'],
                    datasets: [{
                        label: 'Cantidad de Leads',
                        data: [8, 12, 6, 4],
                        backgroundColor: '#10B981',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Chart 2: Proyectos por Estado
            const ctx2 = document.getElementById('chart-proyectos').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Activo', 'Pausado', 'Completado', 'Cancelado'],
                    datasets: [{
                        data: [8, 2, 15, 3],
                        backgroundColor: ['#10B981', '#F59E0B', '#6B7280', '#EF4444'],
                    }]
                },
                options: {
                    responsive: true,
                }
            });

            // Chart 3: Facturaci贸n 煤ltimos 12 meses
            const ctx3 = document.getElementById('chart-facturacion').getContext('2d');
            new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [{
                        label: 'Facturaci贸n (COP)',
                        data: [8, 10, 12, 15, 18, 20, 22, 25, 28, 30, 35, 40],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Initialize navigation
        function initNavigation() {
            // Navigation
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.currentTarget.dataset.view;

                    // Update active state
                    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    // Show view
                    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                    document.getElementById(`view-${view}`).classList.remove('hidden');
                });
            });

            // Mobile menu toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('hidden');
            });
        }
    </script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
