<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema M√©TRIK - Dashboard + CRM</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        :root {
            /* Colores M√©TRIK */
            --color-primary: #1A1A1A;
            --color-accent: #10B981;
            --color-secondary: #6B7280;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-danger: #EF4444;
            --color-info: #3B82F6;
            --color-bg-primary: #F9FAFB;
            --color-bg-secondary: #FFFFFF;
            --color-bg-hover: #F3F4F6;
            --color-border: #E5E7EB;
            --color-border-dark: #D1D5DB;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-green: 0 4px 14px 0 rgba(16, 185, 129, 0.25);
        }

        * {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: var(--color-bg-primary);
            color: var(--color-primary);
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar-nav a {
            transition: all 0.2s;
        }

        .sidebar-nav a:hover {
            background: var(--color-bg-hover);
            transform: translateX(4px);
        }

        .sidebar-nav a.active {
            background: #D1FAE5;
            color: #065F46;
            font-weight: 600;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold text-gray-900">Sistema M√©TRIK</h2>
            <p class="text-gray-600 mt-2">Cargando...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden fixed inset-0 flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">M√©TRIK</h1>
                <p class="text-gray-600">Sistema de Gesti√≥n Interno</p>
            </div>

            <button
                id="login-button"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-200 flex items-center justify-center gap-3"
                style="box-shadow: var(--shadow-green);"
            >
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/>
                </svg>
                Iniciar sesi√≥n con Google
            </button>

            <p class="text-sm text-gray-500 text-center mt-6">
                Usa tu cuenta de Google para acceder al sistema
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle" class="lg:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-900">M√©TRIK</h1>
                </div>

                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-gray-600 hidden sm:block"></span>
                    <button id="logout-button" class="text-sm text-gray-600 hover:text-gray-900 font-semibold">
                        Cerrar sesi√≥n
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 min-h-screen sticky top-16">
                <nav class="p-4 sidebar-nav">
                    <a href="#" data-view="dashboard" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2 active">
                        <span class="text-xl">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" data-view="pipeline" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üéØ</span>
                        <span>Pipeline</span>
                    </a>
                    <a href="#" data-view="proyectos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üìã</span>
                        <span>Proyectos</span>
                    </a>
                    <a href="#" data-view="facturacion" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üí∞</span>
                        <span>Facturaci√≥n</span>
                    </a>
                    <a href="#" data-view="contactos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üë•</span>
                        <span>Contactos</span>
                    </a>
                    <a href="#" data-view="promotores" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">ü§ù</span>
                        <span>Promotores</span>
                    </a>
                    <a href="#" data-view="gastos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üí∏</span>
                        <span>Gastos</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-content">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h2>

                    <!-- KPIs Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- KPI Card 1 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üéØ</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Leads Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-leads">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+12% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 2 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üíµ</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Pipeline Value</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-pipeline">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+8% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 3 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üìã</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Proyectos Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-proyectos">-</h3>
                                    <p class="text-xs text-gray-600 mt-1">En ejecuci√≥n</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 4 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üí∞</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Facturaci√≥n Mes</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-facturacion">-</h3>
                                    <p class="text-xs text-green-600 mt-1">Mes actual</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Chart 1: Pipeline por Etapa -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pipeline por Etapa</h3>
                            <canvas id="chart-pipeline"></canvas>
                        </div>

                        <!-- Chart 2: Proyectos por Estado -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Proyectos por Estado</h3>
                            <canvas id="chart-proyectos"></canvas>
                        </div>

                        <!-- Chart 3: Facturaci√≥n √∫ltimos 12 meses -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Facturaci√≥n √öltimos 12 Meses</h3>
                            <canvas id="chart-facturacion"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pipeline View -->
                <div id="view-pipeline" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Pipeline (CRM)</h2>
                        <button id="btn-refresh-pipeline" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Lead</h3>

                        <form id="form-pipeline" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Lead Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Lead *</label>
                                <input type="text" id="input-lead" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Juan P√©rez">
                            </div>

                            <!-- Empresa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
                                <input type="text" id="input-empresa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Tech Solutions">
                            </div>

                            <!-- Email -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" id="input-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="juan@tech.co">
                            </div>

                            <!-- Tel√©fono -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                                <input type="tel" id="input-telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="+57 300 123 4567">
                            </div>

                            <!-- Etapa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Etapa *</label>
                                <select id="input-etapa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Contacto">Contacto</option>
                                    <option value="Propuesta">Propuesta</option>
                                    <option value="Negociaci√≥n">Negociaci√≥n</option>
                                    <option value="Cierre">Cierre</option>
                                </select>
                            </div>

                            <!-- Valor -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (COP) *</label>
                                <input type="number" id="input-valor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- Probabilidad -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Probabilidad (%) *</label>
                                <input type="number" id="input-probabilidad" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="50" min="0" max="100">
                            </div>

                            <!-- Fecha Contacto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Contacto *</label>
                                <input type="date" id="input-fecha-contacto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Estimada Cierre -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Est. Cierre</label>
                                <input type="date" id="input-fecha-cierre" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Ganado">Ganado</option>
                                    <option value="Perdido">Perdido</option>
                                    <option value="Pausado">Pausado</option>
                                </select>
                            </div>

                            <!-- Fuente -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fuente</label>
                                <select id="input-fuente" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Web">Web</option>
                                    <option value="Referido">Referido</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Evento">Evento</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones adicionales..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Lead
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Leads Registrados</h3>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lead</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Etapa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prob.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-pipeline-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Proyectos View -->
                <div id="view-proyectos" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Proyectos</h2>
                        <button id="btn-refresh-proyectos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Proyecto</h3>

                        <form id="form-proyectos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Nombre Proyecto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto *</label>
                                <input type="text" id="input-proyecto-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Dashboard de Ventas">
                            </div>

                            <!-- Cliente -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente *</label>
                                <input type="text" id="input-proyecto-cliente" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Tech Solutions">
                            </div>

                            <!-- Email Cliente -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Cliente</label>
                                <input type="email" id="input-proyecto-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="cliente@empresa.co">
                            </div>

                            <!-- Tipo Proyecto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Proyecto *</label>
                                <select id="input-proyecto-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Dashboard">Dashboard</option>
                                    <option value="CRM">CRM</option>
                                    <option value="Landing">Landing</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-proyecto-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Pausado">Pausado</option>
                                    <option value="Completado">Completado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>

                            <!-- Fase -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fase *</label>
                                <select id="input-proyecto-fase" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Discovery">Discovery</option>
                                    <option value="Design">Design</option>
                                    <option value="Desarrollo">Desarrollo</option>
                                    <option value="QA">QA</option>
                                    <option value="Deploy">Deploy</option>
                                    <option value="Cerrado">Cerrado</option>
                                </select>
                            </div>

                            <!-- Fecha Inicio -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio *</label>
                                <input type="date" id="input-proyecto-fecha-inicio" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Entrega Estimada -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Est. *</label>
                                <input type="date" id="input-proyecto-fecha-entrega-est" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Entrega Real -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Real</label>
                                <input type="date" id="input-proyecto-fecha-entrega-real" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Valor -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (COP) *</label>
                                <input type="number" id="input-proyecto-valor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- Progreso -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Progreso (%) *</label>
                                <input type="number" id="input-proyecto-progreso" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="50" min="0" max="100" value="0">
                            </div>

                            <!-- Promotor -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Promotor</label>
                                <input type="text" id="input-proyecto-promotor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Nombre del promotor">
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-proyecto-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones del proyecto..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Proyecto
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Proyectos Registrados</h3>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fase</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progreso</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-proyectos-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Facturaci√≥n View -->
                <div id="view-facturacion" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Facturaci√≥n</h2>
                    <p class="text-gray-600">Vista en construcci√≥n...</p>
                </div>

                <!-- Contactos View -->
                <div id="view-contactos" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Contactos</h2>
                    <p class="text-gray-600">Vista en construcci√≥n...</p>
                </div>

                <!-- Promotores View -->
                <div id="view-promotores" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Promotores</h2>
                    <p class="text-gray-600">Vista en construcci√≥n...</p>
                </div>

                <!-- Gastos View -->
                <div id="view-gastos" class="view-content hidden">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Gastos</h2>
                    <p class="text-gray-600">Vista en construcci√≥n...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            CLIENT_ID: '482658322972-3nst66clokld9b2rcjarg8i5v5ngo540.apps.googleusercontent.com',
            API_KEY: '', // No needed for OAuth 2.0
            SHEET_ID: '16uKHN5v6DhGCMjuyUaC84yIw9Fx-DKjayP2NRINrAJc',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email',
            DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            CACHE_DURATION: 5 * 60 * 1000, // 5 minutes
            SHEETS: {
                PIPELINE: 'Pipeline',
                PROYECTOS: 'Proyectos',
                FACTURACION: 'Facturaci√≥n',
                CONTACTOS: 'Contactos',
                PROMOTORES: 'Promotores',
                GASTOS: 'Gastos'
            }
        };

        // Global variables
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Chart instances
        let chartPipeline = null;
        let chartProyectos = null;
        let chartFacturacion = null;

        // ====================
        // DATA LAYER: Google Sheets API
        // ====================

        /**
         * Google Sheets API wrapper with caching
         */
        class GoogleSheetsAPI {
            constructor() {
                this.cache = new Map();
            }

            /**
             * Read data from a sheet
             * @param {string} sheetName - Name of the sheet (e.g., 'Pipeline')
             * @param {string} range - Range to read (e.g., 'A2:Z' to read all data rows)
             * @returns {Promise<Array>} Array of rows
             */
            async readSheet(sheetName, range = 'A2:Z') {
                const cacheKey = `${sheetName}!${range}`;

                // Check cache
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < CONFIG.CACHE_DURATION) {
                        console.log(`üì¶ Cache hit: ${cacheKey}`);
                        return cached.data;
                    }
                }

                try {
                    console.log(`üîÑ Fetching: ${sheetName}!${range}`);

                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`,
                    });

                    const data = response.result.values || [];

                    // Cache the result
                    this.cache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });

                    console.log(`‚úÖ Fetched ${data.length} rows from ${sheetName}`);
                    return data;
                } catch (error) {
                    console.error(`‚ùå Error reading ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Write data to a sheet (append rows)
             * @param {string} sheetName - Name of the sheet
             * @param {Array<Array>} values - 2D array of values to write
             * @returns {Promise<Object>} Response object
             */
            async writeSheet(sheetName, values) {
                try {
                    console.log(`‚úçÔ∏è Writing ${values.length} rows to ${sheetName}`);

                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!A2`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: {
                            values: values
                        }
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(`‚úÖ Written to ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(`‚ùå Error writing to ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Update existing data in a sheet
             * @param {string} sheetName - Name of the sheet
             * @param {string} range - Range to update (e.g., 'A2:E2')
             * @param {Array<Array>} values - 2D array of values to update
             * @returns {Promise<Object>} Response object
             */
            async updateSheet(sheetName, range, values) {
                try {
                    console.log(`üîÑ Updating ${sheetName}!${range}`);

                    const response = await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`,
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: values
                        }
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(`‚úÖ Updated ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(`‚ùå Error updating ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Delete rows from a sheet (by clearing content)
             * @param {string} sheetName - Name of the sheet
             * @param {string} range - Range to clear (e.g., 'A2:Z2')
             * @returns {Promise<Object>} Response object
             */
            async deleteSheet(sheetName, range) {
                try {
                    console.log(`üóëÔ∏è Deleting ${sheetName}!${range}`);

                    const response = await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(`‚úÖ Deleted from ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(`‚ùå Error deleting from ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Invalidate cache for a specific sheet
             * @param {string} sheetName - Name of the sheet
             */
            invalidateCache(sheetName) {
                const keysToDelete = [];
                for (const key of this.cache.keys()) {
                    if (key.startsWith(sheetName)) {
                        keysToDelete.push(key);
                    }
                }
                keysToDelete.forEach(key => this.cache.delete(key));
                console.log(`üóëÔ∏è Cache invalidated for ${sheetName}`);
            }

            /**
             * Clear all cache
             */
            clearCache() {
                this.cache.clear();
                console.log('üóëÔ∏è All cache cleared');
            }
        }

        // Create global instance
        const sheetsAPI = new GoogleSheetsAPI();

        // Initialize on load
        window.onload = function() {
            gapiLoadClient();
            gisInit();
        };

        // Load the Google API client
        function gapiLoadClient() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: CONFIG.DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        // Initialize Google Identity Services
        function gisInit() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    onAuthSuccess();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        // Login button
        document.getElementById('login-button').addEventListener('click', () => {
            tokenClient.requestAccessToken();
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    accessToken = null;
                    document.getElementById('main-app').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                });
            }
        });

        // On successful authentication
        async function onAuthSuccess() {
            // Hide login, show main app
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            // Get user info
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const userInfo = await response.json();
                document.getElementById('user-email').textContent = userInfo.email;
            } catch (error) {
                console.error('Error getting user info:', error);
            }

            // Initialize navigation
            initNavigation();

            // Load dashboard data
            loadDashboardData();
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                console.log('üìä Loading dashboard data...');

                // Read data from all sheets in parallel
                const [pipelineData, proyectosData, facturacionData] = await Promise.all([
                    sheetsAPI.readSheet(CONFIG.SHEETS.PIPELINE),
                    sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS),
                    sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION)
                ]);

                // ====================
                // KPI 1: Leads Activos
                // ====================
                // Count leads with estado != "Perdido" and != "Ganado"
                const leadsActivos = pipelineData.filter(row => {
                    const estado = row[10]; // Column K: Estado
                    return estado && estado !== 'Perdido' && estado !== 'Ganado';
                }).length;

                document.getElementById('kpi-leads').textContent = leadsActivos;

                // ====================
                // KPI 2: Pipeline Value
                // ====================
                // Sum of "Pipeline Value" for active leads
                // Formula: Valor √ó (Probabilidad / 100)
                const pipelineValue = pipelineData
                    .filter(row => {
                        const estado = row[10]; // Column K: Estado
                        return estado && estado !== 'Perdido' && estado !== 'Ganado';
                    })
                    .reduce((sum, row) => {
                        const valor = parseFloat(row[6]) || 0; // Column G: Valor
                        const probabilidad = parseFloat(row[7]) || 0; // Column H: Probabilidad
                        const pipelineVal = valor * (probabilidad / 100);
                        return sum + pipelineVal;
                    }, 0);

                document.getElementById('kpi-pipeline').textContent = formatCurrency(pipelineValue);

                // ====================
                // KPI 3: Proyectos Activos
                // ====================
                // Count proyectos with estado = "Activo"
                const proyectosActivos = proyectosData.filter(row => {
                    const estado = row[4]; // Column E: Estado
                    return estado === 'Activo';
                }).length;

                document.getElementById('kpi-proyectos').textContent = proyectosActivos;

                // ====================
                // KPI 4: Facturaci√≥n Mes Actual
                // ====================
                // Sum of "Monto" for current month
                const currentMonth = new Date().getMonth() + 1; // 1-12
                const currentYear = new Date().getFullYear();

                const facturacionMes = facturacionData
                    .filter(row => {
                        const fechaEmision = row[1]; // Column B: Fecha emisi√≥n
                        if (!fechaEmision) return false;

                        // Parse date (assuming format: DD/MM/YYYY or YYYY-MM-DD)
                        const date = parseDate(fechaEmision);
                        if (!date) return false;

                        return date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
                    })
                    .reduce((sum, row) => {
                        const monto = parseFloat(row[4]) || 0; // Column E: Monto
                        return sum + monto;
                    }, 0);

                document.getElementById('kpi-facturacion').textContent = formatCurrency(facturacionMes);

                // Initialize charts with real data
                initCharts(pipelineData, proyectosData, facturacionData);

                console.log('‚úÖ Dashboard data loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);

                // Show error state
                document.getElementById('kpi-leads').textContent = 'Error';
                document.getElementById('kpi-pipeline').textContent = 'Error';
                document.getElementById('kpi-proyectos').textContent = 'Error';
                document.getElementById('kpi-facturacion').textContent = 'Error';

                alert('Error al cargar datos del dashboard. Por favor, recarga la p√°gina.');
            }
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================

        /**
         * Format number as currency (COP)
         */
        function formatCurrency(value) {
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(1)}K`;
            } else {
                return `$${value.toFixed(0)}`;
            }
        }

        /**
         * Parse date from string (supports DD/MM/YYYY and YYYY-MM-DD)
         */
        function parseDate(dateString) {
            if (!dateString) return null;

            // Try DD/MM/YYYY format
            let parts = dateString.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // 0-indexed
                const year = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            // Try YYYY-MM-DD format
            parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // 0-indexed
                const day = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            return null;
        }

        // Initialize charts with real data
        function initCharts(pipelineData = [], proyectosData = [], facturacionData = []) {
            // Destroy existing charts if they exist
            if (chartPipeline) {
                chartPipeline.destroy();
                chartPipeline = null;
            }
            if (chartProyectos) {
                chartProyectos.destroy();
                chartProyectos = null;
            }
            if (chartFacturacion) {
                chartFacturacion.destroy();
                chartFacturacion = null;
            }

            // ====================
            // Chart 1: Pipeline por Etapa
            // ====================
            const etapas = ['Contacto', 'Propuesta', 'Negociaci√≥n', 'Cierre'];
            const pipelineByEtapa = etapas.map(etapa => {
                return pipelineData.filter(row => {
                    const etapaRow = row[5]; // Column F: Etapa
                    const estado = row[10]; // Column K: Estado
                    return etapaRow === etapa && estado !== 'Perdido' && estado !== 'Ganado';
                }).length;
            });

            const ctx1 = document.getElementById('chart-pipeline').getContext('2d');
            chartPipeline = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Contacto', 'Propuesta', 'Negociaci√≥n', 'Cierre'],
                    datasets: [{
                        label: 'Cantidad de Leads',
                        data: pipelineByEtapa,
                        backgroundColor: '#10B981',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // ====================
            // Chart 2: Proyectos por Estado
            // ====================
            const estados = ['Activo', 'Pausado', 'Completado', 'Cancelado'];
            const proyectosByEstado = estados.map(estado => {
                return proyectosData.filter(row => {
                    const estadoRow = row[4]; // Column E: Estado
                    return estadoRow === estado;
                }).length;
            });

            const ctx2 = document.getElementById('chart-proyectos').getContext('2d');
            chartProyectos = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: estados,
                    datasets: [{
                        data: proyectosByEstado,
                        backgroundColor: ['#10B981', '#F59E0B', '#6B7280', '#EF4444'],
                    }]
                },
                options: {
                    responsive: true,
                }
            });

            // ====================
            // Chart 3: Facturaci√≥n √∫ltimos 12 meses
            // ====================
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();

            // Calculate last 12 months data
            const last12Months = [];
            for (let i = 11; i >= 0; i--) {
                const date = new Date(currentYear, currentDate.getMonth() - i, 1);
                const month = date.getMonth() + 1; // 1-12
                const year = date.getFullYear();

                const monthTotal = facturacionData
                    .filter(row => {
                        const fechaEmision = row[1]; // Column B: Fecha emisi√≥n
                        if (!fechaEmision) return false;

                        const parsedDate = parseDate(fechaEmision);
                        if (!parsedDate) return false;

                        return parsedDate.getMonth() + 1 === month && parsedDate.getFullYear() === year;
                    })
                    .reduce((sum, row) => {
                        const monto = parseFloat(row[4]) || 0; // Column E: Monto
                        return sum + monto;
                    }, 0);

                last12Months.push({
                    label: monthNames[date.getMonth()],
                    value: monthTotal / 1000000 // Convert to millions
                });
            }

            const ctx3 = document.getElementById('chart-facturacion').getContext('2d');
            chartFacturacion = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: last12Months.map(m => m.label),
                    datasets: [{
                        label: 'Facturaci√≥n (Millones COP)',
                        data: last12Months.map(m => m.value),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(1)}M COP`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return `$${value}M`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ====================
        // TOAST NOTIFICATION SYSTEM
        // ====================

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;

            // Set color based on type
            if (type === 'success') {
                toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            } else if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            } else {
                toast.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            }

            // Hide after 3 seconds
            setTimeout(() => {
                toast.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50';
            }, 3000);
        }

        // ====================
        // PIPELINE VIEW FUNCTIONS
        // ====================

        /**
         * Load and render Pipeline data
         */
        async function loadPipelineView() {
            try {
                console.log('üìä Loading Pipeline view...');

                const pipelineData = await sheetsAPI.readSheet(CONFIG.SHEETS.PIPELINE);
                renderPipelineTable(pipelineData);

                console.log('‚úÖ Pipeline view loaded');
            } catch (error) {
                console.error('‚ùå Error loading Pipeline:', error);
                showToast('Error al cargar Pipeline', 'error');
            }
        }

        /**
         * Render Pipeline table
         */
        function renderPipelineTable(data) {
            const tbody = document.getElementById('table-pipeline-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No hay leads registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, lead, empresa, email, telefono, etapa, valor, probabilidad, fechaContacto, fechaCierre, estado, fuente, notas] = row;

                // Generate badge colors
                const etapaBadge = getBadge(etapa, 'blue');
                const estadoBadge = getBadge(estado, getEstadoColor(estado));

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${lead || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${empresa || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${email || '-'}</td>
                        <td class="px-4 py-3 text-sm">${etapaBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(valor) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${probabilidad}%</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm text-right">
                            <button onclick="deletePipelineLead(${index + 2})" class="text-red-600 hover:text-red-800 font-medium">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get badge HTML
         */
        function getBadge(text, color) {
            const colors = {
                'blue': 'bg-blue-100 text-blue-800',
                'green': 'bg-green-100 text-green-800',
                'yellow': 'bg-yellow-100 text-yellow-800',
                'red': 'bg-red-100 text-red-800',
                'gray': 'bg-gray-100 text-gray-800'
            };

            const colorClass = colors[color] || colors.gray;

            return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${colorClass}">${text}</span>`;
        }

        /**
         * Get estado color
         */
        function getEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'blue';
                case 'Ganado': return 'green';
                case 'Perdido': return 'red';
                case 'Pausado': return 'yellow';
                default: return 'gray';
            }
        }

        /**
         * Generate Pipeline ID
         */
        function generatePipelineId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PIP-${year}-${random}`;
        }

        /**
         * Handle Pipeline form submission
         */
        async function handlePipelineSubmit(event) {
            event.preventDefault();

            try {
                // Get form values
                const id = generatePipelineId();
                const lead = document.getElementById('input-lead').value;
                const empresa = document.getElementById('input-empresa').value;
                const email = document.getElementById('input-email').value;
                const telefono = document.getElementById('input-telefono').value;
                const etapa = document.getElementById('input-etapa').value;
                const valor = document.getElementById('input-valor').value;
                const probabilidad = document.getElementById('input-probabilidad').value;
                const fechaContacto = document.getElementById('input-fecha-contacto').value;
                const fechaCierre = document.getElementById('input-fecha-cierre').value;
                const estado = document.getElementById('input-estado').value;
                const fuente = document.getElementById('input-fuente').value;
                const notas = document.getElementById('input-notas').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data
                const rowData = [[
                    id,
                    lead,
                    empresa,
                    email,
                    telefono,
                    etapa,
                    valor,
                    probabilidad,
                    fechaContacto,
                    fechaCierre,
                    estado,
                    fuente,
                    notas,
                    fechaActualizacion
                ]];

                // Write to Google Sheets
                await sheetsAPI.writeSheet(CONFIG.SHEETS.PIPELINE, rowData);

                // Show success message
                showToast('Lead guardado exitosamente', 'success');

                // Reset form
                document.getElementById('form-pipeline').reset();

                // Reload table
                await loadPipelineView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error saving lead:', error);
                showToast('Error al guardar lead', 'error');
            }
        }

        /**
         * Delete Pipeline lead
         */
        async function deletePipelineLead(rowNumber) {
            if (!confirm('¬øEst√°s seguro de eliminar este lead?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.PIPELINE, `A${rowNumber}:N${rowNumber}`);

                showToast('Lead eliminado exitosamente', 'success');

                // Reload table
                await loadPipelineView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error deleting lead:', error);
                showToast('Error al eliminar lead', 'error');
            }
        }

        // ====================
        // PROYECTOS VIEW FUNCTIONS
        // ====================

        /**
         * Load and render Proyectos data
         */
        async function loadProyectosView() {
            try {
                console.log('üìä Loading Proyectos view...');

                const proyectosData = await sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS);
                renderProyectosTable(proyectosData);

                console.log('‚úÖ Proyectos view loaded');
            } catch (error) {
                console.error('‚ùå Error loading Proyectos:', error);
                showToast('Error al cargar Proyectos', 'error');
            }
        }

        /**
         * Render Proyectos table
         */
        function renderProyectosTable(data) {
            const tbody = document.getElementById('table-proyectos-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No hay proyectos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, cliente, emailCliente, tipoProyecto, estado, fase, fechaInicio, fechaEntregaEst, fechaEntregaReal, valor, progreso, promotor, notas] = row;

                // Generate badge colors
                const estadoBadge = getBadge(estado, getProyectoEstadoColor(estado));
                const faseBadge = getBadge(fase, 'blue');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${nombre || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${cliente || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${tipoProyecto || '-'}</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm">${faseBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(valor) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${progreso}%</td>
                        <td class="px-4 py-3 text-sm text-right">
                            <button onclick="deleteProyecto(${index + 2})" class="text-red-600 hover:text-red-800 font-medium">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get proyecto estado color
         */
        function getProyectoEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'green';
                case 'Pausado': return 'yellow';
                case 'Completado': return 'blue';
                case 'Cancelado': return 'red';
                default: return 'gray';
            }
        }

        /**
         * Generate Proyecto ID
         */
        function generateProyectoId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PRJ-${year}-${random}`;
        }

        /**
         * Handle Proyectos form submission
         */
        async function handleProyectosSubmit(event) {
            event.preventDefault();

            try {
                // Get form values
                const id = generateProyectoId();
                const nombre = document.getElementById('input-proyecto-nombre').value;
                const cliente = document.getElementById('input-proyecto-cliente').value;
                const emailCliente = document.getElementById('input-proyecto-email').value;
                const tipoProyecto = document.getElementById('input-proyecto-tipo').value;
                const estado = document.getElementById('input-proyecto-estado').value;
                const fase = document.getElementById('input-proyecto-fase').value;
                const fechaInicio = document.getElementById('input-proyecto-fecha-inicio').value;
                const fechaEntregaEst = document.getElementById('input-proyecto-fecha-entrega-est').value;
                const fechaEntregaReal = document.getElementById('input-proyecto-fecha-entrega-real').value;
                const valor = document.getElementById('input-proyecto-valor').value;
                const progreso = document.getElementById('input-proyecto-progreso').value;
                const promotor = document.getElementById('input-proyecto-promotor').value;
                const notas = document.getElementById('input-proyecto-notas').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data
                const rowData = [[
                    id,
                    nombre,
                    cliente,
                    emailCliente,
                    tipoProyecto,
                    estado,
                    fase,
                    fechaInicio,
                    fechaEntregaEst,
                    fechaEntregaReal,
                    valor,
                    progreso,
                    promotor,
                    notas,
                    fechaActualizacion
                ]];

                // Write to Google Sheets
                await sheetsAPI.writeSheet(CONFIG.SHEETS.PROYECTOS, rowData);

                // Show success message
                showToast('Proyecto guardado exitosamente', 'success');

                // Reset form
                document.getElementById('form-proyectos').reset();

                // Reload table
                await loadProyectosView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error saving proyecto:', error);
                showToast('Error al guardar proyecto', 'error');
            }
        }

        /**
         * Delete Proyecto
         */
        async function deleteProyecto(rowNumber) {
            if (!confirm('¬øEst√°s seguro de eliminar este proyecto?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.PROYECTOS, `A${rowNumber}:O${rowNumber}`);

                showToast('Proyecto eliminado exitosamente', 'success');

                // Reload table
                await loadProyectosView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error deleting proyecto:', error);
                showToast('Error al eliminar proyecto', 'error');
            }
        }

        // Initialize navigation
        function initNavigation() {
            // Navigation
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.currentTarget.dataset.view;

                    // Update active state
                    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    // Show view
                    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                    document.getElementById(`view-${view}`).classList.remove('hidden');
                });
            });

            // Mobile menu toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('hidden');
            });

            // Pipeline view event listeners
            document.getElementById('form-pipeline').addEventListener('submit', handlePipelineSubmit);
            document.getElementById('btn-refresh-pipeline').addEventListener('click', loadPipelineView);

            // Load Pipeline view when navigating to it
            document.querySelector('[data-view="pipeline"]').addEventListener('click', () => {
                setTimeout(() => loadPipelineView(), 100);
            });

            // Proyectos view event listeners
            document.getElementById('form-proyectos').addEventListener('submit', handleProyectosSubmit);
            document.getElementById('btn-refresh-proyectos').addEventListener('click', loadProyectosView);

            // Load Proyectos view when navigating to it
            document.querySelector('[data-view="proyectos"]').addEventListener('click', () => {
                setTimeout(() => loadProyectosView(), 100);
            });
        }
    </script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
