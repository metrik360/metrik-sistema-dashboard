<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema M√©TRIK - Dashboard + CRM</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/7dS6NXjR/Metrik-Isotipo.png">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Configuration -->
    <script>
        // Configuration for Sistema M√©TRIK
        const CONFIG = {
            // OAuth 2.0 Configuration
            CLIENT_ID: '482658322972-3nst66clokld9b2rcjarg8i5v5ngo540.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email',
            DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],

            // Google Sheets Configuration
            SHEET_ID: '16uKHN5v6DhGCMjuyUaC84yIw9Fx-DKjayP2NRINrAJc',

            // Sheet Names (tabs in Google Sheets)
            SHEETS: {
                PIPELINE: 'Pipeline',
                PROYECTOS: 'Proyectos',
                FACTURACION: 'Facturaci√≥n',
                CONTACTOS: 'Contactos',
                PROMOTORES: 'Promotores',
                SERVICIOS: 'Servicios',
                GASTOS: 'Gastos',
                USUARIOS: 'Usuarios'
            },

            // Cache Configuration (in milliseconds)
            CACHE_DURATION: 5 * 60 * 1000, // 5 minutes

            // Authentication & Authorization
            SUPER_ADMIN_EMAILS: [
                'bmmorenog@gmail.com',           // Email actual
                'mauricio.moreno@metrik.com.co'  // Email Google Workspace (futuro)
            ],

            // Roles
            ROLES: {
                SUPER_ADMIN: 'Super Admin',
                ADMIN_LOCAL: 'Admin Local',
                SUPERVISOR: 'Supervisor',
                USUARIO: 'Usuario'
            },

            // Session Configuration
            SESSION_DURATION: 8 * 60 * 60 * 1000, // 8 hours

            // App Configuration
            APP_NAME: 'Sistema M√©TRIK',
            VERSION: '1.0.0',
            LAST_UPDATED: '2025-01-06'
        };
    </script>

    <style>
        :root {
            /* Colores M√©TRIK */
            --color-primary: #1A1A1A;
            --color-accent: #10B981;
            --color-secondary: #6B7280;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-danger: #EF4444;
            --color-info: #3B82F6;
            --color-bg-primary: #F9FAFB;
            --color-bg-secondary: #FFFFFF;
            --color-bg-hover: #F3F4F6;
            --color-border: #E5E7EB;
            --color-border-dark: #D1D5DB;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-green: 0 4px 14px 0 rgba(16, 185, 129, 0.25);
        }

        * {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: var(--color-bg-primary);
            color: var(--color-primary);
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar-nav a {
            transition: all 0.2s;
        }

        .sidebar-nav a:hover {
            background: var(--color-bg-hover);
            transform: translateX(4px);
        }

        .sidebar-nav a.active {
            background: #D1FAE5;
            color: #065F46;
            font-weight: 600;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <img src="https://i.ibb.co/sdb3Bpq5/M-trik-logo-iso.png" alt="M√©TRIK Logo" class="h-32 mx-auto mb-4 animate-pulse" style="width: auto;">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600 mt-2">Cargando...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden fixed inset-0 flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <img src="https://i.ibb.co/sdb3Bpq5/M-trik-logo-iso.png" alt="M√©TRIK Logo" class="h-24 mx-auto mb-6" style="width: auto;">
                <p class="text-gray-600 text-lg">Sistema de Gesti√≥n Interno</p>
            </div>

            <!-- Email + PIN Login -->
            <form id="login-form-pin" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input
                        type="email"
                        id="login-email"
                        required
                        placeholder="usuario@empresa.com"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">PIN (4 d√≠gitos)</label>
                    <input
                        type="password"
                        id="login-pin"
                        required
                        maxlength="4"
                        pattern="[0-9]{4}"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-center text-2xl tracking-widest"
                    />
                </div>
                <button
                    type="submit"
                    id="login-submit-button"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-200"
                    style="box-shadow: var(--shadow-green);"
                >
                    Iniciar Sesi√≥n
                </button>
            </form>

            <p class="text-xs text-gray-500 text-center mt-6">
                Ingresa con tu email y PIN asignado
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle" class="text-gray-600 hover:text-gray-900">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <img src="https://i.ibb.co/sdb3Bpq5/M-trik-logo-iso.png" alt="M√©TRIK" class="h-10" style="width: auto;">
                </div>

                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-gray-600 hidden sm:block"></span>
                    <button id="logout-button" class="text-sm text-gray-600 hover:text-gray-900 font-semibold">
                        Cerrar sesi√≥n
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 h-[calc(100vh-73px)] sticky top-[73px] overflow-y-auto transition-all duration-300">
                <nav class="p-4 sidebar-nav">
                    <a href="#" data-view="dashboard" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2 active">
                        <span class="text-xl">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" data-view="pipeline" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üéØ</span>
                        <span>Pipeline</span>
                    </a>
                    <a href="#" data-view="proyectos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üìã</span>
                        <span>Proyectos</span>
                    </a>
                    <a href="#" data-view="facturacion" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üí∞</span>
                        <span>Facturaci√≥n</span>
                    </a>
                    <a href="#" data-view="contactos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üë•</span>
                        <span>Contactos</span>
                    </a>
                    <a href="#" data-view="promotores" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">ü§ù</span>
                        <span>Promotores</span>
                    </a>
                    <a href="#" data-view="servicios" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üì¶</span>
                        <span>Servicios</span>
                    </a>
                    <a href="#" data-view="gastos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl">üí∏</span>
                        <span>Gastos</span>
                    </a>
                    <a href="#" data-view="usuarios" id="nav-usuarios" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2 hidden">
                        <span class="text-xl">üë•</span>
                        <span>Usuarios</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-content">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h2>

                    <!-- KPIs Grid - Main -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- KPI Card 1 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üéØ</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Leads Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-leads">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+12% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 2 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üíµ</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Pipeline Value</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-pipeline">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+8% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 3 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üìã</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Proyectos Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-proyectos">-</h3>
                                    <p class="text-xs text-gray-600 mt-1">En ejecuci√≥n</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 4 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üí∞</div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Facturaci√≥n Mes</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-facturacion">-</h3>
                                    <p class="text-xs text-green-600 mt-1">Mes actual</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Grid - Flujo de Caja -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">üí∞ Flujo de Caja</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Facturado Este Mes -->
                            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-sm border border-green-200 p-6">
                                <div class="flex items-center gap-4">
                                    <div class="text-4xl">üíµ</div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600">Facturado Este Mes</p>
                                        <h3 class="text-2xl font-bold text-gray-900" id="kpi-facturado-mes">-</h3>
                                        <p class="text-xs text-green-600 mt-1">Facturas pagadas</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Por Cobrar -->
                            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl shadow-sm border border-yellow-200 p-6">
                                <div class="flex items-center gap-4">
                                    <div class="text-4xl">üìä</div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600">Por Cobrar</p>
                                        <h3 class="text-2xl font-bold text-gray-900" id="kpi-por-cobrar">-</h3>
                                        <p class="text-xs text-yellow-600 mt-1">Facturas pendientes</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Proyectado 30 D√≠as -->
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl shadow-sm border border-blue-200 p-6">
                                <div class="flex items-center gap-4">
                                    <div class="text-4xl">üîÆ</div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600">Proyectado 30 D√≠as</p>
                                        <h3 class="text-2xl font-bold text-gray-900" id="kpi-proyectado-30">-</h3>
                                        <p class="text-xs text-blue-600 mt-1">Vencimientos pr√≥ximos</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Anticipos sin Saldo -->
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-sm border border-purple-200 p-6">
                                <div class="flex items-center gap-4">
                                    <div class="text-4xl">‚ö†Ô∏è</div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600">Anticipos sin Saldo</p>
                                        <h3 class="text-2xl font-bold text-gray-900" id="kpi-anticipos-sin-saldo">-</h3>
                                        <p class="text-xs text-purple-600 mt-1">Proyectos incompletos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Chart 1: Pipeline por Etapa -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pipeline por Etapa</h3>
                            <canvas id="chart-pipeline"></canvas>
                        </div>

                        <!-- Chart 2: Proyectos por Estado -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Proyectos por Estado</h3>
                            <canvas id="chart-proyectos"></canvas>
                        </div>

                        <!-- Chart 3: Facturaci√≥n √∫ltimos 12 meses -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Facturaci√≥n √öltimos 12 Meses</h3>
                            <canvas id="chart-facturacion"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pipeline View -->
                <div id="view-pipeline" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Pipeline (CRM)</h2>
                        <button id="btn-refresh-pipeline" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Lead</h3>

                        <form id="form-pipeline" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Contacto (Dropdown) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contacto *</label>
                                <select id="input-contacto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar contacto...</option>
                                    <!-- Populated from Contactos sheet -->
                                </select>
                            </div>

                            <!-- Nombre (Auto-populated, read-only) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                <input type="text" id="input-lead" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Empresa (Auto-populated, read-only) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
                                <input type="text" id="input-empresa" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Email (Auto-populated, read-only) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="input-email" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Tel√©fono (Auto-populated, read-only) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                                <input type="tel" id="input-telefono" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Etapa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Etapa *</label>
                                <select id="input-etapa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Contacto">Contacto</option>
                                    <option value="Propuesta">Propuesta</option>
                                    <option value="Negociaci√≥n">Negociaci√≥n</option>
                                    <option value="Cierre">Cierre</option>
                                </select>
                            </div>

                            <!-- Servicio (Dropdown from Servicios) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Servicio</label>
                                <select id="input-servicio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar servicio...</option>
                                    <!-- Populated from Servicios sheet -->
                                </select>
                            </div>

                            <!-- Valor -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (COP) *</label>
                                <input type="number" id="input-valor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- Probabilidad -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Probabilidad (%) *</label>
                                <input type="number" id="input-probabilidad" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="50" min="0" max="100">
                            </div>

                            <!-- Fecha Contacto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Contacto *</label>
                                <input type="date" id="input-fecha-contacto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Estimada Cierre -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Est. Cierre</label>
                                <input type="date" id="input-fecha-cierre" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Ganado">Ganado</option>
                                    <option value="Perdido">Perdido</option>
                                    <option value="Pausado">Pausado</option>
                                </select>
                            </div>

                            <!-- Fuente -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fuente</label>
                                <select id="input-fuente" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Web">Web</option>
                                    <option value="Referido">Referido</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Evento">Evento</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <!-- Promotor (Conditional - shown when Fuente = Referido) -->
                            <div id="promotor-field" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Promotor *</label>
                                <select id="input-promotor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar promotor...</option>
                                    <!-- Populated from Promotores sheet -->
                                </select>
                            </div>

                            <!-- Google Drive Folder -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">üìÅ Carpeta Google Drive</label>
                                <input type="url" id="input-drive-pipeline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="https://drive.google.com/drive/folders/...">
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones adicionales..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Lead
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Leads Registrados</h3>
                            <input type="text" id="search-pipeline" placeholder="üîç Buscar por nombre, empresa o email..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lead</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Servicio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Etapa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prob.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-pipeline-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Proyectos View -->
                <div id="view-proyectos" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Proyectos</h2>
                        <button id="btn-refresh-proyectos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Proyecto</h3>

                        <form id="form-proyectos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Pipeline Lead (Dropdown de Pipeline con Estado=Ganado) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Lead del Pipeline *</label>
                                <select id="input-proyecto-pipeline" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar lead ganado...</option>
                                    <!-- Populated from Pipeline sheet (Estado=Ganado) -->
                                </select>
                            </div>

                            <!-- Nombre Proyecto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto *</label>
                                <input type="text" id="input-proyecto-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Dashboard de Ventas">
                            </div>

                            <!-- Cliente (Auto-populated) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                                <input type="text" id="input-proyecto-cliente" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Empresa (Auto-populated) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
                                <input type="text" id="input-proyecto-empresa" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Email Cliente (Auto-populated) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Cliente</label>
                                <input type="email" id="input-proyecto-email" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Tel√©fono Cliente (Auto-populated) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono Cliente</label>
                                <input type="tel" id="input-proyecto-telefono" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado">
                            </div>

                            <!-- Tipo Proyecto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Proyecto *</label>
                                <select id="input-proyecto-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Dashboard">Dashboard</option>
                                    <option value="CRM">CRM</option>
                                    <option value="Landing">Landing</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-proyecto-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Pausado">Pausado</option>
                                    <option value="Completado">Completado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>

                            <!-- Fase -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fase *</label>
                                <select id="input-proyecto-fase" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Discovery">Discovery</option>
                                    <option value="Design">Design</option>
                                    <option value="Desarrollo">Desarrollo</option>
                                    <option value="QA">QA</option>
                                    <option value="Deploy">Deploy</option>
                                    <option value="Cerrado">Cerrado</option>
                                </select>
                            </div>

                            <!-- Fecha Inicio -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio *</label>
                                <input type="date" id="input-proyecto-fecha-inicio" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Entrega Estimada -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Est. *</label>
                                <input type="date" id="input-proyecto-fecha-entrega-est" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Entrega Real -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Real</label>
                                <input type="date" id="input-proyecto-fecha-entrega-real" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Valor (Auto-populated from Pipeline) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (COP)</label>
                                <input type="number" id="input-proyecto-valor" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Auto-completado" min="0">
                            </div>

                            <!-- Progreso -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Progreso (%) *</label>
                                <input type="number" id="input-proyecto-progreso" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="50" min="0" max="100" value="0">
                            </div>

                            <!-- Repositorio -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Repositorio (GitHub)</label>
                                <input type="url" id="input-proyecto-repositorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="https://github.com/...">
                            </div>

                            <!-- Deploy URL -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deploy URL</label>
                                <input type="url" id="input-proyecto-deploy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="https://app.ejemplo.com">
                            </div>

                            <!-- Google Drive Folder -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">üìÅ Carpeta Google Drive</label>
                                <input type="url" id="input-proyecto-drive" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="https://drive.google.com/drive/folders/...">
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-proyecto-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones del proyecto..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Proyecto
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Proyectos Registrados</h3>
                            <input type="text" id="search-proyectos" placeholder="üîç Buscar por nombre o cliente..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fase</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progreso</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-proyectos-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Facturaci√≥n View -->
                <div id="view-facturacion" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Facturaci√≥n</h2>
                        <button id="btn-refresh-facturacion" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nueva Factura</h3>

                        <form id="form-facturacion" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Proyecto (Dropdown din√°mico desde Proyectos) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Proyecto *</label>
                                <select id="input-factura-proyecto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Selecciona un proyecto...</option>
                                </select>
                            </div>

                            <!-- Cliente (auto-completado desde Proyecto) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                                <input type="text" id="input-factura-cliente" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Se llena autom√°ticamente">
                            </div>

                            <!-- Tipo de Factura -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Factura *</label>
                                <select id="input-factura-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Anticipo 50%">Anticipo 50%</option>
                                    <option value="Saldo 50%">Saldo 50%</option>
                                    <option value="√önica 100%">√önica 100%</option>
                                    <option value="Personalizada">Personalizada</option>
                                </select>
                            </div>

                            <!-- % del Proyecto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">% del Proyecto *</label>
                                <input type="number" id="input-factura-porcentaje" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="50" min="0" max="100" value="50">
                            </div>

                            <!-- Monto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto (COP) *</label>
                                <input type="number" id="input-factura-monto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- IVA -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">IVA (%)</label>
                                <select id="input-factura-iva" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="0">0%</option>
                                    <option value="19" selected>19%</option>
                                </select>
                            </div>

                            <!-- Monto Total (calculated) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto Total (COP)</label>
                                <input type="text" id="input-factura-total" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700" placeholder="Auto-calculado">
                            </div>

                            <!-- Fecha Emisi√≥n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Emisi√≥n *</label>
                                <input type="date" id="input-factura-fecha-emision" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Vencimiento -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Vencimiento *</label>
                                <input type="date" id="input-factura-fecha-vencimiento" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Pago -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Pago</label>
                                <input type="date" id="input-factura-fecha-pago" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-factura-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Pagada">Pagada</option>
                                    <option value="Vencida">Vencida</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>

                            <!-- M√©todo Pago -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pago</label>
                                <select id="input-factura-metodo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <!-- Referencia Pago -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Referencia de Pago</label>
                                <input type="text" id="input-factura-referencia" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="N√∫mero de transacci√≥n">
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-factura-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones de la factura..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Factura
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Facturas Registradas</h3>
                            <input type="text" id="search-facturacion" placeholder="üîç Buscar por proyecto o cliente..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto Total</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Emis.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Venc.</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-facturacion-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contactos View -->
                <div id="view-contactos" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Contactos</h2>
                        <button id="btn-refresh-contactos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Contacto</h3>

                        <form id="form-contactos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                                <input type="text" id="input-contacto-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Juan P√©rez">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" id="input-contacto-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="juan@empresa.co">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                                <input type="tel" id="input-contacto-telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="+57 300 123 4567">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
                                <input type="text" id="input-contacto-empresa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Tech Solutions">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cargo</label>
                                <input type="text" id="input-contacto-cargo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Director de Tecnolog√≠a">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                                <select id="input-contacto-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Cliente">Cliente</option>
                                    <option value="Lead">Lead</option>
                                    <option value="Promotor">Promotor</option>
                                    <option value="Proveedor">Proveedor</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fuente</label>
                                <select id="input-contacto-fuente" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Web">Web</option>
                                    <option value="Referido">Referido</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Evento">Evento</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                                <input type="url" id="input-contacto-linkedin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="https://linkedin.com/in/...">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label>
                                <input type="text" id="input-contacto-ciudad" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Bogot√°">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s</label>
                                <input type="text" id="input-contacto-pais" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Colombia">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                                <input type="text" id="input-contacto-tags" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="tecnolog√≠a, software, saas">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-contacto-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones..."></textarea>
                            </div>

                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Contacto
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Contactos Registrados</h3>
                            <input type="text" id="search-contactos" placeholder="üîç Buscar por nombre, empresa o email..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tel√©fono</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-contactos-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Promotores View -->
                <div id="view-promotores" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Promotores</h2>
                        <button id="btn-refresh-promotores" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Promotor</h3>

                        <form id="form-promotores" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                                <input type="text" id="input-promotor-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Mar√≠a Garc√≠a">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" id="input-promotor-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="maria@promotor.co">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                                <input type="tel" id="input-promotor-telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="+57 300 123 4567">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-promotor-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                    <option value="Suspendido">Suspendido</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">% Comisi√≥n *</label>
                                <input type="number" id="input-promotor-comision" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="10" min="0" max="30">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Banco</label>
                                <input type="text" id="input-promotor-banco" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Bancolombia">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cuenta</label>
                                <input type="text" id="input-promotor-cuenta" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="123456789">
                            </div>

                            <div class="md:col-span-2 lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-promotor-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones..."></textarea>
                            </div>

                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Promotor
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Promotores Registrados</h3>
                            <input type="text" id="search-promotores" placeholder="üîç Buscar por nombre..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tel√©fono</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">% Comis.</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-promotores-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Servicios View -->
                <div id="view-servicios" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Servicios (Portafolio)</h2>
                        <button id="btn-refresh-servicios" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Servicio</h3>

                        <form id="form-servicios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Nombre Servicio -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Servicio *</label>
                                <input type="text" id="input-servicio-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Dashboard Interactivo Google Sheets">
                            </div>

                            <!-- Categor√≠a -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a *</label>
                                <select id="input-servicio-categoria" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Adquisici√≥n">Adquisici√≥n</option>
                                    <option value="Escalada">Escalada</option>
                                    <option value="Retenci√≥n">Retenci√≥n</option>
                                </select>
                            </div>

                            <!-- Descripci√≥n Corta -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n Corta *</label>
                                <input type="text" id="input-servicio-descripcion-corta" required maxlength="200" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Dashboard web conectado a Google Sheets con gr√°ficas en tiempo real">
                            </div>

                            <!-- Precio Base -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Precio Base (COP) *</label>
                                <input type="number" id="input-servicio-precio-base" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- Precio M√≠nimo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Precio M√≠nimo (COP)</label>
                                <input type="number" id="input-servicio-precio-min" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="12000000" min="0">
                            </div>

                            <!-- Precio M√°ximo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Precio M√°ximo (COP)</label>
                                <input type="number" id="input-servicio-precio-max" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="20000000" min="0">
                            </div>

                            <!-- Duraci√≥n Estimada -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Duraci√≥n Estimada (d√≠as) *</label>
                                <input type="number" id="input-servicio-duracion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="30" min="1">
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-servicio-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Beta">Beta</option>
                                    <option value="Pr√≥ximamente">Pr√≥ximamente</option>
                                    <option value="Descontinuado">Descontinuado</option>
                                </select>
                            </div>

                            <!-- Incluye Soporte -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Incluye Soporte</label>
                                <select id="input-servicio-incluye-soporte" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="No">No</option>
                                    <option value="S√≠">S√≠</option>
                                </select>
                            </div>

                            <!-- Meses Soporte -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Meses de Soporte</label>
                                <input type="number" id="input-servicio-meses-soporte" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="3" min="0" max="12" value="0">
                            </div>

                            <!-- Stack Tecnol√≥gico -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Stack Tecnol√≥gico</label>
                                <input type="text" id="input-servicio-stack" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="HTML, CSS, JavaScript, Google Sheets API v4">
                            </div>

                            <!-- Descripci√≥n Detallada -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n Detallada</label>
                                <textarea id="input-servicio-descripcion-detallada" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Sistema completo de visualizaci√≥n de datos con autenticaci√≥n OAuth 2.0, KPIs din√°micos..."></textarea>
                            </div>

                            <!-- Entregables -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entregables (uno por l√≠nea)</label>
                                <textarea id="input-servicio-entregables" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="- C√≥digo fuente completo&#10;- Deploy en Vercel/Netlify&#10;- Documentaci√≥n t√©cnica"></textarea>
                            </div>

                            <!-- Requisitos Cliente -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Requisitos del Cliente</label>
                                <textarea id="input-servicio-requisitos" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="- Acceso a Google Sheet&#10;- Credenciales OAuth&#10;- Logo y colores de marca"></textarea>
                            </div>

                            <!-- Notas Internas -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas Internas</label>
                                <textarea id="input-servicio-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Alta demanda, personalizable..."></textarea>
                            </div>

                            <div class="md:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Servicio
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Cat√°logo de Servicios</h3>
                            <input type="text" id="search-servicios" placeholder="üîç Buscar servicio..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servicio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categor√≠a</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Base</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duraci√≥n</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Soporte</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="servicios-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gastos View -->
                <div id="view-gastos" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Gastos</h2>
                        <button id="btn-refresh-gastos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Gasto</h3>

                        <form id="form-gastos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                                <input type="date" id="input-gasto-fecha" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Concepto *</label>
                                <input type="text" id="input-gasto-concepto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Publicidad en Google Ads">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a *</label>
                                <select id="input-gasto-categoria" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Marketing">Marketing</option>
                                    <option value="Software">Software</option>
                                    <option value="Oficina">Oficina</option>
                                    <option value="Transporte">Transporte</option>
                                    <option value="Comisiones">Comisiones</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto (COP) *</label>
                                <input type="number" id="input-gasto-monto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="500000" min="0">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">M√©todo Pago *</label>
                                <select id="input-gasto-metodo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                                <input type="text" id="input-gasto-proveedor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Google Inc.">
                            </div>

                            <!-- Proyecto (Dropdown din√°mico desde Proyectos) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Proyecto (Opcional)</label>
                                <select id="input-gasto-proyecto" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Sin proyecto asociado</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-gasto-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Pagado">Pagado</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Reembolsado">Reembolsado</option>
                                </select>
                            </div>

                            <div class="md:col-span-2 lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-gasto-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones..."></textarea>
                            </div>

                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Gasto
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Gastos Registrados</h3>
                            <input type="text" id="search-gastos" placeholder="üîç Buscar por concepto o categor√≠a..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Concepto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categor√≠a</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-gastos-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Usuarios View -->
                <div id="view-usuarios" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Gesti√≥n de Usuarios</h2>
                        <button id="btn-refresh-usuarios" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Usuario</h3>

                        <form id="form-usuarios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Nombre Completo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                                <input type="text" id="input-usuario-nombre" required minlength="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Juan P√©rez">
                            </div>

                            <!-- Email -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" id="input-usuario-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="juan@empresa.com">
                            </div>

                            <!-- PIN -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">PIN (4 d√≠gitos) *</label>
                                <input type="text" id="input-usuario-pin" required pattern="[0-9]{4}" maxlength="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-center text-xl tracking-widest" placeholder="1234">
                                <p class="text-xs text-gray-500 mt-1">Debe ser 4 d√≠gitos num√©ricos</p>
                            </div>

                            <!-- Rol -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Rol *</label>
                                <select id="input-usuario-rol" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <!-- Opciones se llenar√°n din√°micamente seg√∫n rol actual -->
                                </select>
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-usuario-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                            </div>

                            <!-- Empresa ID -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa ID</label>
                                <input type="text" id="input-usuario-empresa" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="EMP-2025-0001" readonly>
                                <p class="text-xs text-gray-500 mt-1">Se asigna autom√°ticamente</p>
                            </div>

                            <div class="md:col-span-2 lg:col-span-3 flex justify-end gap-3">
                                <button type="button" id="btn-cancel-usuario" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg transition-all">
                                    Cancelar
                                </button>
                                <button type="submit" id="btn-submit-usuario" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Crear Usuario
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Usuarios Registrados</h3>
                            <input type="text" id="search-usuarios" placeholder="üîç Buscar por nombre o email..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">√öltima Actividad</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usuarios-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <script>
        // Global variables
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Chart instances
        let chartPipeline = null;
        let chartProyectos = null;
        let chartFacturacion = null;

        // ====================
        // AUTHENTICATION & SESSION MANAGEMENT
        // ====================

        /**
         * Session Manager - Handles user authentication and permissions
         */
        class SessionManager {
            constructor() {
                this.SESSION_KEY = 'metrik_session';
                this.currentSession = this.loadSession();
            }

            loadSession() {
                try {
                    const sessionData = localStorage.getItem(this.SESSION_KEY);
                    if (!sessionData) return null;

                    const session = JSON.parse(sessionData);

                    // Check if session is expired
                    if (Date.now() - session.timestamp > CONFIG.SESSION_DURATION) {
                        this.clearSession();
                        return null;
                    }

                    return session;
                } catch (error) {
                    console.error('Error loading session:', error);
                    return null;
                }
            }

            saveSession(userData) {
                const session = {
                    email: userData.email,
                    nombre: userData.nombre,
                    rol: userData.rol,
                    empresaId: userData.empresaId || null,
                    permisos: userData.permisos || {},
                    timestamp: Date.now()
                };

                localStorage.setItem(this.SESSION_KEY, JSON.stringify(session));
                this.currentSession = session;
            }

            clearSession() {
                localStorage.removeItem(this.SESSION_KEY);
                this.currentSession = null;
            }

            isAuthenticated() {
                return this.currentSession !== null;
            }

            getSession() {
                return this.currentSession;
            }

            isSuperAdmin() {
                return this.currentSession && this.currentSession.rol === CONFIG.ROLES.SUPER_ADMIN;
            }

            isAdminLocal() {
                return this.currentSession && this.currentSession.rol === CONFIG.ROLES.ADMIN_LOCAL;
            }

            canManageUsers() {
                return this.isSuperAdmin() || this.isAdminLocal();
            }

            canCreateAdminLocal() {
                return this.isSuperAdmin();
            }
        }

        // Initialize Session Manager
        const sessionManager = new SessionManager();

        /**
         * Authentication Functions
         */
        // DEPRECATED: Google OAuth authentication (commented out - using Email+PIN only)
        // async function authenticateWithGoogle() {
        //     try {
        //         tokenClient.requestAccessToken({ prompt: 'consent' });
        //         await new Promise((resolve) => {
        //             const checkToken = setInterval(() => {
        //                 if (accessToken) {
        //                     clearInterval(checkToken);
        //                     resolve();
        //                 }
        //             }, 100);
        //         });
        //         const userInfo = await getUserInfo();
        //         if (!CONFIG.SUPER_ADMIN_EMAILS.includes(userInfo.email)) {
        //             showToast('No autorizado. Solo Super Admins pueden usar Google OAuth.', 'error');
        //             return false;
        //         }
        //         sessionManager.saveSession({
        //             email: userInfo.email,
        //             nombre: userInfo.name || userInfo.email.split('@')[0],
        //             rol: CONFIG.ROLES.SUPER_ADMIN,
        //             empresaId: null,
        //             permisos: {}
        //         });
        //         return true;
        //     } catch (error) {
        //         console.error('‚ùå Error in Google authentication:', error);
        //         showToast('Error al autenticar con Google', 'error');
        //         return false;
        //     }
        // }

        async function authenticateWithEmailPIN(email, pin) {
            try {
                // Normalize email to lowercase for comparison
                const normalizedEmail = email.toLowerCase().trim();

                // Read usuarios from sheet
                const usuariosData = await sheetsAPI.readSheet(CONFIG.SHEETS.USUARIOS, 'A2:K');

                if (!usuariosData || usuariosData.length === 0) {
                    showToast('No hay usuarios registrados', 'error');
                    return false;
                }

                // Find user by email (case-insensitive)
                const userRow = usuariosData.find(row =>
                    row[2] && row[2].toLowerCase().trim() === normalizedEmail
                );

                if (!userRow) {
                    showToast('Credenciales incorrectas', 'error');
                    return false;
                }

                const [id, nombre, userEmail, userPIN, rol, estado, empresaId, permisos] = userRow;

                // Validate PIN
                if (userPIN !== pin) {
                    showToast('Credenciales incorrectas', 'error');
                    return false;
                }

                // Validate status
                if (estado !== 'Activo') {
                    showToast('Usuario inactivo. Contacta al administrador.', 'error');
                    return false;
                }

                // Update last activity
                const rowIndex = usuariosData.indexOf(userRow) + 2; // +2 because of header and 0-index
                const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
                await sheetsAPI.updateSheet(CONFIG.SHEETS.USUARIOS, `K${rowIndex}`, [[now]]);

                // Parse permisos if exists
                let permisosObj = {};
                try {
                    if (permisos) {
                        permisosObj = JSON.parse(permisos);
                    }
                } catch (e) {
                    console.warn('Could not parse permisos JSON:', e);
                }

                // Create session
                sessionManager.saveSession({
                    email: userEmail,
                    nombre: nombre,
                    rol: rol,
                    empresaId: empresaId || null,
                    permisos: permisosObj
                });

                return true;
            } catch (error) {
                console.error('‚ùå Error in Email+PIN authentication:', error);
                showToast('Error al autenticar', 'error');
                return false;
            }
        }

        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('Error getting user info:', error);
                throw error;
            }
        }

        function logout() {
            sessionManager.clearSession();

            // Revoke Google token if exists
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Token revoked');
                });
                accessToken = null;
            }

            // Reload page to show login screen
            window.location.reload();
        }

        /**
         * UI Control based on roles
         */
        function setupUIForRole() {
            const session = sessionManager.getSession();
            if (!session) return;

            // Update header with user info
            document.getElementById('user-email').textContent = `${session.nombre} (${session.rol})`;

            // Show/hide Usuarios menu item
            const navUsuarios = document.getElementById('nav-usuarios');
            if (sessionManager.canManageUsers()) {
                navUsuarios.classList.remove('hidden');
            } else {
                navUsuarios.classList.add('hidden');
            }

            // Additional UI controls can be added here based on permissions
            // For example: hiding buttons, disabling features, etc.
        }

        // ====================
        // DATA LAYER: Google Sheets API
        // ====================

        /**
         * Google Sheets API wrapper with caching
         */
        class GoogleSheetsAPI {
            constructor() {
                this.cache = new Map();
            }

            /**
             * Read data from a sheet
             * @param {string} sheetName - Name of the sheet (e.g., 'Pipeline')
             * @param {string} range - Range to read (e.g., 'A2:Z' to read all data rows)
             * @returns {Promise<Array>} Array of rows
             */
            async readSheet(sheetName, range = 'A2:Z') {
                const cacheKey = `${sheetName}!${range}`;

                // Check cache
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < CONFIG.CACHE_DURATION) {
                        console.log(`üì¶ Cache hit: ${cacheKey}`);
                        return cached.data;
                    }
                }

                try {
                    console.log(`üîÑ Fetching: ${sheetName}!${range}`);

                    // Set access token before making request
                    if (accessToken) {
                        gapi.client.setToken({ access_token: accessToken });
                    }

                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`,
                    });

                    const data = response.result.values || [];

                    // Cache the result
                    this.cache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });

                    console.log(`‚úÖ Fetched ${data.length} rows from ${sheetName}`);
                    return data;
                } catch (error) {
                    console.error(`‚ùå Error reading ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Write data to a sheet (append rows)
             * @param {string} sheetName - Name of the sheet
             * @param {Array<Array>} values - 2D array of values to write
             * @returns {Promise<Object>} Response object
             */
            async writeSheet(sheetName, values) {
                try {
                    console.log(`‚úçÔ∏è Writing ${values.length} rows to ${sheetName}`);

                    // Set access token before making request
                    if (accessToken) {
                        gapi.client.setToken({ access_token: accessToken });
                    }

                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!A2`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: {
                            values: values
                        }
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(`‚úÖ Written to ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(`‚ùå Error writing to ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Update existing data in a sheet
             * @param {string} sheetName - Name of the sheet
             * @param {string} range - Range to update (e.g., 'A2:E2')
             * @param {Array<Array>} values - 2D array of values to update
             * @returns {Promise<Object>} Response object
             */
            async updateSheet(sheetName, range, values) {
                try {
                    console.log(`üîÑ Updating ${sheetName}!${range}`);

                    // Set access token before making request
                    if (accessToken) {
                        gapi.client.setToken({ access_token: accessToken });
                    }

                    const response = await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`,
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: values
                        }
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(`‚úÖ Updated ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(`‚ùå Error updating ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Delete a row from a sheet (completely removes the row)
             * @param {string} sheetName - Name of the sheet
             * @param {number} rowNumber - Row number to delete (1-indexed)
             * @returns {Promise<Object>} Response object
             */
            async deleteRow(sheetName, rowNumber) {
                try {
                    console.log(`üóëÔ∏è Deleting row ${rowNumber} from ${sheetName}`);

                    // Set access token before making request
                    if (accessToken) {
                        gapi.client.setToken({ access_token: accessToken });
                    }

                    // Get sheet ID for the sheet name
                    const sheetMetadata = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: CONFIG.SHEET_ID
                    });

                    const sheet = sheetMetadata.result.sheets.find(s => s.properties.title === sheetName);
                    if (!sheet) {
                        throw new Error(`Sheet ${sheetName} not found`);
                    }

                    const sheetId = sheet.properties.sheetId;

                    // Delete the row using batchUpdate
                    const response = await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: CONFIG.SHEET_ID,
                        resource: {
                            requests: [{
                                deleteDimension: {
                                    range: {
                                        sheetId: sheetId,
                                        dimension: 'ROWS',
                                        startIndex: rowNumber - 1, // 0-indexed
                                        endIndex: rowNumber // exclusive
                                    }
                                }
                            }]
                        }
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(`‚úÖ Row ${rowNumber} deleted from ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(`‚ùå Error deleting from ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Invalidate cache for a specific sheet
             * @param {string} sheetName - Name of the sheet
             */
            invalidateCache(sheetName) {
                const keysToDelete = [];
                for (const key of this.cache.keys()) {
                    if (key.startsWith(sheetName)) {
                        keysToDelete.push(key);
                    }
                }
                keysToDelete.forEach(key => this.cache.delete(key));
                console.log(`üóëÔ∏è Cache invalidated for ${sheetName}`);
            }

            /**
             * Clear all cache
             */
            clearCache() {
                this.cache.clear();
                console.log('üóëÔ∏è All cache cleared');
            }
        }

        // Create global instance
        const sheetsAPI = new GoogleSheetsAPI();

        // Initialize on load
        window.onload = function() {
            gapiLoadClient();
            gisInit();
        };

        // Load the Google API client
        function gapiLoadClient() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: CONFIG.DISCOVERY_DOCS,
                });
                // Explicitly load the Sheets API
                await gapi.client.load('sheets', 'v4');
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        // Initialize Google Identity Services
        function gisInit() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    onAuthSuccess();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // Check if there's an active session
                if (sessionManager.isAuthenticated()) {
                    // Clear saved session - user must re-authenticate to get fresh token
                    // This ensures we always have a valid Google OAuth token
                    console.log('üìã Session found, clearing to require fresh authentication');
                    sessionManager.clearSession();
                }

                // Show login screen
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        // DEPRECATED: Google Login button (removed from UI)
        // document.getElementById('login-google-button').addEventListener('click', async () => {
        //     const success = await authenticateWithGoogle();
        //     if (success) {
        //         onAuthSuccess();
        //     }
        // });

        // Email + PIN Login form
        document.getElementById('login-form-pin').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;

            // Show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Autenticando...';

            const email = document.getElementById('login-email').value.trim();
            const pin = document.getElementById('login-pin').value.trim();

            try {
                // STEP 1: First, request Google Sheets access token
                // We need this to read the Usuarios sheet
                console.log('üîê Step 1: Requesting Google OAuth token...');

                // Create a promise to wait for token
                const tokenPromise = new Promise((resolve, reject) => {
                    // Set up temporary callback
                    const originalCallback = tokenClient.callback;
                    tokenClient.callback = (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            accessToken = tokenResponse.access_token;
                            console.log('‚úÖ Google OAuth token obtained');
                            tokenClient.callback = originalCallback; // Restore original
                            resolve();
                        } else {
                            tokenClient.callback = originalCallback; // Restore original
                            reject(new Error('No token received'));
                        }
                    };

                    // Request token
                    tokenClient.requestAccessToken({ prompt: '' });

                    // Timeout after 30 seconds
                    setTimeout(() => {
                        if (!accessToken) {
                            tokenClient.callback = originalCallback; // Restore original
                            reject(new Error('Token request timeout'));
                        }
                    }, 30000);
                });

                // Wait for token
                await tokenPromise;

                // STEP 2: Now authenticate with Email+PIN using the token
                console.log('üîê Step 2: Validating Email+PIN...');
                const success = await authenticateWithEmailPIN(email, pin);

                if (success) {
                    console.log('‚úÖ Authentication successful');
                    onAuthSuccess();
                } else {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            } catch (error) {
                console.error('‚ùå Error during authentication:', error);
                showToast('Error al conectar con Google. Intenta de nuevo.', 'error');
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', logout);

        // Sidebar toggle
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');

            if (sidebar.classList.contains('w-64')) {
                // Collapse
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-16');
                sidebar.querySelectorAll('span:not(.text-xl)').forEach(span => span.classList.add('hidden'));
            } else {
                // Expand
                sidebar.classList.remove('w-16');
                sidebar.classList.add('w-64');
                sidebar.querySelectorAll('span:not(.text-xl)').forEach(span => span.classList.remove('hidden'));
            }
        });

        // On successful authentication
        async function onAuthSuccess() {
            // Hide login, show main app
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            // Setup UI based on role
            setupUIForRole();

            // Initialize navigation
            initNavigation();

            // Load dashboard data
            loadDashboardData();
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                console.log('üìä Loading dashboard data...');

                // Read data from all sheets in parallel
                const [pipelineData, proyectosData, facturacionData] = await Promise.all([
                    sheetsAPI.readSheet(CONFIG.SHEETS.PIPELINE),
                    sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS),
                    sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION)
                ]);

                // ====================
                // KPI 1: Leads Activos
                // ====================
                // Count leads with estado != "Perdido" and != "Ganado"
                const leadsActivos = pipelineData.filter(row => {
                    const estado = row[10]; // Column K: Estado
                    return estado && estado !== 'Perdido' && estado !== 'Ganado';
                }).length;

                document.getElementById('kpi-leads').textContent = leadsActivos;

                // ====================
                // KPI 2: Pipeline Value
                // ====================
                // Sum of "Pipeline Value" for active leads
                // Formula: Valor √ó (Probabilidad / 100)
                const pipelineValue = pipelineData
                    .filter(row => {
                        const estado = row[10]; // Column K: Estado
                        return estado && estado !== 'Perdido' && estado !== 'Ganado';
                    })
                    .reduce((sum, row) => {
                        const valor = parseFloat(row[6]) || 0; // Column G: Valor
                        const probabilidad = parseFloat(row[7]) || 0; // Column H: Probabilidad
                        const pipelineVal = valor * (probabilidad / 100);
                        return sum + pipelineVal;
                    }, 0);

                document.getElementById('kpi-pipeline').textContent = formatCurrency(pipelineValue);

                // ====================
                // KPI 3: Proyectos Activos
                // ====================
                // Count proyectos with estado = "Activo"
                const proyectosActivos = proyectosData.filter(row => {
                    const estado = row[4]; // Column E: Estado
                    return estado === 'Activo';
                }).length;

                document.getElementById('kpi-proyectos').textContent = proyectosActivos;

                // ====================
                // KPI 4: Facturaci√≥n Mes Actual
                // ====================
                // Sum of "Monto" for current month
                const currentMonth = new Date().getMonth() + 1; // 1-12
                const currentYear = new Date().getFullYear();

                const facturacionMes = facturacionData
                    .filter(row => {
                        const fechaEmision = row[1]; // Column B: Fecha emisi√≥n
                        if (!fechaEmision) return false;

                        // Parse date (assuming format: DD/MM/YYYY or YYYY-MM-DD)
                        const date = parseDate(fechaEmision);
                        if (!date) return false;

                        return date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
                    })
                    .reduce((sum, row) => {
                        const monto = parseFloat(row[4]) || 0; // Column E: Monto
                        return sum + monto;
                    }, 0);

                document.getElementById('kpi-facturacion').textContent = formatCurrency(facturacionMes);

                // ====================
                // CASH FLOW KPIs
                // ====================

                // KPI 5: Facturado Este Mes (Facturas Pagadas)
                const facturadoMes = facturacionData
                    .filter(row => {
                        const estado = row[9]; // Column J: Estado
                        const fechaPago = row[8]; // Column I: Fecha Pago
                        if (estado !== 'Pagada' || !fechaPago) return false;

                        const date = parseDate(fechaPago);
                        if (!date) return false;

                        return date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
                    })
                    .reduce((sum, row) => {
                        const montoTotal = parseFloat(row[5]) || 0; // Column F: Monto Total
                        return sum + montoTotal;
                    }, 0);

                document.getElementById('kpi-facturado-mes').textContent = formatCurrency(facturadoMes);

                // KPI 6: Por Cobrar (Facturas Pendientes)
                const porCobrar = facturacionData
                    .filter(row => {
                        const estado = row[9]; // Column J: Estado
                        return estado === 'Pendiente';
                    })
                    .reduce((sum, row) => {
                        const montoTotal = parseFloat(row[5]) || 0; // Column F: Monto Total
                        return sum + montoTotal;
                    }, 0);

                document.getElementById('kpi-por-cobrar').textContent = formatCurrency(porCobrar);

                // KPI 7: Proyectado Pr√≥ximos 30 D√≠as
                const hoy = new Date();
                const en30Dias = new Date();
                en30Dias.setDate(hoy.getDate() + 30);

                const proyectado30 = facturacionData
                    .filter(row => {
                        const estado = row[9]; // Column J: Estado
                        const fechaVencimiento = row[7]; // Column H: Fecha Vencimiento
                        if (estado !== 'Pendiente' || !fechaVencimiento) return false;

                        const date = parseDate(fechaVencimiento);
                        if (!date) return false;

                        return date >= hoy && date <= en30Dias;
                    })
                    .reduce((sum, row) => {
                        const montoTotal = parseFloat(row[5]) || 0; // Column F: Monto Total
                        return sum + montoTotal;
                    }, 0);

                document.getElementById('kpi-proyectado-30').textContent = formatCurrency(proyectado30);

                // KPI 8: Anticipos sin Saldo
                // Get unique project names from Facturaci√≥n
                const proyectosConAnticipo = new Set();
                const proyectosConSaldo = new Set();

                facturacionData.forEach(row => {
                    const proyecto = row[1]; // Column B: Proyecto
                    const tipo = row[13]; // Column N: Tipo Factura

                    if (tipo === 'Anticipo 50%') {
                        proyectosConAnticipo.add(proyecto);
                    } else if (tipo === 'Saldo 50%') {
                        proyectosConSaldo.add(proyecto);
                    }
                });

                // Count projects with anticipo but no saldo
                let anticiposSinSaldo = 0;
                proyectosConAnticipo.forEach(proyecto => {
                    if (!proyectosConSaldo.has(proyecto)) {
                        anticiposSinSaldo++;
                    }
                });

                document.getElementById('kpi-anticipos-sin-saldo').textContent = anticiposSinSaldo;

                // Initialize charts with real data
                initCharts(pipelineData, proyectosData, facturacionData);

                console.log('‚úÖ Dashboard data loaded successfully');
            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);

                // Show error state
                document.getElementById('kpi-leads').textContent = 'Error';
                document.getElementById('kpi-pipeline').textContent = 'Error';
                document.getElementById('kpi-proyectos').textContent = 'Error';
                document.getElementById('kpi-facturacion').textContent = 'Error';
                document.getElementById('kpi-facturado-mes').textContent = 'Error';
                document.getElementById('kpi-por-cobrar').textContent = 'Error';
                document.getElementById('kpi-proyectado-30').textContent = 'Error';
                document.getElementById('kpi-anticipos-sin-saldo').textContent = 'Error';

                alert('Error al cargar datos del dashboard. Por favor, recarga la p√°gina.');
            }
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================

        /**
         * Format number as currency (COP)
         */
        function formatCurrency(value) {
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(1)}K`;
            } else {
                return `$${value.toFixed(0)}`;
            }
        }

        /**
         * Parse date from string (supports DD/MM/YYYY and YYYY-MM-DD)
         */
        function parseDate(dateString) {
            if (!dateString) return null;

            // Try DD/MM/YYYY format
            let parts = dateString.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // 0-indexed
                const year = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            // Try YYYY-MM-DD format
            parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // 0-indexed
                const day = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            return null;
        }

        // Initialize charts with real data
        function initCharts(pipelineData = [], proyectosData = [], facturacionData = []) {
            // Destroy existing charts if they exist
            if (chartPipeline) {
                chartPipeline.destroy();
                chartPipeline = null;
            }
            if (chartProyectos) {
                chartProyectos.destroy();
                chartProyectos = null;
            }
            if (chartFacturacion) {
                chartFacturacion.destroy();
                chartFacturacion = null;
            }

            // ====================
            // Chart 1: Pipeline por Etapa
            // ====================
            const etapas = ['Contacto', 'Propuesta', 'Negociaci√≥n', 'Cierre'];
            const pipelineByEtapa = etapas.map(etapa => {
                return pipelineData.filter(row => {
                    const etapaRow = row[5]; // Column F: Etapa
                    const estado = row[10]; // Column K: Estado
                    return etapaRow === etapa && estado !== 'Perdido' && estado !== 'Ganado';
                }).length;
            });

            const ctx1 = document.getElementById('chart-pipeline').getContext('2d');
            chartPipeline = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Contacto', 'Propuesta', 'Negociaci√≥n', 'Cierre'],
                    datasets: [{
                        label: 'Cantidad de Leads',
                        data: pipelineByEtapa,
                        backgroundColor: '#10B981',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // ====================
            // Chart 2: Proyectos por Estado
            // ====================
            const estados = ['Activo', 'Pausado', 'Completado', 'Cancelado'];
            const proyectosByEstado = estados.map(estado => {
                return proyectosData.filter(row => {
                    const estadoRow = row[4]; // Column E: Estado
                    return estadoRow === estado;
                }).length;
            });

            const ctx2 = document.getElementById('chart-proyectos').getContext('2d');
            chartProyectos = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: estados,
                    datasets: [{
                        data: proyectosByEstado,
                        backgroundColor: ['#10B981', '#F59E0B', '#6B7280', '#EF4444'],
                    }]
                },
                options: {
                    responsive: true,
                }
            });

            // ====================
            // Chart 3: Facturaci√≥n √∫ltimos 12 meses
            // ====================
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();

            // Calculate last 12 months data
            const last12Months = [];
            for (let i = 11; i >= 0; i--) {
                const date = new Date(currentYear, currentDate.getMonth() - i, 1);
                const month = date.getMonth() + 1; // 1-12
                const year = date.getFullYear();

                const monthTotal = facturacionData
                    .filter(row => {
                        const fechaEmision = row[1]; // Column B: Fecha emisi√≥n
                        if (!fechaEmision) return false;

                        const parsedDate = parseDate(fechaEmision);
                        if (!parsedDate) return false;

                        return parsedDate.getMonth() + 1 === month && parsedDate.getFullYear() === year;
                    })
                    .reduce((sum, row) => {
                        const monto = parseFloat(row[4]) || 0; // Column E: Monto
                        return sum + monto;
                    }, 0);

                last12Months.push({
                    label: monthNames[date.getMonth()],
                    value: monthTotal / 1000000 // Convert to millions
                });
            }

            const ctx3 = document.getElementById('chart-facturacion').getContext('2d');
            chartFacturacion = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: last12Months.map(m => m.label),
                    datasets: [{
                        label: 'Facturaci√≥n (Millones COP)',
                        data: last12Months.map(m => m.value),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(1)}M COP`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return `$${value}M`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ====================
        // TOAST NOTIFICATION SYSTEM
        // ====================

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;

            // Set color based on type
            if (type === 'success') {
                toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            } else if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            } else {
                toast.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            }

            // Hide after 3 seconds
            setTimeout(() => {
                toast.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50';
            }, 3000);
        }

        // ====================
        // PIPELINE VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allPipelineData = [];

        /**
         * Load and render Pipeline data
         */
        async function loadPipelineView() {
            try {
                console.log('üìä Loading Pipeline view...');

                const pipelineData = await sheetsAPI.readSheet(CONFIG.SHEETS.PIPELINE);
                allPipelineData = pipelineData || [];
                renderPipelineTable(allPipelineData);

                // Populate dropdowns
                await populateContactosDropdownPipeline();
                await populateServiciosDropdownPipeline();
                await populatePromotoresDropdownPipeline();

                console.log('‚úÖ Pipeline view loaded');
            } catch (error) {
                console.error('‚ùå Error loading Pipeline:', error);
                showToast('Error al cargar Pipeline', 'error');
            }
        }

        /**
         * Filter Pipeline table by search term
         */
        function filterPipelineTable(searchTerm) {
            if (!searchTerm) {
                renderPipelineTable(allPipelineData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allPipelineData.filter(row => {
                // Updated structure: ID, ContactoID, Nombre, Empresa, Email...
                const [id, contactoId, lead, empresa, email] = row;
                return (
                    (lead && lead.toLowerCase().includes(searchLower)) ||
                    (empresa && empresa.toLowerCase().includes(searchLower)) ||
                    (email && email.toLowerCase().includes(searchLower))
                );
            });
            renderPipelineTable(filtered);
        }

        /**
         * Render Pipeline table
         */
        function renderPipelineTable(data) {
            const tbody = document.getElementById('table-pipeline-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">No hay leads registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                // Updated structure: ID, ContactoID, Nombre, Empresa, Email, Tel√©fono, Etapa, Valor, Probabilidad, FechaContacto, FechaCierre, Estado, Fuente, Notas, Servicio, FechaActualizaci√≥n, Promotor, DriveFolder
                const [id, contactoId, lead, empresa, email, telefono, etapa, valor, probabilidad, fechaContacto, fechaCierre, estado, fuente, notas, servicio, fechaActualizacion, promotor, driveFolder] = row;

                // Generate badge colors
                const etapaBadge = getBadge(etapa, 'blue');
                const estadoBadge = getBadge(estado, getEstadoColor(estado));
                const servicioBadge = servicio ? getBadge(servicio, 'green') : '<span class="text-gray-400 text-xs">Sin servicio</span>';
                const driveFolderBtn = driveFolder ? `<a href="${driveFolder}" target="_blank" class="text-yellow-600 hover:text-yellow-800" title="Abrir carpeta Google Drive">üìÅ</a>` : '';
                const deleteBtn = sessionManager.isSuperAdmin() ?
                    `<button onclick="deletePipelineLead(${index + 2})" class="text-red-600 hover:text-red-800" title="Eliminar">üóëÔ∏è</button>` : '';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${lead || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${empresa || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${email || '-'}</td>
                        <td class="px-4 py-3 text-sm">${servicioBadge}</td>
                        <td class="px-4 py-3 text-sm">${etapaBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(valor) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${probabilidad}%</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm text-right space-x-1">
                            ${driveFolderBtn}
                            <button onclick='editPipelineLead(${index + 2}, ${JSON.stringify(row)})' class="text-blue-600 hover:text-blue-800" title="Editar">‚úèÔ∏è</button>
                            ${deleteBtn}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get badge HTML
         */
        function getBadge(text, color) {
            const colors = {
                'blue': 'bg-blue-100 text-blue-800',
                'green': 'bg-green-100 text-green-800',
                'yellow': 'bg-yellow-100 text-yellow-800',
                'red': 'bg-red-100 text-red-800',
                'gray': 'bg-gray-100 text-gray-800'
            };

            const colorClass = colors[color] || colors.gray;

            return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${colorClass}">${text}</span>`;
        }

        /**
         * Get estado color
         */
        function getEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'blue';
                case 'Ganado': return 'green';
                case 'Perdido': return 'red';
                case 'Pausado': return 'yellow';
                default: return 'gray';
            }
        }

        /**
         * Generate Pipeline ID
         */
        function generatePipelineId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PIP-${year}-${random}`;
        }

        /**
         * Handle Pipeline form submission
         */
        async function handlePipelineSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generatePipelineId();
                const contactoSelect = document.getElementById('input-contacto').value;

                // Validate contacto selection
                if (!contactoSelect) {
                    showToast('Debes seleccionar un contacto', 'error');
                    return;
                }

                const contactoData = JSON.parse(contactoSelect);
                const contactoId = contactoData.id;
                const lead = contactoData.nombre;
                const empresa = contactoData.empresa;
                const email = contactoData.email;
                const telefono = contactoData.telefono;

                const etapa = document.getElementById('input-etapa').value;
                const valor = document.getElementById('input-valor').value;
                const probabilidad = document.getElementById('input-probabilidad').value;
                const fechaContacto = document.getElementById('input-fecha-contacto').value;
                const fechaCierre = document.getElementById('input-fecha-cierre').value;
                const estado = document.getElementById('input-estado').value;
                const fuente = document.getElementById('input-fuente').value;
                const notas = document.getElementById('input-notas').value;
                const servicioSelect = document.getElementById('input-servicio').value;
                const servicio = servicioSelect ? JSON.parse(servicioSelect).nombre : '';
                const promotor = fuente === 'Referido' ? document.getElementById('input-promotor').value : '';
                const driveFolder = document.getElementById('input-drive-pipeline').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Validate promotor if fuente is Referido
                if (fuente === 'Referido' && !promotor) {
                    showToast('Debes seleccionar un promotor cuando la fuente es Referido', 'error');
                    return;
                }

                // Create row data (18 columns A-R: ID, Contacto ID, Nombre, Empresa, Email, Tel√©fono, Etapa, Valor, Probabilidad, FechaContacto, FechaCierre, Estado, Fuente, Notas, Servicio, FechaActualizaci√≥n, Promotor, DriveFolder)
                const rowData = [[
                    id,
                    contactoId,
                    lead,
                    empresa,
                    email,
                    telefono,
                    etapa,
                    valor,
                    probabilidad,
                    fechaContacto,
                    fechaCierre,
                    estado,
                    fuente,
                    notas,
                    servicio,
                    fechaActualizacion,
                    promotor,
                    driveFolder
                ]];

                if (isEditing) {
                    // Update existing row (18 columns A-R)
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.PIPELINE, `A${editRow}:R${editRow}`, rowData);
                    showToast('Lead actualizado exitosamente', 'success');

                    // Check if estado changed to "Ganado" ‚Üí Create project automatically
                    if (estado === 'Ganado') {
                        const servicioData = servicioSelect ? JSON.parse(servicioSelect) : null;
                        const createProject = confirm(`üéâ Lead marcado como GANADO!\n\n¬øDeseas crear el proyecto autom√°ticamente?\n\nCliente: ${empresa}\nServicio: ${servicioData ? servicioData.nombre : 'N/A'}\nValor: ${formatCurrency(parseFloat(valor))}`);
                        if (createProject) {
                            await convertLeadToProject(id, lead, empresa, email, telefono, valor, servicioData);
                        }
                    }
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.PIPELINE, rowData);
                    showToast('Lead guardado exitosamente', 'success');

                    // Check if new lead is already "Ganado" ‚Üí Create project automatically
                    if (estado === 'Ganado') {
                        const servicioData = servicioSelect ? JSON.parse(servicioSelect) : null;
                        const createProject = confirm(`üéâ Lead marcado como GANADO!\n\n¬øDeseas crear el proyecto autom√°ticamente?\n\nCliente: ${empresa}\nServicio: ${servicioData ? servicioData.nombre : 'N/A'}\nValor: ${formatCurrency(parseFloat(valor))}`);
                        if (createProject) {
                            await convertLeadToProject(id, lead, empresa, email, telefono, valor, servicioData);
                        }
                    }
                }

                // Reset form
                document.getElementById('form-pipeline').reset();
                submitBtn.textContent = 'Guardar Lead';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadPipelineView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error saving lead:', error);
                showToast('Error al guardar lead', 'error');
            }
        }

        /**
         * Convert Lead to Project automatically
         */
        async function convertLeadToProject(pipelineId, nombre, empresa, email, telefono, valor, servicioData = null) {
            try {
                console.log(`üîÑ Converting lead ${pipelineId} to project...`);

                // Generate Project ID
                const projectId = generateProyectoId();
                const today = new Date().toISOString().slice(0, 10);

                // Calculate delivery date from servicio duration or default 30 days
                const duracionDias = servicioData ? parseInt(servicioData.duracion) || 30 : 30;
                const estimatedDelivery = new Date();
                estimatedDelivery.setDate(estimatedDelivery.getDate() + duracionDias);
                const fechaEntregaEst = estimatedDelivery.toISOString().slice(0, 10);

                // Get tipo proyecto from servicio categoria or default Custom
                const tipoProyecto = servicioData ? servicioData.categoria : 'Custom';

                // Create project data (19 columns A-S)
                const projectData = [[
                    projectId,                          // A: ID
                    pipelineId,                         // B: Pipeline ID
                    `Proyecto ${nombre}`,               // C: Nombre
                    nombre,                             // D: Cliente (Nombre)
                    empresa,                            // E: Empresa
                    email,                              // F: Email Cliente
                    telefono,                           // G: Tel√©fono Cliente
                    tipoProyecto,                       // H: Tipo Proyecto (from Servicio)
                    'Activo',                           // I: Estado
                    'Discovery',                        // J: Fase
                    today,                              // K: Fecha Inicio
                    fechaEntregaEst,                    // L: Fecha Entrega Estimada
                    '',                                 // M: Fecha Entrega Real
                    valor,                              // N: Valor
                    '10',                               // O: Progreso (10% = Discovery)
                    '',                                 // P: Repositorio
                    '',                                 // Q: Deploy URL
                    `Proyecto creado autom√°ticamente desde Pipeline ${pipelineId}${servicioData ? ` - Servicio: ${servicioData.nombre}` : ''}`, // R: Notas
                    new Date().toISOString().slice(0, 19).replace('T', ' ') // S: Fecha Actualizaci√≥n
                ]];

                // Save project to Google Sheets
                await sheetsAPI.writeSheet(CONFIG.SHEETS.PROYECTOS, projectData);

                showToast(`‚úÖ Proyecto ${projectId} creado exitosamente!`, 'success');
                console.log(`‚úÖ Project ${projectId} created from Pipeline ${pipelineId}`);

                // Ask if user wants to create Anticipo invoice
                const createInvoice = confirm(`‚úÖ Proyecto creado: ${projectId}\n\n¬øDeseas generar la factura de ANTICIPO (50%) ahora?`);
                if (createInvoice) {
                    await generateAnticipoInvoice(projectId, `Proyecto ${nombre}`, empresa, valor);
                }

                return projectId;
            } catch (error) {
                console.error('‚ùå Error converting lead to project:', error);
                showToast('Error al crear proyecto autom√°ticamente', 'error');
                throw error;
            }
        }

        /**
         * Generate Anticipo Invoice (50%) for a project
         */
        async function generateAnticipoInvoice(projectId, projectName, cliente, valorTotal) {
            try {
                console.log(`üí∞ Generating anticipo invoice for project ${projectId}...`);

                // Validation: Check if anticipo already exists
                const allFacturas = await sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION);
                const anticipoExistente = allFacturas.find(row => {
                    const facProyecto = row[1]; // Column B: Proyecto
                    const facTipo = row[13]; // Column N: Tipo Factura
                    return facProyecto === projectName && facTipo === 'Anticipo 50%';
                });

                if (anticipoExistente) {
                    showToast(`‚ö†Ô∏è El proyecto "${projectName}" ya tiene una factura de anticipo (${anticipoExistente[0]})`, 'error');
                    return null;
                }

                const facturaId = generateFacturaId();
                const today = new Date().toISOString().slice(0, 10);
                const vencimiento = new Date();
                vencimiento.setDate(vencimiento.getDate() + 15); // 15 days to pay
                const fechaVencimiento = vencimiento.toISOString().slice(0, 10);

                // Calculate 50% anticipo
                const monto = parseFloat(valorTotal) * 0.5;
                const iva = 19; // 19% IVA
                const montoTotal = monto + (monto * iva / 100);

                // Create invoice data
                const invoiceData = [[
                    facturaId,                          // A: ID
                    projectName,                        // B: Proyecto
                    cliente,                            // C: Cliente
                    monto.toString(),                   // D: Monto
                    iva.toString(),                     // E: IVA
                    montoTotal.toString(),              // F: Monto Total
                    today,                              // G: Fecha Emisi√≥n
                    fechaVencimiento,                   // H: Fecha Vencimiento
                    '',                                 // I: Fecha Pago
                    'Pendiente',                        // J: Estado
                    '',                                 // K: M√©todo Pago
                    '',                                 // L: Referencia
                    'Factura de anticipo (50%) generada autom√°ticamente', // M: Notas
                    'Anticipo 50%',                     // N: Tipo Factura
                    '50',                               // O: % Proyecto
                    new Date().toISOString().slice(0, 19).replace('T', ' ') // P: Fecha Actualizaci√≥n
                ]];

                // Save invoice to Google Sheets
                await sheetsAPI.writeSheet(CONFIG.SHEETS.FACTURACION, invoiceData);

                showToast(`‚úÖ Factura anticipo ${facturaId} creada: ${formatCurrency(montoTotal)}`, 'success');
                console.log(`‚úÖ Anticipo invoice ${facturaId} created for project ${projectId}`);

                return facturaId;
            } catch (error) {
                console.error('‚ùå Error generating anticipo invoice:', error);
                showToast('Error al generar factura de anticipo', 'error');
                throw error;
            }
        }

        /**
         * Generate Saldo Invoice (50%) for a project
         */
        async function generateSaldoInvoice(projectId, projectName, cliente, valorTotal) {
            try {
                console.log(`üí∞ Generating saldo invoice for project ${projectId}...`);

                // Validation: Check if saldo already exists
                const allFacturas = await sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION);
                const saldoExistente = allFacturas.find(row => {
                    const facProyecto = row[1]; // Column B: Proyecto
                    const facTipo = row[13]; // Column N: Tipo Factura
                    return facProyecto === projectName && facTipo === 'Saldo 50%';
                });

                if (saldoExistente) {
                    showToast(`‚ö†Ô∏è El proyecto "${projectName}" ya tiene una factura de saldo (${saldoExistente[0]})`, 'error');
                    return null;
                }

                // Validation: Check if anticipo exists first
                const anticipoExistente = allFacturas.find(row => {
                    const facProyecto = row[1]; // Column B: Proyecto
                    const facTipo = row[13]; // Column N: Tipo Factura
                    return facProyecto === projectName && facTipo === 'Anticipo 50%';
                });

                if (!anticipoExistente) {
                    showToast(`‚ö†Ô∏è El proyecto "${projectName}" no tiene factura de anticipo. Genera primero el anticipo (50%).`, 'error');
                    return null;
                }

                const facturaId = generateFacturaId();
                const today = new Date().toISOString().slice(0, 10);
                const vencimiento = new Date();
                vencimiento.setDate(vencimiento.getDate() + 15); // 15 days to pay
                const fechaVencimiento = vencimiento.toISOString().slice(0, 10);

                // Calculate 50% saldo
                const monto = parseFloat(valorTotal) * 0.5;
                const iva = 19; // 19% IVA
                const montoTotal = monto + (monto * iva / 100);

                // Create invoice data
                const invoiceData = [[
                    facturaId,                          // A: ID
                    projectName,                        // B: Proyecto
                    cliente,                            // C: Cliente
                    monto.toString(),                   // D: Monto
                    iva.toString(),                     // E: IVA
                    montoTotal.toString(),              // F: Monto Total
                    today,                              // G: Fecha Emisi√≥n
                    fechaVencimiento,                   // H: Fecha Vencimiento
                    '',                                 // I: Fecha Pago
                    'Pendiente',                        // J: Estado
                    '',                                 // K: M√©todo Pago
                    '',                                 // L: Referencia
                    'Factura de saldo (50%) generada autom√°ticamente al completar proyecto', // M: Notas
                    'Saldo 50%',                        // N: Tipo Factura
                    '50',                               // O: % Proyecto
                    new Date().toISOString().slice(0, 19).replace('T', ' ') // P: Fecha Actualizaci√≥n
                ]];

                // Save invoice to Google Sheets
                await sheetsAPI.writeSheet(CONFIG.SHEETS.FACTURACION, invoiceData);

                showToast(`‚úÖ Factura saldo ${facturaId} creada: ${formatCurrency(montoTotal)}`, 'success');
                console.log(`‚úÖ Saldo invoice ${facturaId} created for project ${projectId}`);

                return facturaId;
            } catch (error) {
                console.error('‚ùå Error generating saldo invoice:', error);
                showToast('Error al generar factura de saldo', 'error');
                throw error;
            }
        }

        /**
         * Generate Anticipo from Project table button
         */
        async function generateAnticipoFromProject(projectRow) {
            const [id, nombre, cliente, emailCliente, tipoProyecto, estado, fase, fechaInicio, fechaEntregaEst, fechaEntregaReal, valor] = projectRow;

            const confirm = window.confirm(`¬øGenerar factura de ANTICIPO (50%)?\n\nProyecto: ${nombre}\nCliente: ${cliente}\nMonto: ${formatCurrency(parseFloat(valor) * 0.5)}\nIVA 19% incluido`);

            if (confirm) {
                await generateAnticipoInvoice(id, nombre, cliente, valor);
                await loadProyectosView(); // Refresh table
            }
        }

        /**
         * Generate Saldo from Project table button
         */
        async function generateSaldoFromProject(projectRow) {
            const [id, nombre, cliente, emailCliente, tipoProyecto, estado, fase, fechaInicio, fechaEntregaEst, fechaEntregaReal, valor, progreso] = projectRow;

            if (parseFloat(progreso) < 90) {
                showToast('‚ö†Ô∏è El proyecto debe tener al menos 90% de progreso para facturar el saldo', 'error');
                return;
            }

            const confirm = window.confirm(`¬øGenerar factura de SALDO (50%)?\n\nProyecto: ${nombre}\nCliente: ${cliente}\nMonto: ${formatCurrency(parseFloat(valor) * 0.5)}\nIVA 19% incluido\n\n‚úÖ Progreso: ${progreso}%`);

            if (confirm) {
                await generateSaldoInvoice(id, nombre, cliente, valor);
                await loadProyectosView(); // Refresh table
            }
        }

        /**
         * Edit Pipeline lead
         */
        function editPipelineLead(rowNumber, rowData) {
            const [id, contactoId, lead, empresa, email, telefono, etapa, valor, probabilidad, fechaContacto, fechaCierre, estado, fuente, notas, servicio, fechaActualizacion, promotor] = rowData;

            // Scroll to form
            document.getElementById('form-pipeline').scrollIntoView({ behavior: 'smooth' });

            // Pre-select contacto (need to match by contactoId)
            const contactoDropdown = document.getElementById('input-contacto');
            for (let option of contactoDropdown.options) {
                if (option.value) {
                    const optionData = JSON.parse(option.value);
                    if (optionData.id === contactoId) {
                        contactoDropdown.value = option.value;
                        // Trigger change to auto-populate fields
                        contactoDropdown.dispatchEvent(new Event('change'));
                        break;
                    }
                }
            }

            // Pre-fill other form fields
            document.getElementById('input-etapa').value = etapa || '';
            document.getElementById('input-valor').value = valor || '';
            document.getElementById('input-probabilidad').value = probabilidad || '';
            document.getElementById('input-fecha-contacto').value = fechaContacto || '';
            document.getElementById('input-fecha-cierre').value = fechaCierre || '';
            document.getElementById('input-estado').value = estado || '';
            document.getElementById('input-fuente').value = fuente || '';
            document.getElementById('input-drive-pipeline').value = driveFolder || '';
            document.getElementById('input-notas').value = notas || '';

            // Show/hide and pre-select Promotor field if Fuente is Referido
            const promotorField = document.getElementById('promotor-field');
            const promotorDropdown = document.getElementById('input-promotor');
            if (fuente === 'Referido') {
                promotorField.classList.remove('hidden');
                promotorDropdown.setAttribute('required', 'required');
                promotorDropdown.value = promotor || '';
            } else {
                promotorField.classList.add('hidden');
                promotorDropdown.removeAttribute('required');
                promotorDropdown.value = '';
            }

            // Pre-select servicio if exists
            if (servicio) {
                const servicioDropdown = document.getElementById('input-servicio');
                for (let option of servicioDropdown.options) {
                    if (option.value && JSON.parse(option.value).nombre === servicio) {
                        servicioDropdown.value = option.value;
                        break;
                    }
                }
            }

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-pipeline button[type="submit"]');
            submitBtn.textContent = 'Actualizar Lead';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
        }

        /**
         * Delete Pipeline lead
         */
        async function deletePipelineLead(rowNumber) {
            // Only Super Admin can delete
            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar este lead?')) {
                return;
            }

            try {
                await sheetsAPI.deleteRow(CONFIG.SHEETS.PIPELINE, rowNumber);

                showToast('Lead eliminado exitosamente', 'success');

                // Reload table
                await loadPipelineView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error deleting lead:', error);
                showToast('Error al eliminar lead', 'error');
            }
        }

        /**
         * Populate Servicios dropdown in Pipeline
         */
        async function populateServiciosDropdownPipeline() {
            try {
                const serviciosData = await sheetsAPI.readSheet(CONFIG.SHEETS.SERVICIOS);
                const dropdown = document.getElementById('input-servicio');

                // Clear existing options (except first)
                dropdown.innerHTML = '<option value="">Seleccionar servicio...</option>';

                // Add only active services
                serviciosData.forEach(row => {
                    const [id, nombre, categoria, descripCorta, descripDetallada, precioBase, precioMin, precioMax, duracion, entregables, stack, requisitos, estado] = row;

                    if (estado === 'Activo' || estado === 'Beta') {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({
                            id, nombre, categoria, precioBase, precioMin, precioMax, duracion
                        });
                        option.textContent = `${nombre} - ${formatCurrency(parseFloat(precioBase) || 0)}`;
                        dropdown.appendChild(option);
                    }
                });

                // Add event listener to auto-fill valor
                dropdown.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const servicio = JSON.parse(e.target.value);
                        document.getElementById('input-valor').value = servicio.precioBase;
                    }
                });

                console.log('‚úÖ Servicios dropdown populated in Pipeline');
            } catch (error) {
                console.error('‚ùå Error populating servicios dropdown:', error);
            }
        }

        /**
         * Populate Contactos dropdown in Pipeline
         */
        async function populateContactosDropdownPipeline() {
            try {
                const contactosData = await sheetsAPI.readSheet(CONFIG.SHEETS.CONTACTOS);
                const dropdown = document.getElementById('input-contacto');

                // Clear existing options (except first)
                dropdown.innerHTML = '<option value="">Seleccionar contacto...</option>';

                // Add all contactos
                contactosData.forEach(row => {
                    const [id, nombre, email, telefono, empresa, cargo, tipo] = row;

                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        id, nombre, email, telefono, empresa
                    });
                    option.textContent = `${nombre} - ${empresa}`;
                    dropdown.appendChild(option);
                });

                // Add event listener to auto-populate contact fields
                dropdown.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const contacto = JSON.parse(e.target.value);
                        document.getElementById('input-lead').value = contacto.nombre || '';
                        document.getElementById('input-empresa').value = contacto.empresa || '';
                        document.getElementById('input-email').value = contacto.email || '';
                        document.getElementById('input-telefono').value = contacto.telefono || '';
                    } else {
                        // Clear fields if no contacto selected
                        document.getElementById('input-lead').value = '';
                        document.getElementById('input-empresa').value = '';
                        document.getElementById('input-email').value = '';
                        document.getElementById('input-telefono').value = '';
                    }
                });

                console.log('‚úÖ Contactos dropdown populated in Pipeline');
            } catch (error) {
                console.error('‚ùå Error populating contactos dropdown:', error);
            }
        }

        /**
         * Populate Promotores dropdown in Pipeline and add Fuente change listener
         */
        async function populatePromotoresDropdownPipeline() {
            try {
                const promotoresData = await sheetsAPI.readSheet(CONFIG.SHEETS.PROMOTORES);
                const dropdown = document.getElementById('input-promotor');
                const fuenteSelect = document.getElementById('input-fuente');
                const promotorField = document.getElementById('promotor-field');

                // Clear existing options (except first)
                dropdown.innerHTML = '<option value="">Seleccionar promotor...</option>';

                // Add only active promotores
                promotoresData.forEach(row => {
                    const [id, nombre, email, telefono, estado, comision] = row;

                    if (estado === 'Activo') {
                        const option = document.createElement('option');
                        option.value = nombre;
                        option.textContent = `${nombre} (${comision}%)`;
                        dropdown.appendChild(option);
                    }
                });

                // Add event listener to show/hide Promotor field based on Fuente
                fuenteSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'Referido') {
                        promotorField.classList.remove('hidden');
                        dropdown.setAttribute('required', 'required');
                    } else {
                        promotorField.classList.add('hidden');
                        dropdown.removeAttribute('required');
                        dropdown.value = ''; // Clear selection
                    }
                });

                console.log('‚úÖ Promotores dropdown populated in Pipeline');
            } catch (error) {
                console.error('‚ùå Error populating promotores dropdown:', error);
            }
        }

        // ====================
        // PROYECTOS VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allProyectosData = [];

        /**
         * Load and render Proyectos data
         */
        async function loadProyectosView() {
            try {
                console.log('üìä Loading Proyectos view...');

                const proyectosData = await sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS);
                allProyectosData = proyectosData || [];
                renderProyectosTable(allProyectosData);

                // Populate dropdowns
                await populatePipelineDropdownProyectos();

                console.log('‚úÖ Proyectos view loaded');
            } catch (error) {
                console.error('‚ùå Error loading Proyectos:', error);
                showToast('Error al cargar Proyectos', 'error');
            }
        }

        /**
         * Filter Proyectos table by search term
         */
        function filterProyectosTable(searchTerm) {
            if (!searchTerm) {
                renderProyectosTable(allProyectosData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allProyectosData.filter(row => {
                // Updated structure: ID, PipelineID, Nombre, Cliente, Empresa...
                const [id, pipelineId, nombre, cliente, empresa] = row;
                return (
                    (nombre && nombre.toLowerCase().includes(searchLower)) ||
                    (cliente && cliente.toLowerCase().includes(searchLower)) ||
                    (empresa && empresa.toLowerCase().includes(searchLower))
                );
            });
            renderProyectosTable(filtered);
        }

        /**
         * Render Proyectos table
         */
        function renderProyectosTable(data) {
            const tbody = document.getElementById('table-proyectos-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No hay proyectos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                // Updated structure: ID, PipelineID, Nombre, Cliente, Empresa, Email, Tel√©fono, TipoProyecto, Estado, Fase, FechaInicio, FechaEntregaEst, FechaEntregaReal, Valor, Progreso, Repositorio, DeployURL, DriveFolder, Notas, FechaActualizaci√≥n
                const [id, pipelineId, nombre, cliente, empresa, email, telefono, tipoProyecto, estado, fase, fechaInicio, fechaEntregaEst, fechaEntregaReal, valor, progreso, repositorio, deployURL, driveFolder, notas] = row;

                // Generate badge colors
                const estadoBadge = getBadge(estado, getProyectoEstadoColor(estado));
                const faseBadge = getBadge(fase, 'blue');

                // Show invoice buttons based on project progress
                const progresoNum = parseFloat(progreso) || 0;
                const anticipoBtn = `<button onclick='generateAnticipoFromProject(${JSON.stringify(row)})' class="text-green-600 hover:text-green-800" title="Generar factura anticipo 50%">üí∞</button>`;
                const saldoBtn = progresoNum >= 90 ? `<button onclick='generateSaldoFromProject(${JSON.stringify(row)})' class="text-purple-600 hover:text-purple-800" title="Generar factura saldo 50%">üíµ</button>` : '';
                const driveFolderBtn = driveFolder ? `<a href="${driveFolder}" target="_blank" class="text-yellow-600 hover:text-yellow-800" title="Abrir carpeta Google Drive">üìÅ</a>` : '';
                const deleteBtn = sessionManager.isSuperAdmin() ?
                    `<button onclick="deleteProyecto(${index + 2})" class="text-red-600 hover:text-red-800" title="Eliminar">üóëÔ∏è</button>` : '';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${nombre || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${empresa || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${tipoProyecto || '-'}</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm">${faseBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(valor) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${progreso}%</td>
                        <td class="px-4 py-3 text-sm text-right space-x-1">
                            ${driveFolderBtn}
                            ${anticipoBtn}
                            ${saldoBtn}
                            <button onclick='editProyecto(${index + 2}, ${JSON.stringify(row)})' class="text-blue-600 hover:text-blue-800" title="Editar">‚úèÔ∏è</button>
                            ${deleteBtn}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get proyecto estado color
         */
        function getProyectoEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'green';
                case 'Pausado': return 'yellow';
                case 'Completado': return 'blue';
                case 'Cancelado': return 'red';
                default: return 'gray';
            }
        }

        /**
         * Populate Pipeline dropdown in Proyectos (only Ganado leads)
         */
        async function populatePipelineDropdownProyectos() {
            try {
                const pipelineData = await sheetsAPI.readSheet(CONFIG.SHEETS.PIPELINE);
                const dropdown = document.getElementById('input-proyecto-pipeline');

                // Clear existing options (except first)
                dropdown.innerHTML = '<option value="">Seleccionar lead ganado...</option>';

                // Add only Ganado leads
                pipelineData.forEach(row => {
                    // Structure: ID, ContactoID, Nombre, Empresa, Email, Tel√©fono, Etapa, Valor, Probabilidad, FechaContacto, FechaCierre, Estado...
                    const [id, contactoId, nombre, empresa, email, telefono, etapa, valor, probabilidad, fechaContacto, fechaCierre, estado] = row;

                    if (estado === 'Ganado') {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({
                            id, nombre, empresa, email, telefono, valor
                        });
                        option.textContent = `${id} - ${nombre} (${empresa})`;
                        dropdown.appendChild(option);
                    }
                });

                // Add event listener to auto-populate fields from Pipeline
                dropdown.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const pipeline = JSON.parse(e.target.value);
                        document.getElementById('input-proyecto-nombre').value = `Proyecto ${pipeline.empresa}`;
                        document.getElementById('input-proyecto-cliente').value = pipeline.nombre || '';
                        document.getElementById('input-proyecto-empresa').value = pipeline.empresa || '';
                        document.getElementById('input-proyecto-email').value = pipeline.email || '';
                        document.getElementById('input-proyecto-telefono').value = pipeline.telefono || '';
                        document.getElementById('input-proyecto-valor').value = pipeline.valor || '';
                    } else {
                        // Clear fields if no pipeline selected
                        document.getElementById('input-proyecto-nombre').value = '';
                        document.getElementById('input-proyecto-cliente').value = '';
                        document.getElementById('input-proyecto-empresa').value = '';
                        document.getElementById('input-proyecto-email').value = '';
                        document.getElementById('input-proyecto-telefono').value = '';
                        document.getElementById('input-proyecto-valor').value = '';
                    }
                });

                console.log('‚úÖ Pipeline dropdown populated in Proyectos');
            } catch (error) {
                console.error('‚ùå Error populating pipeline dropdown:', error);
            }
        }

        /**
         * Generate Proyecto ID
         */
        function generateProyectoId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PRJ-${year}-${random}`;
        }

        /**
         * Handle Proyectos form submission
         */
        async function handleProyectosSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateProyectoId();
                const pipelineSelect = document.getElementById('input-proyecto-pipeline').value;

                // Validate pipeline selection
                if (!pipelineSelect) {
                    showToast('Debes seleccionar un lead del Pipeline', 'error');
                    return;
                }

                const pipelineData = JSON.parse(pipelineSelect);
                const pipelineId = pipelineData.id;

                const nombre = document.getElementById('input-proyecto-nombre').value;
                const cliente = document.getElementById('input-proyecto-cliente').value;
                const empresa = document.getElementById('input-proyecto-empresa').value;
                const emailCliente = document.getElementById('input-proyecto-email').value;
                const telefonoCliente = document.getElementById('input-proyecto-telefono').value;
                const tipoProyecto = document.getElementById('input-proyecto-tipo').value;
                const estado = document.getElementById('input-proyecto-estado').value;
                const fase = document.getElementById('input-proyecto-fase').value;
                const fechaInicio = document.getElementById('input-proyecto-fecha-inicio').value;
                const fechaEntregaEst = document.getElementById('input-proyecto-fecha-entrega-est').value;
                const fechaEntregaReal = document.getElementById('input-proyecto-fecha-entrega-real').value;
                const valor = document.getElementById('input-proyecto-valor').value;
                const progreso = document.getElementById('input-proyecto-progreso').value;
                const repositorio = document.getElementById('input-proyecto-repositorio')?.value || '';
                const deployURL = document.getElementById('input-proyecto-deploy')?.value || '';
                const driveFolder = document.getElementById('input-proyecto-drive')?.value || '';
                const notas = document.getElementById('input-proyecto-notas').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data (20 columns A-T)
                const rowData = [[
                    id,                     // A: ID
                    pipelineId,            // B: Pipeline ID
                    nombre,                // C: Nombre
                    cliente,               // D: Cliente
                    empresa,               // E: Empresa
                    emailCliente,          // F: Email Cliente
                    telefonoCliente,       // G: Tel√©fono Cliente
                    tipoProyecto,          // H: Tipo Proyecto
                    estado,                // I: Estado
                    fase,                  // J: Fase
                    fechaInicio,           // K: Fecha Inicio
                    fechaEntregaEst,       // L: Fecha Entrega Estimada
                    fechaEntregaReal,      // M: Fecha Entrega Real
                    valor,                 // N: Valor
                    progreso,              // O: Progreso
                    repositorio,           // P: Repositorio
                    deployURL,             // Q: Deploy URL
                    driveFolder,           // R: Drive Folder
                    notas,                 // S: Notas
                    fechaActualizacion     // T: Fecha Actualizaci√≥n
                ]];

                if (isEditing) {
                    // Update existing row (20 columns A-T)
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.PROYECTOS, `A${editRow}:T${editRow}`, rowData);
                    showToast('Proyecto actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.PROYECTOS, rowData);
                    showToast('Proyecto guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-proyectos').reset();
                submitBtn.textContent = 'Guardar Proyecto';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadProyectosView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error saving proyecto:', error);
                showToast('Error al guardar proyecto', 'error');
            }
        }

        /**
         * Edit Proyecto
         */
        function editProyecto(rowNumber, rowData) {
            // Updated structure: ID, PipelineID, Nombre, Cliente, Empresa, Email, Tel√©fono, TipoProyecto, Estado, Fase, FechaInicio, FechaEntregaEst, FechaEntregaReal, Valor, Progreso, Repositorio, DeployURL, DriveFolder, Notas
            const [id, pipelineId, nombre, cliente, empresa, emailCliente, telefonoCliente, tipoProyecto, estado, fase, fechaInicio, fechaEntregaEst, fechaEntregaReal, valor, progreso, repositorio, deployURL, driveFolder, notas] = rowData;

            // Scroll to form
            document.getElementById('form-proyectos').scrollIntoView({ behavior: 'smooth' });

            // Pre-select pipeline (need to match by pipelineId)
            const pipelineDropdown = document.getElementById('input-proyecto-pipeline');
            for (let option of pipelineDropdown.options) {
                if (option.value) {
                    const optionData = JSON.parse(option.value);
                    if (optionData.id === pipelineId) {
                        pipelineDropdown.value = option.value;
                        // Trigger change to auto-populate fields
                        pipelineDropdown.dispatchEvent(new Event('change'));
                        break;
                    }
                }
            }

            // Pre-fill other form fields
            document.getElementById('input-proyecto-nombre').value = nombre || '';
            document.getElementById('input-proyecto-tipo').value = tipoProyecto || '';
            document.getElementById('input-proyecto-estado').value = estado || '';
            document.getElementById('input-proyecto-fase').value = fase || '';
            document.getElementById('input-proyecto-fecha-inicio').value = fechaInicio || '';
            document.getElementById('input-proyecto-fecha-entrega-est').value = fechaEntregaEst || '';
            document.getElementById('input-proyecto-fecha-entrega-real').value = fechaEntregaReal || '';
            document.getElementById('input-proyecto-progreso').value = progreso || '';
            document.getElementById('input-proyecto-repositorio').value = repositorio || '';
            document.getElementById('input-proyecto-deploy').value = deployURL || '';
            document.getElementById('input-proyecto-drive').value = driveFolder || '';
            document.getElementById('input-proyecto-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-proyectos button[type="submit"]');
            submitBtn.textContent = 'Actualizar Proyecto';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
        }

        /**
         * Delete Proyecto
         */
        async function deleteProyecto(rowNumber) {
            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar este proyecto?')) {
                return;
            }

            try {
                await sheetsAPI.deleteRow(CONFIG.SHEETS.PROYECTOS, rowNumber);

                showToast('Proyecto eliminado exitosamente', 'success');

                // Reload table
                await loadProyectosView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error deleting proyecto:', error);
                showToast('Error al eliminar proyecto', 'error');
            }
        }

        // ====================
        // FACTURACI√ìN VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allFacturacionData = [];

        /**
         * Load and render Facturaci√≥n data
         */
        async function loadFacturacionView() {
            try {
                console.log('üìä Loading Facturaci√≥n view...');

                const facturacionData = await sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION);
                allFacturacionData = facturacionData || [];
                renderFacturacionTable(allFacturacionData);

                console.log('‚úÖ Facturaci√≥n view loaded');
            } catch (error) {
                console.error('‚ùå Error loading Facturaci√≥n:', error);
                showToast('Error al cargar Facturaci√≥n', 'error');
            }
        }

        /**
         * Filter Facturaci√≥n table by search term
         */
        function filterFacturacionTable(searchTerm) {
            if (!searchTerm) {
                renderFacturacionTable(allFacturacionData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allFacturacionData.filter(row => {
                const [id, proyecto, cliente] = row;
                return (
                    (proyecto && proyecto.toLowerCase().includes(searchLower)) ||
                    (cliente && cliente.toLowerCase().includes(searchLower))
                );
            });
            renderFacturacionTable(filtered);
        }

        /**
         * Render Facturaci√≥n table
         */
        function renderFacturacionTable(data) {
            const tbody = document.getElementById('table-facturacion-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No hay facturas registradas</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, proyecto, cliente, monto, iva, montoTotal, fechaEmision, fechaVencimiento, fechaPago, estado, metodoPago, referencia, notas, tipoFactura, porcentajeProyecto] = row;

                // Generate badge colors
                const estadoBadge = getBadge(estado, getFacturaEstadoColor(estado));
                const tipoBadge = getTipoFacturaBadge(tipoFactura || '√önica 100%');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${id || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${proyecto || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${cliente || '-'}</td>
                        <td class="px-4 py-3 text-sm">${tipoBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(montoTotal) || 0)}</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${fechaEmision || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${fechaVencimiento || '-'}</td>
                        <td class="px-4 py-3 text-sm text-right space-x-1">
                            <button onclick='editFactura(${index + 2}, ${JSON.stringify(row)})' class="text-blue-600 hover:text-blue-800" title="Editar">‚úèÔ∏è</button>
                            ${sessionManager.isSuperAdmin() ? `<button onclick="deleteFactura(${index + 2})" class="text-red-600 hover:text-red-800" title="Eliminar">üóëÔ∏è</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get factura estado color
         */
        function getFacturaEstadoColor(estado) {
            switch (estado) {
                case 'Pendiente': return 'yellow';
                case 'Pagada': return 'green';
                case 'Vencida': return 'red';
                case 'Cancelada': return 'gray';
                default: return 'gray';
            }
        }

        /**
         * Get tipo factura badge
         */
        function getTipoFacturaBadge(tipo) {
            const badges = {
                'Anticipo 50%': getBadge('Anticipo 50%', 'blue'),
                'Saldo 50%': getBadge('Saldo 50%', 'green'),
                '√önica 100%': getBadge('√önica 100%', 'gray'),
                'Personalizada': getBadge('Personalizada', 'yellow')
            };
            return badges[tipo] || getBadge(tipo, 'gray');
        }

        /**
         * Generate Factura ID
         */
        function generateFacturaId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `FAC-${year}-${random}`;
        }

        /**
         * Calculate Monto Total (Monto + IVA)
         */
        function calculateMontoTotal() {
            const monto = parseFloat(document.getElementById('input-factura-monto').value) || 0;
            const iva = parseFloat(document.getElementById('input-factura-iva').value) || 0;
            const montoTotal = monto + (monto * iva / 100);
            document.getElementById('input-factura-total').value = formatCurrency(montoTotal);
            return montoTotal;
        }

        /**
         * Handle Facturaci√≥n form submission
         */
        async function handleFacturacionSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateFacturaId();
                const proyecto = document.getElementById('input-factura-proyecto').value;
                const cliente = document.getElementById('input-factura-cliente').value;
                const tipoFactura = document.getElementById('input-factura-tipo').value;
                const porcentajeProyecto = document.getElementById('input-factura-porcentaje').value;
                const monto = document.getElementById('input-factura-monto').value;
                const iva = document.getElementById('input-factura-iva').value;
                const montoTotal = calculateMontoTotal();
                const fechaEmision = document.getElementById('input-factura-fecha-emision').value;
                const fechaVencimiento = document.getElementById('input-factura-fecha-vencimiento').value;
                const fechaPago = document.getElementById('input-factura-fecha-pago').value;
                const estado = document.getElementById('input-factura-estado').value;
                const metodoPago = document.getElementById('input-factura-metodo').value;
                const referencia = document.getElementById('input-factura-referencia').value;
                const notas = document.getElementById('input-factura-notas').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // ====================
                // VALIDATION: Check total % invoiced doesn't exceed 100%
                // ====================
                const allFacturas = await sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION);
                let totalPorcentajeFacturado = 0;

                allFacturas.forEach(row => {
                    const facProyecto = row[1]; // Column B: Proyecto
                    const facId = row[0]; // Column A: ID
                    const facPorcentaje = parseFloat(row[14]) || 0; // Column O: % Proyecto

                    // Sum percentages for same project, excluding current invoice if editing
                    if (facProyecto === proyecto && facId !== id) {
                        totalPorcentajeFacturado += facPorcentaje;
                    }
                });

                const nuevoPorcentaje = parseFloat(porcentajeProyecto) || 0;
                const totalFinal = totalPorcentajeFacturado + nuevoPorcentaje;

                if (totalFinal > 100) {
                    showToast(`‚ö†Ô∏è Error: El proyecto "${proyecto}" ya tiene ${totalPorcentajeFacturado}% facturado. No puedes agregar ${nuevoPorcentaje}% m√°s (total: ${totalFinal}%). M√°ximo permitido: 100%`, 'error');
                    return;
                }

                // Create row data (15 columns A-P)
                const rowData = [[
                    id,
                    proyecto,
                    cliente,
                    monto,
                    iva,
                    montoTotal,
                    fechaEmision,
                    fechaVencimiento,
                    fechaPago,
                    estado,
                    metodoPago,
                    referencia,
                    notas,
                    tipoFactura,
                    porcentajeProyecto,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.FACTURACION, `A${editRow}:P${editRow}`, rowData);
                    showToast('Factura actualizada exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.FACTURACION, rowData);
                    showToast('Factura guardada exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-facturacion').reset();
                document.getElementById('input-factura-total').value = '';
                submitBtn.textContent = 'Guardar Factura';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadFacturacionView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error saving factura:', error);
                showToast('Error al guardar factura', 'error');
            }
        }

        /**
         * Edit Factura
         */
        function editFactura(rowNumber, rowData) {
            const [id, proyecto, cliente, monto, iva, montoTotal, fechaEmision, fechaVencimiento, fechaPago, estado, metodoPago, referencia, notas, tipoFactura, porcentajeProyecto] = rowData;

            // Scroll to form
            document.getElementById('form-facturacion').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-factura-proyecto').value = proyecto || '';
            document.getElementById('input-factura-cliente').value = cliente || '';
            document.getElementById('input-factura-tipo').value = tipoFactura || '';
            document.getElementById('input-factura-porcentaje').value = porcentajeProyecto || '50';
            document.getElementById('input-factura-monto').value = monto || '';
            document.getElementById('input-factura-iva').value = iva || '';
            document.getElementById('input-factura-total').value = montoTotal || '';
            document.getElementById('input-factura-fecha-emision').value = fechaEmision || '';
            document.getElementById('input-factura-fecha-vencimiento').value = fechaVencimiento || '';
            document.getElementById('input-factura-fecha-pago').value = fechaPago || '';
            document.getElementById('input-factura-estado').value = estado || '';
            document.getElementById('input-factura-metodo').value = metodoPago || '';
            document.getElementById('input-factura-referencia').value = referencia || '';
            document.getElementById('input-factura-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-facturacion button[type="submit"]');
            submitBtn.textContent = 'Actualizar Factura';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
        }

        /**
         * Delete Factura
         */
        async function deleteFactura(rowNumber) {
            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar esta factura?')) {
                return;
            }

            try {
                await sheetsAPI.deleteRow(CONFIG.SHEETS.FACTURACION, rowNumber);

                showToast('Factura eliminada exitosamente', 'success');

                // Reload table
                await loadFacturacionView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error deleting factura:', error);
                showToast('Error al eliminar factura', 'error');
            }
        }

        // ====================
        // CONTACTOS VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allContactosData = [];

        /**
         * Load Contactos View
         */
        async function loadContactosView() {
            try {
                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.CONTACTOS, 'A2:O');
                allContactosData = data || [];
                renderContactosTable(allContactosData);
            } catch (error) {
                console.error('‚ùå Error loading contactos:', error);
                showToast('Error al cargar contactos', 'error');
            }
        }

        /**
         * Filter Contactos table by search term
         */
        function filterContactosTable(searchTerm) {
            if (!searchTerm) {
                renderContactosTable(allContactosData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allContactosData.filter(row => {
                const [id, nombre, email, telefono, empresa] = row;
                return (
                    (nombre && nombre.toLowerCase().includes(searchLower)) ||
                    (empresa && empresa.toLowerCase().includes(searchLower)) ||
                    (email && email.toLowerCase().includes(searchLower))
                );
            });
            renderContactosTable(filtered);
        }

        /**
         * Render Contactos Table
         */
        function renderContactosTable(data) {
            const tbody = document.getElementById('table-contactos-body');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">No hay contactos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, email, telefono, empresa, cargo, tipo, fuente, linkedin, ciudad, pais] = row;
                return `
                    <tr>
                        <td class="py-3 px-4 border-b border-gray-700">${id || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${nombre || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${email || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${telefono || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${empresa || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm bg-gray-700 text-gray-300">${tipo || ''}</span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-700 space-x-1">
                            <button onclick='editContacto(${index + 2}, ${JSON.stringify(row)})' class="text-blue-400 hover:text-blue-300" title="Editar">‚úèÔ∏è</button>
                            ${sessionManager.isSuperAdmin() ? `<button onclick="deleteContacto(${index + 2})" class="text-red-400 hover:text-red-300" title="Eliminar">üóëÔ∏è</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Generate Contacto ID
         */
        function generateContactoId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `CON-${year}-${random}`;
        }

        /**
         * Handle Contactos form submission
         */
        async function handleContactosSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateContactoId();
                const nombre = document.getElementById('input-contacto-nombre').value;
                const email = document.getElementById('input-contacto-email').value;
                const telefono = document.getElementById('input-contacto-telefono').value;
                const empresa = document.getElementById('input-contacto-empresa').value;
                const cargo = document.getElementById('input-contacto-cargo').value;
                const tipo = document.getElementById('input-contacto-tipo').value;
                const fuente = document.getElementById('input-contacto-fuente').value;
                const linkedin = document.getElementById('input-contacto-linkedin').value;
                const ciudad = document.getElementById('input-contacto-ciudad').value;
                const pais = document.getElementById('input-contacto-pais').value;
                const tags = document.getElementById('input-contacto-tags').value;
                const notas = document.getElementById('input-contacto-notas').value;
                const fechaCreacion = isEditing ? editRow.fechaCreacion : new Date().toISOString().slice(0, 19).replace('T', ' ');
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data (15 columns A-O)
                const rowData = [[
                    id,
                    nombre,
                    email,
                    telefono,
                    empresa,
                    cargo,
                    tipo,
                    fuente,
                    linkedin,
                    ciudad,
                    pais,
                    tags,
                    notas,
                    fechaCreacion,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.CONTACTOS, `A${editRow}:O${editRow}`, rowData);
                    showToast('Contacto actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.CONTACTOS, rowData);
                    showToast('Contacto guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-contactos').reset();
                submitBtn.textContent = 'Guardar Contacto';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadContactosView();

            } catch (error) {
                console.error('‚ùå Error saving contacto:', error);
                showToast('Error al guardar contacto', 'error');
            }
        }

        /**
         * Edit Contacto
         */
        function editContacto(rowNumber, rowData) {
            const [id, nombre, email, telefono, empresa, cargo, tipo, fuente, linkedin, ciudad, pais, tags, notas, fechaCreacion] = rowData;

            // Scroll to form
            document.getElementById('form-contactos').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-contacto-nombre').value = nombre || '';
            document.getElementById('input-contacto-email').value = email || '';
            document.getElementById('input-contacto-telefono').value = telefono || '';
            document.getElementById('input-contacto-empresa').value = empresa || '';
            document.getElementById('input-contacto-cargo').value = cargo || '';
            document.getElementById('input-contacto-tipo').value = tipo || '';
            document.getElementById('input-contacto-fuente').value = fuente || '';
            document.getElementById('input-contacto-linkedin').value = linkedin || '';
            document.getElementById('input-contacto-ciudad').value = ciudad || '';
            document.getElementById('input-contacto-pais').value = pais || '';
            document.getElementById('input-contacto-tags').value = tags || '';
            document.getElementById('input-contacto-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-contactos button[type="submit"]');
            submitBtn.textContent = 'Actualizar Contacto';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
            submitBtn.setAttribute('data-fecha-creacion', fechaCreacion);
        }

        /**
         * Delete Contacto
         */
        async function deleteContacto(rowNumber) {
            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar este contacto?')) {
                return;
            }

            try {
                await sheetsAPI.deleteRow(CONFIG.SHEETS.CONTACTOS, rowNumber);

                showToast('Contacto eliminado exitosamente', 'success');

                // Reload table
                await loadContactosView();

            } catch (error) {
                console.error('‚ùå Error deleting contacto:', error);
                showToast('Error al eliminar contacto', 'error');
            }
        }

        // ====================
        // PROMOTORES VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allPromotoresData = [];

        /**
         * Load Promotores View
         */
        async function loadPromotoresView() {
            try {
                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROMOTORES, 'A2:Q');
                allPromotoresData = data || [];
                renderPromotoresTable(allPromotoresData);
            } catch (error) {
                console.error('‚ùå Error loading promotores:', error);
                showToast('Error al cargar promotores', 'error');
            }
        }

        /**
         * Filter Promotores table by search term
         */
        function filterPromotoresTable(searchTerm) {
            if (!searchTerm) {
                renderPromotoresTable(allPromotoresData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allPromotoresData.filter(row => {
                const [id, nombre] = row;
                return (nombre && nombre.toLowerCase().includes(searchLower));
            });
            renderPromotoresTable(filtered);
        }

        /**
         * Render Promotores Table
         */
        function renderPromotoresTable(data) {
            const tbody = document.getElementById('table-promotores-body');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">No hay promotores registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, email, telefono, estado, comision] = row;
                const estadoColor = getPromotorEstadoColor(estado);
                return `
                    <tr>
                        <td class="py-3 px-4 border-b border-gray-700">${id || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${nombre || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${email || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${telefono || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm bg-${estadoColor}-500/20 text-${estadoColor}-400">${estado || ''}</span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-700">${comision || '0'}%</td>
                        <td class="py-3 px-4 border-b border-gray-700 space-x-1">
                            <button onclick='editPromotor(${index + 2}, ${JSON.stringify(row)})' class="text-blue-400 hover:text-blue-300" title="Editar">‚úèÔ∏è</button>
                            ${sessionManager.isSuperAdmin() ? `<button onclick="deletePromotor(${index + 2})" class="text-red-400 hover:text-red-300" title="Eliminar">üóëÔ∏è</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get Promotor Estado Color
         */
        function getPromotorEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'green';
                case 'Inactivo': return 'gray';
                case 'Suspendido': return 'red';
                default: return 'gray';
            }
        }

        /**
         * Generate Promotor ID
         */
        function generatePromotorId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PROM-${year}-${random}`;
        }

        /**
         * Handle Promotores form submission
         */
        async function handlePromotoresSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generatePromotorId();
                const nombre = document.getElementById('input-promotor-nombre').value;
                const email = document.getElementById('input-promotor-email').value;
                const telefono = document.getElementById('input-promotor-telefono').value;
                const estado = document.getElementById('input-promotor-estado').value;
                const comision = document.getElementById('input-promotor-comision').value;
                const banco = document.getElementById('input-promotor-banco').value;
                const cuenta = document.getElementById('input-promotor-cuenta').value;
                const notas = document.getElementById('input-promotor-notas').value;
                const fechaCreacion = isEditing ? submitBtn.getAttribute('data-fecha-creacion') : new Date().toISOString().slice(0, 19).replace('T', ' ');
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Initialize or preserve metrics (17 columns A-Q)
                const referidosActivos = isEditing ? (submitBtn.getAttribute('data-referidos') || '0') : '0';
                const proyectosGanados = isEditing ? (submitBtn.getAttribute('data-proyectos') || '0') : '0';
                const tasaConversion = isEditing ? (submitBtn.getAttribute('data-tasa') || '0%') : '0%';
                const comisionTotal = isEditing ? (submitBtn.getAttribute('data-total') || '$0') : '$0';
                const comisionPagada = isEditing ? (submitBtn.getAttribute('data-pagada') || '$0') : '$0';
                const comisionPendiente = isEditing ? (submitBtn.getAttribute('data-pendiente') || '$0') : '$0';

                // Create row data
                const rowData = [[
                    id,
                    nombre,
                    email,
                    telefono,
                    estado,
                    comision,
                    referidosActivos,
                    proyectosGanados,
                    tasaConversion,
                    comisionTotal,
                    comisionPagada,
                    comisionPendiente,
                    banco,
                    cuenta,
                    notas,
                    fechaCreacion,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.PROMOTORES, `A${editRow}:Q${editRow}`, rowData);
                    showToast('Promotor actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.PROMOTORES, rowData);
                    showToast('Promotor guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-promotores').reset();
                submitBtn.textContent = 'Guardar Promotor';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');
                submitBtn.removeAttribute('data-fecha-creacion');
                submitBtn.removeAttribute('data-referidos');
                submitBtn.removeAttribute('data-proyectos');
                submitBtn.removeAttribute('data-tasa');
                submitBtn.removeAttribute('data-total');
                submitBtn.removeAttribute('data-pagada');
                submitBtn.removeAttribute('data-pendiente');

                // Reload table
                await loadPromotoresView();

            } catch (error) {
                console.error('‚ùå Error saving promotor:', error);
                showToast('Error al guardar promotor', 'error');
            }
        }

        /**
         * Edit Promotor
         */
        function editPromotor(rowNumber, rowData) {
            const [id, nombre, email, telefono, estado, comision, referidosActivos, proyectosGanados, tasaConversion, comisionTotal, comisionPagada, comisionPendiente, banco, cuenta, notas, fechaCreacion] = rowData;

            // Scroll to form
            document.getElementById('form-promotores').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-promotor-nombre').value = nombre || '';
            document.getElementById('input-promotor-email').value = email || '';
            document.getElementById('input-promotor-telefono').value = telefono || '';
            document.getElementById('input-promotor-estado').value = estado || '';
            document.getElementById('input-promotor-comision').value = comision || '';
            document.getElementById('input-promotor-banco').value = banco || '';
            document.getElementById('input-promotor-cuenta').value = cuenta || '';
            document.getElementById('input-promotor-notas').value = notas || '';

            // Change button text and add data attributes
            const submitBtn = document.querySelector('#form-promotores button[type="submit"]');
            submitBtn.textContent = 'Actualizar Promotor';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
            submitBtn.setAttribute('data-fecha-creacion', fechaCreacion);
            submitBtn.setAttribute('data-referidos', referidosActivos);
            submitBtn.setAttribute('data-proyectos', proyectosGanados);
            submitBtn.setAttribute('data-tasa', tasaConversion);
            submitBtn.setAttribute('data-total', comisionTotal);
            submitBtn.setAttribute('data-pagada', comisionPagada);
            submitBtn.setAttribute('data-pendiente', comisionPendiente);
        }

        /**
         * Delete Promotor
         */
        async function deletePromotor(rowNumber) {
            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar este promotor?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteRow(CONFIG.SHEETS.PROMOTORES, rowNumber);

                showToast('Promotor eliminado exitosamente', 'success');

                // Reload table
                await loadPromotoresView();

            } catch (error) {
                console.error('‚ùå Error deleting promotor:', error);
                showToast('Error al eliminar promotor', 'error');
            }
        }

        // ====================
        // SERVICIOS VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allServiciosData = [];

        /**
         * Generate Servicio ID
         */
        function generateServicioId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `SRV-${year}-${random}`;
        }

        /**
         * Load Servicios View
         */
        async function loadServiciosView() {
            try {
                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.SERVICIOS);
                allServiciosData = data || [];
                renderServiciosTable(allServiciosData);
            } catch (error) {
                console.error('‚ùå Error loading servicios:', error);
                showToast('Error al cargar servicios', 'error');
            }
        }

        /**
         * Filter Servicios table by search term
         */
        function filterServiciosTable(searchTerm) {
            if (!searchTerm.trim()) {
                renderServiciosTable(allServiciosData);
                return;
            }

            const term = searchTerm.toLowerCase();
            const filtered = allServiciosData.filter(row => {
                const [id, nombre, categoria, descripCorta] = row;
                return (nombre || '').toLowerCase().includes(term) ||
                       (categoria || '').toLowerCase().includes(term) ||
                       (descripCorta || '').toLowerCase().includes(term);
            });

            renderServiciosTable(filtered);
        }

        /**
         * Render Servicios Table
         */
        function renderServiciosTable(data) {
            const tbody = document.getElementById('servicios-table-body');

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            No hay servicios registrados a√∫n
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, categoria, descripCorta, descripDetallada, precioBase, precioMin, precioMax, duracion, entregables, stack, requisitos, estado, incluyeSoporte, mesesSoporte, notasInternas] = row;

                const estadoBadge = getBadge(estado, estado === 'Activo' ? 'green' : estado === 'Beta' ? 'yellow' : estado === 'Pr√≥ximamente' ? 'blue' : 'gray');
                const soporteIcon = incluyeSoporte === 'S√≠' ? `‚úÖ ${mesesSoporte || 0}m` : '‚ùå';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${nombre || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${getBadge(categoria, 'blue')}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(precioBase) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${duracion || '-'} d√≠as</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${soporteIcon}</td>
                        <td class="px-4 py-3 text-sm text-right space-x-1">
                            <button onclick='editServicio(${index + 2}, ${JSON.stringify(row)})' class="text-blue-600 hover:text-blue-800" title="Editar">‚úèÔ∏è</button>
                            ${sessionManager.isSuperAdmin() ? `<button onclick="deleteServicio(${index + 2})" class="text-red-600 hover:text-red-800" title="Eliminar">üóëÔ∏è</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Handle Servicios form submission
         */
        async function handleServiciosSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateServicioId();
                const nombre = document.getElementById('input-servicio-nombre').value;
                const categoria = document.getElementById('input-servicio-categoria').value;
                const descripCorta = document.getElementById('input-servicio-descripcion-corta').value;
                const descripDetallada = document.getElementById('input-servicio-descripcion-detallada').value;
                const precioBase = document.getElementById('input-servicio-precio-base').value;
                const precioMin = document.getElementById('input-servicio-precio-min').value;
                const precioMax = document.getElementById('input-servicio-precio-max').value;
                const duracion = document.getElementById('input-servicio-duracion').value;
                const entregables = document.getElementById('input-servicio-entregables').value;
                const stack = document.getElementById('input-servicio-stack').value;
                const requisitos = document.getElementById('input-servicio-requisitos').value;
                const estado = document.getElementById('input-servicio-estado').value;
                const incluyeSoporte = document.getElementById('input-servicio-incluye-soporte').value;
                const mesesSoporte = document.getElementById('input-servicio-meses-soporte').value;
                const notasInternas = document.getElementById('input-servicio-notas').value;
                const fechaCreacion = isEditing ? '' : new Date().toISOString().slice(0, 19).replace('T', ' ');
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data (18 columns A-R)
                const rowData = [[
                    id,
                    nombre,
                    categoria,
                    descripCorta,
                    descripDetallada,
                    precioBase,
                    precioMin,
                    precioMax,
                    duracion,
                    entregables,
                    stack,
                    requisitos,
                    estado,
                    incluyeSoporte,
                    mesesSoporte,
                    notasInternas,
                    fechaCreacion || fechaActualizacion, // Q: Fecha Creaci√≥n
                    fechaActualizacion // R: Fecha Actualizaci√≥n
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.SERVICIOS, `A${editRow}:R${editRow}`, rowData);
                    showToast('Servicio actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.SERVICIOS, rowData);
                    showToast('Servicio guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-servicios').reset();
                submitBtn.textContent = 'Guardar Servicio';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadServiciosView();

            } catch (error) {
                console.error('‚ùå Error saving servicio:', error);
                showToast('Error al guardar servicio', 'error');
            }
        }

        /**
         * Edit Servicio
         */
        function editServicio(rowNumber, rowData) {
            const [id, nombre, categoria, descripCorta, descripDetallada, precioBase, precioMin, precioMax, duracion, entregables, stack, requisitos, estado, incluyeSoporte, mesesSoporte, notasInternas] = rowData;

            // Scroll to form
            document.getElementById('form-servicios').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-servicio-nombre').value = nombre || '';
            document.getElementById('input-servicio-categoria').value = categoria || '';
            document.getElementById('input-servicio-descripcion-corta').value = descripCorta || '';
            document.getElementById('input-servicio-descripcion-detallada').value = descripDetallada || '';
            document.getElementById('input-servicio-precio-base').value = precioBase || '';
            document.getElementById('input-servicio-precio-min').value = precioMin || '';
            document.getElementById('input-servicio-precio-max').value = precioMax || '';
            document.getElementById('input-servicio-duracion').value = duracion || '';
            document.getElementById('input-servicio-entregables').value = entregables || '';
            document.getElementById('input-servicio-stack').value = stack || '';
            document.getElementById('input-servicio-requisitos').value = requisitos || '';
            document.getElementById('input-servicio-estado').value = estado || 'Activo';
            document.getElementById('input-servicio-incluye-soporte').value = incluyeSoporte || 'No';
            document.getElementById('input-servicio-meses-soporte').value = mesesSoporte || '0';
            document.getElementById('input-servicio-notas').value = notasInternas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-servicios button[type="submit"]');
            submitBtn.textContent = 'Actualizar Servicio';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
        }

        /**
         * Delete Servicio
         */
        async function deleteServicio(rowNumber) {
            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar este servicio?')) {
                return;
            }

            try {
                await sheetsAPI.deleteRow(CONFIG.SHEETS.SERVICIOS, rowNumber);
                showToast('Servicio eliminado exitosamente', 'success');
                await loadServiciosView();
            } catch (error) {
                console.error('‚ùå Error deleting servicio:', error);
                showToast('Error al eliminar servicio', 'error');
            }
        }

        // ====================
        // USUARIOS VIEW FUNCTIONS
        // ====================

        let allUsuariosData = [];
        let isEditingUsuario = false;
        let editUsuarioRow = null;

        /**
         * Generate Usuario ID
         */
        function generateUsuarioId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `USR-${year}-${random}`;
        }

        /**
         * Generate Empresa ID (only for first Admin Local of a company)
         */
        function generateEmpresaId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `EMP-${year}-${random}`;
        }

        /**
         * Validate PIN (no repetitive patterns)
         */
        function validatePIN(pin) {
            if (!/^\d{4}$/.test(pin)) {
                return { valid: false, message: 'PIN debe ser 4 d√≠gitos' };
            }

            // Check for repetitive patterns
            if (/^(\d)\1{3}$/.test(pin)) { // 0000, 1111, etc.
                return { valid: false, message: 'PIN no puede ser repetitivo (ej: 0000, 1111)' };
            }

            return { valid: true };
        }

        /**
         * Populate Rol dropdown based on current user role
         */
        function populateRolDropdown() {
            const rolSelect = document.getElementById('input-usuario-rol');
            rolSelect.innerHTML = '<option value="">Seleccionar...</option>';

            const session = sessionManager.getSession();
            if (!session) return;

            if (sessionManager.isSuperAdmin()) {
                // Super Admin can create Admin Local, Supervisor, Usuario
                rolSelect.innerHTML += `
                    <option value="${CONFIG.ROLES.ADMIN_LOCAL}">${CONFIG.ROLES.ADMIN_LOCAL}</option>
                    <option value="${CONFIG.ROLES.SUPERVISOR}">${CONFIG.ROLES.SUPERVISOR}</option>
                    <option value="${CONFIG.ROLES.USUARIO}">${CONFIG.ROLES.USUARIO}</option>
                `;
            } else if (sessionManager.isAdminLocal()) {
                // Admin Local can only create Supervisor and Usuario
                rolSelect.innerHTML += `
                    <option value="${CONFIG.ROLES.SUPERVISOR}">${CONFIG.ROLES.SUPERVISOR}</option>
                    <option value="${CONFIG.ROLES.USUARIO}">${CONFIG.ROLES.USUARIO}</option>
                `;
            }
        }

        /**
         * Load Usuarios View
         */
        async function loadUsuariosView() {
            try {
                populateRolDropdown();

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.USUARIOS, 'A2:K');
                allUsuariosData = data || [];

                // Filter by empresa if not Super Admin
                const session = sessionManager.getSession();
                if (!sessionManager.isSuperAdmin() && session.empresaId) {
                    allUsuariosData = allUsuariosData.filter(row => row[6] === session.empresaId); // Column G: Empresa ID
                }

                renderUsuariosTable(allUsuariosData);
            } catch (error) {
                console.error('‚ùå Error loading usuarios:', error);
                showToast('Error al cargar usuarios', 'error');
            }
        }

        /**
         * Render Usuarios Table
         */
        function renderUsuariosTable(data) {
            const tbody = document.getElementById('usuarios-table-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No hay usuarios registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, email, pin, rol, estado, empresaId, permisos, creadoPor, fechaCreacion, ultimaActividad] = row;

                const rowNumber = index + 2; // +2 because of header row and 1-based index

                const estadoBadge = estado === 'Activo'
                    ? getBadge('Activo', 'green')
                    : getBadge('Inactivo', 'gray');

                const rolBadge = rol === CONFIG.ROLES.SUPER_ADMIN
                    ? getBadge(rol, 'purple')
                    : rol === CONFIG.ROLES.ADMIN_LOCAL
                    ? getBadge(rol, 'blue')
                    : rol === CONFIG.ROLES.SUPERVISOR
                    ? getBadge(rol, 'yellow')
                    : getBadge(rol, 'gray');

                const ultimaActividadFormatted = ultimaActividad
                    ? new Date(ultimaActividad).toLocaleString('es-CO', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })
                    : 'Nunca';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${nombre || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${email || '-'}</td>
                        <td class="px-4 py-3 text-sm">${rolBadge}</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${empresaId || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${ultimaActividadFormatted}</td>
                        <td class="px-4 py-3 text-sm text-right space-x-1">
                            <button onclick="editUsuario(${rowNumber}, ${JSON.stringify(row).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800" title="Editar">‚úèÔ∏è</button>
                            ${sessionManager.isSuperAdmin() ? `<button onclick="deleteUsuario(${rowNumber})" class="text-red-600 hover:text-red-800" title="Eliminar">üóëÔ∏è</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Handle Usuario Form Submit
         */
        async function handleUsuarioSubmit(event) {
            event.preventDefault();

            const session = sessionManager.getSession();
            if (!session) {
                showToast('Sesi√≥n expirada', 'error');
                return;
            }

            // Get form values
            const nombre = document.getElementById('input-usuario-nombre').value.trim();
            const email = document.getElementById('input-usuario-email').value.trim().toLowerCase();
            const pin = document.getElementById('input-usuario-pin').value.trim();
            const rol = document.getElementById('input-usuario-rol').value;
            const estado = document.getElementById('input-usuario-estado').value;
            let empresaId = document.getElementById('input-usuario-empresa').value.trim();

            // Validate PIN
            const pinValidation = validatePIN(pin);
            if (!pinValidation.valid) {
                showToast(pinValidation.message, 'error');
                return;
            }

            // Check permissions
            if (rol === CONFIG.ROLES.ADMIN_LOCAL && !sessionManager.isSuperAdmin()) {
                showToast('Solo Super Admin puede crear Admin Local', 'error');
                return;
            }

            // Handle Empresa ID
            if (rol === CONFIG.ROLES.ADMIN_LOCAL && !empresaId) {
                // Generate new empresa ID for first Admin Local
                empresaId = generateEmpresaId();
                document.getElementById('input-usuario-empresa').value = empresaId;
            } else if (!sessionManager.isSuperAdmin()) {
                // Use current user's empresa ID
                empresaId = session.empresaId;
            }

            const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

            if (isEditingUsuario) {
                // Update existing usuario
                const rowData = [[
                    allUsuariosData[editUsuarioRow - 2][0], // Keep existing ID
                    nombre,
                    email,
                    pin,
                    rol,
                    estado,
                    empresaId || '',
                    allUsuariosData[editUsuarioRow - 2][7] || '{}', // Keep existing permisos
                    allUsuariosData[editUsuarioRow - 2][8], // Keep creadoPor
                    allUsuariosData[editUsuarioRow - 2][9], // Keep fechaCreacion
                    now // Update timestamp
                ]];

                try {
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.USUARIOS, `A${editUsuarioRow}:K${editUsuarioRow}`, rowData);
                    showToast('Usuario actualizado exitosamente', 'success');

                    // Reset form
                    document.getElementById('form-usuarios').reset();
                    document.getElementById('btn-submit-usuario').textContent = 'Crear Usuario';
                    document.getElementById('btn-cancel-usuario').classList.add('hidden');
                    isEditingUsuario = false;
                    editUsuarioRow = null;

                    await loadUsuariosView();
                } catch (error) {
                    console.error('‚ùå Error updating usuario:', error);
                    showToast('Error al actualizar usuario', 'error');
                }
            } else {
                // Create new usuario
                // Check if email already exists
                const existingUser = allUsuariosData.find(row => row[2] === email);
                if (existingUser) {
                    showToast('El email ya est√° registrado', 'error');
                    return;
                }

                const id = generateUsuarioId();
                const rowData = [[
                    id,
                    nombre,
                    email,
                    pin,
                    rol,
                    estado,
                    empresaId || '',
                    '{}', // Empty permisos JSON
                    session.email, // creadoPor
                    now, // fechaCreacion
                    '' // ultimaActividad (empty until first login)
                ]];

                try {
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.USUARIOS, rowData);
                    showToast('Usuario creado exitosamente', 'success');
                    document.getElementById('form-usuarios').reset();
                    await loadUsuariosView();
                } catch (error) {
                    console.error('‚ùå Error creating usuario:', error);
                    showToast('Error al crear usuario', 'error');
                }
            }
        }

        /**
         * Edit Usuario
         */
        function editUsuario(rowNumber, rowData) {
            const [id, nombre, email, pin, rol, estado, empresaId, permisos, creadoPor, fechaCreacion, ultimaActividad] = rowData;

            // Pre-fill form
            document.getElementById('input-usuario-nombre').value = nombre || '';
            document.getElementById('input-usuario-email').value = email || '';
            document.getElementById('input-usuario-pin').value = pin || '';
            document.getElementById('input-usuario-rol').value = rol || '';
            document.getElementById('input-usuario-estado').value = estado || 'Activo';
            document.getElementById('input-usuario-empresa').value = empresaId || '';

            // Change button text
            document.getElementById('btn-submit-usuario').textContent = 'Actualizar Usuario';
            document.getElementById('btn-cancel-usuario').classList.remove('hidden');

            isEditingUsuario = true;
            editUsuarioRow = rowNumber;

            // Scroll to form
            document.getElementById('form-usuarios').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Delete Usuario
         */
        async function deleteUsuario(rowNumber) {
            const usuario = allUsuariosData[rowNumber - 2];
            const [id, nombre, email] = usuario;

            // Prevent deleting yourself
            const session = sessionManager.getSession();
            if (email === session.email) {
                showToast('No puedes eliminar tu propio usuario', 'error');
                return;
            }

            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm(`¬øEliminar usuario "${nombre}" (${email})?`)) {
                return;
            }

            try {
                await sheetsAPI.deleteRow(CONFIG.SHEETS.USUARIOS, rowNumber);
                showToast('Usuario eliminado exitosamente', 'success');
                await loadUsuariosView();
            } catch (error) {
                console.error('‚ùå Error deleting usuario:', error);
                showToast('Error al eliminar usuario', 'error');
            }
        }

        /**
         * Filter Usuarios Table
         */
        function filterUsuariosTable(searchTerm) {
            const filtered = allUsuariosData.filter(row => {
                const [id, nombre, email, pin, rol] = row;
                const searchLower = searchTerm.toLowerCase();

                return (nombre && nombre.toLowerCase().includes(searchLower)) ||
                       (email && email.toLowerCase().includes(searchLower)) ||
                       (rol && rol.toLowerCase().includes(searchLower));
            });

            renderUsuariosTable(filtered);
        }

        // ====================
        // GASTOS VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allGastosData = [];

        /**
         * Load Gastos View
         */
        async function loadGastosView() {
            try {
                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.GASTOS, 'A2:M');
                allGastosData = data || [];
                renderGastosTable(allGastosData);
            } catch (error) {
                console.error('‚ùå Error loading gastos:', error);
                showToast('Error al cargar gastos', 'error');
            }
        }

        /**
         * Filter Gastos table by search term
         */
        function filterGastosTable(searchTerm) {
            if (!searchTerm) {
                renderGastosTable(allGastosData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allGastosData.filter(row => {
                const [id, fecha, concepto, categoria] = row;
                return (
                    (concepto && concepto.toLowerCase().includes(searchLower)) ||
                    (categoria && categoria.toLowerCase().includes(searchLower))
                );
            });
            renderGastosTable(filtered);
        }

        /**
         * Render Gastos Table
         */
        function renderGastosTable(data) {
            const tbody = document.getElementById('table-gastos-body');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">No hay gastos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, fecha, concepto, categoria, monto, metodoPago, proveedor, proyecto, estado] = row;
                const estadoColor = getGastoEstadoColor(estado);
                return `
                    <tr>
                        <td class="py-3 px-4 border-b border-gray-700">${id || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${fecha || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${concepto || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${categoria || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${formatCurrency(monto)}</td>
                        <td class="py-3 px-4 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm bg-${estadoColor}-500/20 text-${estadoColor}-400">${estado || ''}</span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-700 space-x-1">
                            <button onclick='editGasto(${index + 2}, ${JSON.stringify(row)})' class="text-blue-400 hover:text-blue-300" title="Editar">‚úèÔ∏è</button>
                            ${sessionManager.isSuperAdmin() ? `<button onclick="deleteGasto(${index + 2})" class="text-red-400 hover:text-red-300" title="Eliminar">üóëÔ∏è</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get Gasto Estado Color
         */
        function getGastoEstadoColor(estado) {
            switch (estado) {
                case 'Pagado': return 'green';
                case 'Pendiente': return 'yellow';
                case 'Rechazado': return 'red';
                default: return 'gray';
            }
        }

        /**
         * Generate Gasto ID
         */
        function generateGastoId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `GAS-${year}-${random}`;
        }

        /**
         * Handle Gastos form submission
         */
        async function handleGastosSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateGastoId();
                const fecha = document.getElementById('input-gasto-fecha').value;
                const concepto = document.getElementById('input-gasto-concepto').value;
                const categoria = document.getElementById('input-gasto-categoria').value;
                const monto = document.getElementById('input-gasto-monto').value;
                const metodoPago = document.getElementById('input-gasto-metodo').value;
                const proveedor = document.getElementById('input-gasto-proveedor').value;
                const proyecto = document.getElementById('input-gasto-proyecto').value;
                const estado = document.getElementById('input-gasto-estado').value;
                const facturaRecibo = document.getElementById('input-gasto-factura').value;
                const esRecurrente = document.getElementById('input-gasto-recurrente').value;
                const notas = document.getElementById('input-gasto-notas').value;
                const fechaCreacion = isEditing ? submitBtn.getAttribute('data-fecha-creacion') : new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data (13 columns A-M)
                const rowData = [[
                    id,
                    fecha,
                    concepto,
                    categoria,
                    monto,
                    metodoPago,
                    proveedor,
                    proyecto,
                    estado,
                    facturaRecibo,
                    esRecurrente,
                    notas,
                    fechaCreacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.GASTOS, `A${editRow}:M${editRow}`, rowData);
                    showToast('Gasto actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.GASTOS, rowData);
                    showToast('Gasto guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-gastos').reset();
                submitBtn.textContent = 'Guardar Gasto';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');
                submitBtn.removeAttribute('data-fecha-creacion');

                // Reload table
                await loadGastosView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error saving gasto:', error);
                showToast('Error al guardar gasto', 'error');
            }
        }

        /**
         * Edit Gasto
         */
        function editGasto(rowNumber, rowData) {
            const [id, fecha, concepto, categoria, monto, metodoPago, proveedor, proyecto, estado, facturaRecibo, esRecurrente, notas, fechaCreacion] = rowData;

            // Scroll to form
            document.getElementById('form-gastos').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-gasto-fecha').value = fecha || '';
            document.getElementById('input-gasto-concepto').value = concepto || '';
            document.getElementById('input-gasto-categoria').value = categoria || '';
            document.getElementById('input-gasto-monto').value = monto || '';
            document.getElementById('input-gasto-metodo').value = metodoPago || '';
            document.getElementById('input-gasto-proveedor').value = proveedor || '';
            document.getElementById('input-gasto-proyecto').value = proyecto || '';
            document.getElementById('input-gasto-estado').value = estado || '';
            document.getElementById('input-gasto-factura').value = facturaRecibo || '';
            document.getElementById('input-gasto-recurrente').value = esRecurrente || '';
            document.getElementById('input-gasto-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-gastos button[type="submit"]');
            submitBtn.textContent = 'Actualizar Gasto';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
            submitBtn.setAttribute('data-fecha-creacion', fechaCreacion);
        }

        /**
         * Delete Gasto
         */
        async function deleteGasto(rowNumber) {
            if (!sessionManager.isSuperAdmin()) {
                showToast('Solo el Super Admin puede eliminar registros', 'error');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar este gasto?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteRow(CONFIG.SHEETS.GASTOS, rowNumber);

                showToast('Gasto eliminado exitosamente', 'success');

                // Reload table
                await loadGastosView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error('‚ùå Error deleting gasto:', error);
                showToast('Error al eliminar gasto', 'error');
            }
        }

        // ====================
        // DROPDOWN POPULATION FUNCTIONS
        // ====================

        /**
         * Populate Clientes dropdown in Proyectos from Contactos
         */
        async function populateClientesDropdown() {
            const dropdown = document.getElementById('input-proyecto-cliente');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value="">‚è≥ Cargando clientes...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.CONTACTOS, 'A2:O');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Selecciona un cliente...</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, email, telefono, empresa] = row;
                        if (nombre) {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.setAttribute('data-email', email || '');
                            option.textContent = `${nombre}${empresa ? ` (${empresa})` : ''}`;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    console.log(`‚úÖ ${count} clientes cargados`);
                } else {
                    // Empty state
                    dropdown.innerHTML = '<option value="">‚ö†Ô∏è No hay contactos - Ve a Contactos para agregar</option>';
                }
            } catch (error) {
                console.error('‚ùå Error loading clientes:', error);
                dropdown.innerHTML = '<option value="">‚ùå Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de clientes', 'error');
            }
        }

        /**
         * Populate Promotores dropdown in Proyectos from Promotores
         */
        async function populatePromotoresDropdown() {
            const dropdown = document.getElementById('input-proyecto-promotor');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value="">‚è≥ Cargando promotores...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROMOTORES, 'A2:Q');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Sin promotor</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, email, telefono, estado] = row;
                        if (nombre && estado === 'Activo') {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.textContent = nombre;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    if (count === 0) {
                        dropdown.innerHTML = '<option value="">‚ö†Ô∏è No hay promotores activos</option>';
                    } else {
                        console.log(`‚úÖ ${count} promotores activos cargados`);
                    }
                } else {
                    // Empty state
                    dropdown.innerHTML = '<option value="">‚ö†Ô∏è No hay promotores - Ve a Promotores para agregar</option>';
                }
            } catch (error) {
                console.error('‚ùå Error loading promotores:', error);
                dropdown.innerHTML = '<option value="">‚ùå Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de promotores', 'error');
            }
        }

        /**
         * Populate Proyectos dropdown in Facturaci√≥n from Proyectos
         */
        async function populateProyectosDropdownFacturacion() {
            const dropdown = document.getElementById('input-factura-proyecto');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value="">‚è≥ Cargando proyectos...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS, 'A2:O');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Selecciona un proyecto...</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, cliente] = row;
                        if (nombre) {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.setAttribute('data-cliente', cliente || '');
                            option.textContent = `${nombre}${cliente ? ` - ${cliente}` : ''}`;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    console.log(`‚úÖ ${count} proyectos cargados`);
                } else {
                    // Empty state
                    dropdown.innerHTML = '<option value="">‚ö†Ô∏è No hay proyectos - Ve a Proyectos para crear</option>';
                }
            } catch (error) {
                console.error('‚ùå Error loading proyectos:', error);
                dropdown.innerHTML = '<option value="">‚ùå Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de proyectos', 'error');
            }
        }

        /**
         * Populate Proyectos dropdown in Gastos from Proyectos
         */
        async function populateProyectosDropdownGastos() {
            const dropdown = document.getElementById('input-gasto-proyecto');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value="">‚è≥ Cargando proyectos...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS, 'A2:O');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Sin proyecto asociado</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, cliente] = row;
                        if (nombre) {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.textContent = `${nombre}${cliente ? ` - ${cliente}` : ''}`;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    console.log(`‚úÖ ${count} proyectos cargados para gastos`);
                } else {
                    // Empty state (opcional, so just keep default)
                    console.log('‚ö†Ô∏è No hay proyectos disponibles');
                }
            } catch (error) {
                console.error('‚ùå Error loading proyectos:', error);
                dropdown.innerHTML = '<option value="">‚ùå Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de proyectos', 'error');
            }
        }

        /**
         * Handle Cliente selection in Proyectos (auto-fill email)
         */
        function handleClienteSelection() {
            const dropdown = document.getElementById('input-proyecto-cliente');
            const emailInput = document.getElementById('input-proyecto-email');

            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const email = selectedOption.getAttribute('data-email') || '';

            emailInput.value = email;
        }

        /**
         * Handle Proyecto selection in Facturaci√≥n (auto-fill cliente)
         */
        function handleProyectoSelectionFacturacion() {
            const dropdown = document.getElementById('input-factura-proyecto');
            const clienteInput = document.getElementById('input-factura-cliente');

            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const cliente = selectedOption.getAttribute('data-cliente') || '';

            clienteInput.value = cliente;
        }

        // Initialize navigation
        function initNavigation() {
            // Navigation
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.currentTarget.dataset.view;

                    // Update active state
                    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    // Show view
                    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                    document.getElementById(`view-${view}`).classList.remove('hidden');
                });
            });

            // Pipeline view event listeners
            document.getElementById('form-pipeline').addEventListener('submit', handlePipelineSubmit);
            document.getElementById('btn-refresh-pipeline').addEventListener('click', loadPipelineView);

            // Search filter for Pipeline
            document.getElementById('search-pipeline').addEventListener('input', (e) => {
                filterPipelineTable(e.target.value);
            });

            // Load Pipeline view when navigating to it
            document.querySelector('[data-view="pipeline"]').addEventListener('click', () => {
                setTimeout(async () => {
                    await loadPipelineView();
                    await populateServiciosDropdownPipeline();
                }, 100);
            });

            // Proyectos view event listeners
            document.getElementById('form-proyectos').addEventListener('submit', handleProyectosSubmit);
            document.getElementById('btn-refresh-proyectos').addEventListener('click', loadProyectosView);

            // Auto-fill email when cliente is selected
            document.getElementById('input-proyecto-cliente').addEventListener('change', handleClienteSelection);

            // Search filter for Proyectos
            document.getElementById('search-proyectos').addEventListener('input', (e) => {
                filterProyectosTable(e.target.value);
            });

            // Load Proyectos view when navigating to it
            document.querySelector('[data-view="proyectos"]').addEventListener('click', () => {
                setTimeout(async () => {
                    await loadProyectosView();
                }, 100);
            });

            // Facturaci√≥n view event listeners
            document.getElementById('form-facturacion').addEventListener('submit', handleFacturacionSubmit);
            document.getElementById('btn-refresh-facturacion').addEventListener('click', loadFacturacionView);

            // Auto-calculate monto total when monto or IVA changes
            document.getElementById('input-factura-monto').addEventListener('input', calculateMontoTotal);
            document.getElementById('input-factura-iva').addEventListener('change', calculateMontoTotal);

            // Auto-fill cliente when proyecto is selected
            document.getElementById('input-factura-proyecto').addEventListener('change', handleProyectoSelectionFacturacion);

            // Search filter for Facturaci√≥n
            document.getElementById('search-facturacion').addEventListener('input', (e) => {
                filterFacturacionTable(e.target.value);
            });

            // Load Facturaci√≥n view when navigating to it
            document.querySelector('[data-view="facturacion"]').addEventListener('click', () => {
                setTimeout(async () => {
                    await loadFacturacionView();
                    await populateProyectosDropdownFacturacion();
                }, 100);
            });

            // Contactos view event listeners
            document.getElementById('form-contactos').addEventListener('submit', handleContactosSubmit);
            document.getElementById('btn-refresh-contactos').addEventListener('click', loadContactosView);

            // Search filter for Contactos
            document.getElementById('search-contactos').addEventListener('input', (e) => {
                filterContactosTable(e.target.value);
            });

            // Load Contactos view when navigating to it
            document.querySelector('[data-view="contactos"]').addEventListener('click', () => {
                setTimeout(() => loadContactosView(), 100);
            });

            // Promotores view event listeners
            document.getElementById('form-promotores').addEventListener('submit', handlePromotoresSubmit);
            document.getElementById('btn-refresh-promotores').addEventListener('click', loadPromotoresView);

            // Search filter for Promotores
            document.getElementById('search-promotores').addEventListener('input', (e) => {
                filterPromotoresTable(e.target.value);
            });

            // Load Promotores view when navigating to it
            document.querySelector('[data-view="promotores"]').addEventListener('click', () => {
                setTimeout(() => loadPromotoresView(), 100);
            });

            // Servicios view event listeners
            document.getElementById('form-servicios').addEventListener('submit', handleServiciosSubmit);
            document.getElementById('btn-refresh-servicios').addEventListener('click', loadServiciosView);

            // Search filter for Servicios
            document.getElementById('search-servicios').addEventListener('input', (e) => {
                filterServiciosTable(e.target.value);
            });

            // Load Servicios view when navigating to it
            document.querySelector('[data-view="servicios"]').addEventListener('click', () => {
                setTimeout(() => loadServiciosView(), 100);
            });

            // Gastos view event listeners
            document.getElementById('form-gastos').addEventListener('submit', handleGastosSubmit);
            document.getElementById('btn-refresh-gastos').addEventListener('click', loadGastosView);

            // Search filter for Gastos
            document.getElementById('search-gastos').addEventListener('input', (e) => {
                filterGastosTable(e.target.value);
            });

            // Load Gastos view when navigating to it
            document.querySelector('[data-view="gastos"]').addEventListener('click', () => {
                setTimeout(async () => {
                    await loadGastosView();
                    await populateProyectosDropdownGastos();
                }, 100);
            });

            // Usuarios view event listeners (only if user can manage users)
            if (sessionManager.canManageUsers()) {
                document.getElementById('form-usuarios').addEventListener('submit', handleUsuarioSubmit);
                document.getElementById('btn-refresh-usuarios').addEventListener('click', loadUsuariosView);

                // Cancel edit button
                document.getElementById('btn-cancel-usuario').addEventListener('click', () => {
                    document.getElementById('form-usuarios').reset();
                    document.getElementById('btn-submit-usuario').textContent = 'Crear Usuario';
                    document.getElementById('btn-cancel-usuario').classList.add('hidden');
                    isEditingUsuario = false;
                    editUsuarioRow = null;
                });

                // Search filter for Usuarios
                document.getElementById('search-usuarios').addEventListener('input', (e) => {
                    filterUsuariosTable(e.target.value);
                });

                // Load Usuarios view when navigating to it
                document.querySelector('[data-view="usuarios"]').addEventListener('click', () => {
                    setTimeout(() => loadUsuariosView(), 100);
                });
            }
        }
    </script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
