<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema M茅TRIK - Dashboard + CRM</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        :root {
            /* Colores M茅TRIK */
            --color-primary: #1A1A1A;
            --color-accent: #10B981;
            --color-secondary: #6B7280;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-danger: #EF4444;
            --color-info: #3B82F6;
            --color-bg-primary: #F9FAFB;
            --color-bg-secondary: #FFFFFF;
            --color-bg-hover: #F3F4F6;
            --color-border: #E5E7EB;
            --color-border-dark: #D1D5DB;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-green: 0 4px 14px 0 rgba(16, 185, 129, 0.25);
        }

        * {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: var(--color-bg-primary);
            color: var(--color-primary);
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar-nav a {
            transition: all 0.2s;
        }

        .sidebar-nav a:hover {
            background: var(--color-bg-hover);
            transform: translateX(4px);
        }

        .sidebar-nav a.active {
            background: #D1FAE5;
            color: #065F46;
            font-weight: 600;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold text-gray-900">Sistema M茅TRIK</h2>
            <p class="text-gray-600 mt-2">Cargando...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden fixed inset-0 flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">M茅TRIK</h1>
                <p class="text-gray-600">Sistema de Gesti贸n Interno</p>
            </div>

            <button
                id="login-button"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-6 rounded-lg transition-all duration-200 flex items-center justify-center gap-3"
                style="box-shadow: var(--shadow-green);"
            >
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/>
                </svg>
                Iniciar sesi贸n con Google
            </button>

            <p class="text-sm text-gray-500 text-center mt-6">
                Usa tu cuenta de Google para acceder al sistema
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle" class="lg:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold text-gray-900">M茅TRIK</h1>
                </div>

                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-gray-600 hidden sm:block"></span>
                    <button id="logout-button" class="text-sm text-gray-600 hover:text-gray-900 font-semibold">
                        Cerrar sesi贸n
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 min-h-screen sticky top-16">
                <nav class="p-4 sidebar-nav">
                    <a href="#" data-view="dashboard" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2 active">
                        <span class="text-xl"></span>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" data-view="pipeline" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Pipeline</span>
                    </a>
                    <a href="#" data-view="proyectos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Proyectos</span>
                    </a>
                    <a href="#" data-view="facturacion" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Facturaci贸n</span>
                    </a>
                    <a href="#" data-view="contactos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Contactos</span>
                    </a>
                    <a href="#" data-view="promotores" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Promotores</span>
                    </a>
                    <a href="#" data-view="gastos" class="flex items-center gap-3 px-4 py-3 rounded-lg mb-2">
                        <span class="text-xl"></span>
                        <span>Gastos</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-content">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h2>

                    <!-- KPIs Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- KPI Card 1 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Leads Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-leads">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+12% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 2 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Pipeline Value</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-pipeline">-</h3>
                                    <p class="text-xs text-green-600 mt-1">+8% vs mes anterior</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 3 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Proyectos Activos</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-proyectos">-</h3>
                                    <p class="text-xs text-gray-600 mt-1">En ejecuci贸n</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Card 4 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl"></div>
                                <div class="flex-1">
                                    <p class="text-sm text-gray-600">Facturaci贸n Mes</p>
                                    <h3 class="text-3xl font-bold text-gray-900" id="kpi-facturacion">-</h3>
                                    <p class="text-xs text-green-600 mt-1">Mes actual</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Chart 1: Pipeline por Etapa -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pipeline por Etapa</h3>
                            <canvas id="chart-pipeline"></canvas>
                        </div>

                        <!-- Chart 2: Proyectos por Estado -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Proyectos por Estado</h3>
                            <canvas id="chart-proyectos"></canvas>
                        </div>

                        <!-- Chart 3: Facturaci贸n 煤ltimos 12 meses -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 lg:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Facturaci贸n ltimos 12 Meses</h3>
                            <canvas id="chart-facturacion"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pipeline View -->
                <div id="view-pipeline" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Pipeline (CRM)</h2>
                        <button id="btn-refresh-pipeline" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Lead</h3>

                        <form id="form-pipeline" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Lead Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Lead *</label>
                                <input type="text" id="input-lead" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Juan P茅rez">
                            </div>

                            <!-- Empresa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
                                <input type="text" id="input-empresa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Tech Solutions">
                            </div>

                            <!-- Email -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" id="input-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="juan@tech.co">
                            </div>

                            <!-- Tel茅fono -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel茅fono</label>
                                <input type="tel" id="input-telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="+57 300 123 4567">
                            </div>

                            <!-- Etapa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Etapa *</label>
                                <select id="input-etapa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Contacto">Contacto</option>
                                    <option value="Propuesta">Propuesta</option>
                                    <option value="Negociaci贸n">Negociaci贸n</option>
                                    <option value="Cierre">Cierre</option>
                                </select>
                            </div>

                            <!-- Valor -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (COP) *</label>
                                <input type="number" id="input-valor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- Probabilidad -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Probabilidad (%) *</label>
                                <input type="number" id="input-probabilidad" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="50" min="0" max="100">
                            </div>

                            <!-- Fecha Contacto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Contacto *</label>
                                <input type="date" id="input-fecha-contacto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Estimada Cierre -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Est. Cierre</label>
                                <input type="date" id="input-fecha-cierre" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Ganado">Ganado</option>
                                    <option value="Perdido">Perdido</option>
                                    <option value="Pausado">Pausado</option>
                                </select>
                            </div>

                            <!-- Fuente -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fuente</label>
                                <select id="input-fuente" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Web">Web</option>
                                    <option value="Referido">Referido</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Evento">Evento</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones adicionales..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Lead
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Leads Registrados</h3>
                            <input type="text" id="search-pipeline" placeholder=" Buscar por nombre, empresa o email..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lead</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Etapa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prob.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-pipeline-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Proyectos View -->
                <div id="view-proyectos" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Proyectos</h2>
                        <button id="btn-refresh-proyectos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Proyecto</h3>

                        <form id="form-proyectos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Nombre Proyecto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto *</label>
                                <input type="text" id="input-proyecto-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Dashboard de Ventas">
                            </div>

                            <!-- Cliente (Dropdown din谩mico desde Contactos) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente *</label>
                                <select id="input-proyecto-cliente" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Selecciona un cliente...</option>
                                </select>
                            </div>

                            <!-- Email Cliente (auto-completado) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Cliente</label>
                                <input type="email" id="input-proyecto-email" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Se llena autom谩ticamente">
                            </div>

                            <!-- Tipo Proyecto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Proyecto *</label>
                                <select id="input-proyecto-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Dashboard">Dashboard</option>
                                    <option value="CRM">CRM</option>
                                    <option value="Landing">Landing</option>
                                    <option value="Custom">Custom</option>
                                </select>
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-proyecto-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Pausado">Pausado</option>
                                    <option value="Completado">Completado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>

                            <!-- Fase -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fase *</label>
                                <select id="input-proyecto-fase" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Discovery">Discovery</option>
                                    <option value="Design">Design</option>
                                    <option value="Desarrollo">Desarrollo</option>
                                    <option value="QA">QA</option>
                                    <option value="Deploy">Deploy</option>
                                    <option value="Cerrado">Cerrado</option>
                                </select>
                            </div>

                            <!-- Fecha Inicio -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio *</label>
                                <input type="date" id="input-proyecto-fecha-inicio" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Entrega Estimada -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Est. *</label>
                                <input type="date" id="input-proyecto-fecha-entrega-est" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Entrega Real -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Real</label>
                                <input type="date" id="input-proyecto-fecha-entrega-real" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Valor -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (COP) *</label>
                                <input type="number" id="input-proyecto-valor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- Progreso -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Progreso (%) *</label>
                                <input type="number" id="input-proyecto-progreso" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="50" min="0" max="100" value="0">
                            </div>

                            <!-- Promotor (Dropdown din谩mico desde Promotores) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Promotor</label>
                                <select id="input-proyecto-promotor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Sin promotor</option>
                                </select>
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-proyecto-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones del proyecto..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Proyecto
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Proyectos Registrados</h3>
                            <input type="text" id="search-proyectos" placeholder=" Buscar por nombre o cliente..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fase</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progreso</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-proyectos-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Facturaci贸n View -->
                <div id="view-facturacion" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Facturaci贸n</h2>
                        <button id="btn-refresh-facturacion" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nueva Factura</h3>

                        <form id="form-facturacion" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Proyecto (Dropdown din谩mico desde Proyectos) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Proyecto *</label>
                                <select id="input-factura-proyecto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Selecciona un proyecto...</option>
                                </select>
                            </div>

                            <!-- Cliente (auto-completado desde Proyecto) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                                <input type="text" id="input-factura-cliente" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" placeholder="Se llena autom谩ticamente">
                            </div>

                            <!-- Monto -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto (COP) *</label>
                                <input type="number" id="input-factura-monto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="15000000" min="0">
                            </div>

                            <!-- IVA -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">IVA (%)</label>
                                <select id="input-factura-iva" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="0">0%</option>
                                    <option value="19" selected>19%</option>
                                </select>
                            </div>

                            <!-- Monto Total (calculated) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto Total (COP)</label>
                                <input type="text" id="input-factura-total" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700" placeholder="Auto-calculado">
                            </div>

                            <!-- Fecha Emisi贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Emisi贸n *</label>
                                <input type="date" id="input-factura-fecha-emision" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Vencimiento -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Vencimiento *</label>
                                <input type="date" id="input-factura-fecha-vencimiento" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Fecha Pago -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Pago</label>
                                <input type="date" id="input-factura-fecha-pago" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <!-- Estado -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-factura-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Pagada">Pagada</option>
                                    <option value="Vencida">Vencida</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>

                            <!-- M茅todo Pago -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">M茅todo de Pago</label>
                                <select id="input-factura-metodo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <!-- Referencia Pago -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Referencia de Pago</label>
                                <input type="text" id="input-factura-referencia" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="N煤mero de transacci贸n">
                            </div>

                            <!-- Notas -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-factura-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones de la factura..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Factura
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Facturas Registradas</h3>
                            <input type="text" id="search-facturacion" placeholder=" Buscar por proyecto o cliente..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto Total</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Emis.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Venc.</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-facturacion-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contactos View -->
                <div id="view-contactos" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Contactos</h2>
                        <button id="btn-refresh-contactos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Contacto</h3>

                        <form id="form-contactos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                                <input type="text" id="input-contacto-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Juan P茅rez">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" id="input-contacto-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="juan@empresa.co">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel茅fono</label>
                                <input type="tel" id="input-contacto-telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="+57 300 123 4567">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
                                <input type="text" id="input-contacto-empresa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Tech Solutions">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cargo</label>
                                <input type="text" id="input-contacto-cargo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Director de Tecnolog铆a">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                                <select id="input-contacto-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Cliente">Cliente</option>
                                    <option value="Lead">Lead</option>
                                    <option value="Promotor">Promotor</option>
                                    <option value="Proveedor">Proveedor</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fuente</label>
                                <select id="input-contacto-fuente" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Seleccionar...</option>
                                    <option value="Web">Web</option>
                                    <option value="Referido">Referido</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Evento">Evento</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label>
                                <input type="text" id="input-contacto-ciudad" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Bogot谩">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pa铆s</label>
                                <input type="text" id="input-contacto-pais" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Colombia">
                            </div>

                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-contacto-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones..."></textarea>
                            </div>

                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Contacto
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Contactos Registrados</h3>
                            <input type="text" id="search-contactos" placeholder=" Buscar por nombre, empresa o email..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cargo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-contactos-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Promotores View -->
                <div id="view-promotores" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Promotores</h2>
                        <button id="btn-refresh-promotores" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Promotor</h3>

                        <form id="form-promotores" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                                <input type="text" id="input-promotor-nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Mar铆a Garc铆a">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" id="input-promotor-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="maria@promotor.co">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tel茅fono</label>
                                <input type="tel" id="input-promotor-telefono" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="+57 300 123 4567">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-promotor-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                    <option value="Suspendido">Suspendido</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">% Comisi贸n *</label>
                                <input type="number" id="input-promotor-comision" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="10" min="0" max="30">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Banco</label>
                                <input type="text" id="input-promotor-banco" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Bancolombia">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cuenta</label>
                                <input type="text" id="input-promotor-cuenta" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="123456789">
                            </div>

                            <div class="md:col-span-2 lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-promotor-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones..."></textarea>
                            </div>

                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Promotor
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Promotores Registrados</h3>
                            <input type="text" id="search-promotores" placeholder=" Buscar por nombre..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">% Comis.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Banco</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-promotores-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Gastos View -->
                <div id="view-gastos" class="view-content hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Gastos</h2>
                        <button id="btn-refresh-gastos" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-all">
                            Actualizar
                        </button>
                    </div>

                    <!-- Form Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Nuevo Gasto</h3>

                        <form id="form-gastos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                                <input type="date" id="input-gasto-fecha" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Concepto *</label>
                                <input type="text" id="input-gasto-concepto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Publicidad en Google Ads">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Categor铆a *</label>
                                <select id="input-gasto-categoria" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Marketing">Marketing</option>
                                    <option value="Software">Software</option>
                                    <option value="Oficina">Oficina</option>
                                    <option value="Transporte">Transporte</option>
                                    <option value="Comisiones">Comisiones</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto (COP) *</label>
                                <input type="number" id="input-gasto-monto" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="500000" min="0">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">M茅todo Pago *</label>
                                <select id="input-gasto-metodo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Tarjeta">Tarjeta</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                                <input type="text" id="input-gasto-proveedor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Google Inc.">
                            </div>

                            <!-- Proyecto (Dropdown din谩mico desde Proyectos) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Proyecto (Opcional)</label>
                                <select id="input-gasto-proyecto" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Sin proyecto asociado</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                <select id="input-gasto-estado" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="Pagado">Pagado</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Reembolsado">Reembolsado</option>
                                </select>
                            </div>

                            <div class="md:col-span-2 lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                                <textarea id="input-gasto-notas" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Observaciones..."></textarea>
                            </div>

                            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-all shadow-sm hover:shadow-md">
                                    Guardar Gasto
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Table Card -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Gastos Registrados</h3>
                            <input type="text" id="search-gastos" placeholder=" Buscar por concepto o categor铆a..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-96">
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Concepto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categor铆a</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="table-gastos-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            CLIENT_ID: '482658322972-3nst66clokld9b2rcjarg8i5v5ngo540.apps.googleusercontent.com',
            API_KEY: '', // No needed for OAuth 2.0
            SHEET_ID: '16uKHN5v6DhGCMjuyUaC84yIw9Fx-DKjayP2NRINrAJc',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email',
            DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            CACHE_DURATION: 5 * 60 * 1000, // 5 minutes
            SHEETS: {
                PIPELINE: 'Pipeline',
                PROYECTOS: 'Proyectos',
                FACTURACION: 'Facturaci贸n',
                CONTACTOS: 'Contactos',
                PROMOTORES: 'Promotores',
                GASTOS: 'Gastos'
            }
        };

        // Global variables
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Chart instances
        let chartPipeline = null;
        let chartProyectos = null;
        let chartFacturacion = null;

        // ====================
        // DATA LAYER: Google Sheets API
        // ====================

        /**
         * Google Sheets API wrapper with caching
         */
        class GoogleSheetsAPI {
            constructor() {
                this.cache = new Map();
            }

            /**
             * Read data from a sheet
             * @param {string} sheetName - Name of the sheet (e.g., 'Pipeline')
             * @param {string} range - Range to read (e.g., 'A2:Z' to read all data rows)
             * @returns {Promise<Array>} Array of rows
             */
            async readSheet(sheetName, range = 'A2:Z') {
                const cacheKey = `${sheetName}!${range}`;

                // Check cache
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < CONFIG.CACHE_DURATION) {
                        console.log(` Cache hit: ${cacheKey}`);
                        return cached.data;
                    }
                }

                try {
                    console.log(` Fetching: ${sheetName}!${range}`);

                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`,
                    });

                    const data = response.result.values || [];

                    // Cache the result
                    this.cache.set(cacheKey, {
                        data: data,
                        timestamp: Date.now()
                    });

                    console.log(` Fetched ${data.length} rows from ${sheetName}`);
                    return data;
                } catch (error) {
                    console.error(` Error reading ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Write data to a sheet (append rows)
             * @param {string} sheetName - Name of the sheet
             * @param {Array<Array>} values - 2D array of values to write
             * @returns {Promise<Object>} Response object
             */
            async writeSheet(sheetName, values) {
                try {
                    console.log(`锔 Writing ${values.length} rows to ${sheetName}`);

                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!A2`,
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: {
                            values: values
                        }
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(` Written to ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(` Error writing to ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Update existing data in a sheet
             * @param {string} sheetName - Name of the sheet
             * @param {string} range - Range to update (e.g., 'A2:E2')
             * @param {Array<Array>} values - 2D array of values to update
             * @returns {Promise<Object>} Response object
             */
            async updateSheet(sheetName, range, values) {
                try {
                    console.log(` Updating ${sheetName}!${range}`);

                    const response = await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`,
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: values
                        }
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(` Updated ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(` Error updating ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Delete rows from a sheet (by clearing content)
             * @param {string} sheetName - Name of the sheet
             * @param {string} range - Range to clear (e.g., 'A2:Z2')
             * @returns {Promise<Object>} Response object
             */
            async deleteSheet(sheetName, range) {
                try {
                    console.log(`锔 Deleting ${sheetName}!${range}`);

                    const response = await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: CONFIG.SHEET_ID,
                        range: `${sheetName}!${range}`
                    });

                    // Invalidate cache for this sheet
                    this.invalidateCache(sheetName);

                    console.log(` Deleted from ${sheetName}`);
                    return response.result;
                } catch (error) {
                    console.error(` Error deleting from ${sheetName}:`, error);
                    throw error;
                }
            }

            /**
             * Invalidate cache for a specific sheet
             * @param {string} sheetName - Name of the sheet
             */
            invalidateCache(sheetName) {
                const keysToDelete = [];
                for (const key of this.cache.keys()) {
                    if (key.startsWith(sheetName)) {
                        keysToDelete.push(key);
                    }
                }
                keysToDelete.forEach(key => this.cache.delete(key));
                console.log(`锔 Cache invalidated for ${sheetName}`);
            }

            /**
             * Clear all cache
             */
            clearCache() {
                this.cache.clear();
                console.log('锔 All cache cleared');
            }
        }

        // Create global instance
        const sheetsAPI = new GoogleSheetsAPI();

        // Initialize on load
        window.onload = function() {
            gapiLoadClient();
            gisInit();
        };

        // Load the Google API client
        function gapiLoadClient() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: CONFIG.DISCOVERY_DOCS,
                });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        // Initialize Google Identity Services
        function gisInit() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    onAuthSuccess();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        // Login button
        document.getElementById('login-button').addEventListener('click', () => {
            tokenClient.requestAccessToken();
        });

        // Logout button
        document.getElementById('logout-button').addEventListener('click', () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    accessToken = null;
                    document.getElementById('main-app').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                });
            }
        });

        // On successful authentication
        async function onAuthSuccess() {
            // Hide login, show main app
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');

            // Get user info
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const userInfo = await response.json();
                document.getElementById('user-email').textContent = userInfo.email;
            } catch (error) {
                console.error('Error getting user info:', error);
            }

            // Initialize navigation
            initNavigation();

            // Load dashboard data
            loadDashboardData();
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                console.log(' Loading dashboard data...');

                // Read data from all sheets in parallel
                const [pipelineData, proyectosData, facturacionData] = await Promise.all([
                    sheetsAPI.readSheet(CONFIG.SHEETS.PIPELINE),
                    sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS),
                    sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION)
                ]);

                // ====================
                // KPI 1: Leads Activos
                // ====================
                // Count leads with estado != "Perdido" and != "Ganado"
                const leadsActivos = pipelineData.filter(row => {
                    const estado = row[10]; // Column K: Estado
                    return estado && estado !== 'Perdido' && estado !== 'Ganado';
                }).length;

                document.getElementById('kpi-leads').textContent = leadsActivos;

                // ====================
                // KPI 2: Pipeline Value
                // ====================
                // Sum of "Pipeline Value" for active leads
                // Formula: Valor  (Probabilidad / 100)
                const pipelineValue = pipelineData
                    .filter(row => {
                        const estado = row[10]; // Column K: Estado
                        return estado && estado !== 'Perdido' && estado !== 'Ganado';
                    })
                    .reduce((sum, row) => {
                        const valor = parseFloat(row[6]) || 0; // Column G: Valor
                        const probabilidad = parseFloat(row[7]) || 0; // Column H: Probabilidad
                        const pipelineVal = valor * (probabilidad / 100);
                        return sum + pipelineVal;
                    }, 0);

                document.getElementById('kpi-pipeline').textContent = formatCurrency(pipelineValue);

                // ====================
                // KPI 3: Proyectos Activos
                // ====================
                // Count proyectos with estado = "Activo"
                const proyectosActivos = proyectosData.filter(row => {
                    const estado = row[4]; // Column E: Estado
                    return estado === 'Activo';
                }).length;

                document.getElementById('kpi-proyectos').textContent = proyectosActivos;

                // ====================
                // KPI 4: Facturaci贸n Mes Actual
                // ====================
                // Sum of "Monto" for current month
                const currentMonth = new Date().getMonth() + 1; // 1-12
                const currentYear = new Date().getFullYear();

                const facturacionMes = facturacionData
                    .filter(row => {
                        const fechaEmision = row[1]; // Column B: Fecha emisi贸n
                        if (!fechaEmision) return false;

                        // Parse date (assuming format: DD/MM/YYYY or YYYY-MM-DD)
                        const date = parseDate(fechaEmision);
                        if (!date) return false;

                        return date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
                    })
                    .reduce((sum, row) => {
                        const monto = parseFloat(row[4]) || 0; // Column E: Monto
                        return sum + monto;
                    }, 0);

                document.getElementById('kpi-facturacion').textContent = formatCurrency(facturacionMes);

                // Initialize charts with real data
                initCharts(pipelineData, proyectosData, facturacionData);

                console.log(' Dashboard data loaded successfully');
            } catch (error) {
                console.error(' Error loading dashboard data:', error);

                // Show error state
                document.getElementById('kpi-leads').textContent = 'Error';
                document.getElementById('kpi-pipeline').textContent = 'Error';
                document.getElementById('kpi-proyectos').textContent = 'Error';
                document.getElementById('kpi-facturacion').textContent = 'Error';

                alert('Error al cargar datos del dashboard. Por favor, recarga la p谩gina.');
            }
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================

        /**
         * Format number as currency (COP)
         */
        function formatCurrency(value) {
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(1)}K`;
            } else {
                return `$${value.toFixed(0)}`;
            }
        }

        /**
         * Parse date from string (supports DD/MM/YYYY and YYYY-MM-DD)
         */
        function parseDate(dateString) {
            if (!dateString) return null;

            // Try DD/MM/YYYY format
            let parts = dateString.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // 0-indexed
                const year = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            // Try YYYY-MM-DD format
            parts = dateString.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // 0-indexed
                const day = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }

            return null;
        }

        // Initialize charts with real data
        function initCharts(pipelineData = [], proyectosData = [], facturacionData = []) {
            // Destroy existing charts if they exist
            if (chartPipeline) {
                chartPipeline.destroy();
                chartPipeline = null;
            }
            if (chartProyectos) {
                chartProyectos.destroy();
                chartProyectos = null;
            }
            if (chartFacturacion) {
                chartFacturacion.destroy();
                chartFacturacion = null;
            }

            // ====================
            // Chart 1: Pipeline por Etapa
            // ====================
            const etapas = ['Contacto', 'Propuesta', 'Negociaci贸n', 'Cierre'];
            const pipelineByEtapa = etapas.map(etapa => {
                return pipelineData.filter(row => {
                    const etapaRow = row[5]; // Column F: Etapa
                    const estado = row[10]; // Column K: Estado
                    return etapaRow === etapa && estado !== 'Perdido' && estado !== 'Ganado';
                }).length;
            });

            const ctx1 = document.getElementById('chart-pipeline').getContext('2d');
            chartPipeline = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Contacto', 'Propuesta', 'Negociaci贸n', 'Cierre'],
                    datasets: [{
                        label: 'Cantidad de Leads',
                        data: pipelineByEtapa,
                        backgroundColor: '#10B981',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // ====================
            // Chart 2: Proyectos por Estado
            // ====================
            const estados = ['Activo', 'Pausado', 'Completado', 'Cancelado'];
            const proyectosByEstado = estados.map(estado => {
                return proyectosData.filter(row => {
                    const estadoRow = row[4]; // Column E: Estado
                    return estadoRow === estado;
                }).length;
            });

            const ctx2 = document.getElementById('chart-proyectos').getContext('2d');
            chartProyectos = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: estados,
                    datasets: [{
                        data: proyectosByEstado,
                        backgroundColor: ['#10B981', '#F59E0B', '#6B7280', '#EF4444'],
                    }]
                },
                options: {
                    responsive: true,
                }
            });

            // ====================
            // Chart 3: Facturaci贸n 煤ltimos 12 meses
            // ====================
            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();

            // Calculate last 12 months data
            const last12Months = [];
            for (let i = 11; i >= 0; i--) {
                const date = new Date(currentYear, currentDate.getMonth() - i, 1);
                const month = date.getMonth() + 1; // 1-12
                const year = date.getFullYear();

                const monthTotal = facturacionData
                    .filter(row => {
                        const fechaEmision = row[1]; // Column B: Fecha emisi贸n
                        if (!fechaEmision) return false;

                        const parsedDate = parseDate(fechaEmision);
                        if (!parsedDate) return false;

                        return parsedDate.getMonth() + 1 === month && parsedDate.getFullYear() === year;
                    })
                    .reduce((sum, row) => {
                        const monto = parseFloat(row[4]) || 0; // Column E: Monto
                        return sum + monto;
                    }, 0);

                last12Months.push({
                    label: monthNames[date.getMonth()],
                    value: monthTotal / 1000000 // Convert to millions
                });
            }

            const ctx3 = document.getElementById('chart-facturacion').getContext('2d');
            chartFacturacion = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: last12Months.map(m => m.label),
                    datasets: [{
                        label: 'Facturaci贸n (Millones COP)',
                        data: last12Months.map(m => m.value),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(1)}M COP`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return `$${value}M`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ====================
        // TOAST NOTIFICATION SYSTEM
        // ====================

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;

            // Set color based on type
            if (type === 'success') {
                toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            } else if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            } else {
                toast.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform opacity-100 translate-y-0 transition-all duration-300 z-50';
            }

            // Hide after 3 seconds
            setTimeout(() => {
                toast.className = 'fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50';
            }, 3000);
        }

        // ====================
        // PIPELINE VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allPipelineData = [];

        /**
         * Load and render Pipeline data
         */
        async function loadPipelineView() {
            try {
                console.log(' Loading Pipeline view...');

                const pipelineData = await sheetsAPI.readSheet(CONFIG.SHEETS.PIPELINE);
                allPipelineData = pipelineData || [];
                renderPipelineTable(allPipelineData);

                console.log(' Pipeline view loaded');
            } catch (error) {
                console.error(' Error loading Pipeline:', error);
                showToast('Error al cargar Pipeline', 'error');
            }
        }

        /**
         * Filter Pipeline table by search term
         */
        function filterPipelineTable(searchTerm) {
            if (!searchTerm) {
                renderPipelineTable(allPipelineData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allPipelineData.filter(row => {
                const [id, lead, empresa, email] = row;
                return (
                    (lead && lead.toLowerCase().includes(searchLower)) ||
                    (empresa && empresa.toLowerCase().includes(searchLower)) ||
                    (email && email.toLowerCase().includes(searchLower))
                );
            });
            renderPipelineTable(filtered);
        }

        /**
         * Render Pipeline table
         */
        function renderPipelineTable(data) {
            const tbody = document.getElementById('table-pipeline-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No hay leads registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, lead, empresa, email, telefono, etapa, valor, probabilidad, fechaContacto, fechaCierre, estado, fuente, notas] = row;

                // Generate badge colors
                const etapaBadge = getBadge(etapa, 'blue');
                const estadoBadge = getBadge(estado, getEstadoColor(estado));

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${lead || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${empresa || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${email || '-'}</td>
                        <td class="px-4 py-3 text-sm">${etapaBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(valor) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${probabilidad}%</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm text-right space-x-2">
                            <button onclick='editPipelineLead(${index + 2}, ${JSON.stringify(row)})' class="text-blue-600 hover:text-blue-800 font-medium">
                                锔 Editar
                            </button>
                            <button onclick="deletePipelineLead(${index + 2})" class="text-red-600 hover:text-red-800 font-medium">
                                锔 Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get badge HTML
         */
        function getBadge(text, color) {
            const colors = {
                'blue': 'bg-blue-100 text-blue-800',
                'green': 'bg-green-100 text-green-800',
                'yellow': 'bg-yellow-100 text-yellow-800',
                'red': 'bg-red-100 text-red-800',
                'gray': 'bg-gray-100 text-gray-800'
            };

            const colorClass = colors[color] || colors.gray;

            return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${colorClass}">${text}</span>`;
        }

        /**
         * Get estado color
         */
        function getEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'blue';
                case 'Ganado': return 'green';
                case 'Perdido': return 'red';
                case 'Pausado': return 'yellow';
                default: return 'gray';
            }
        }

        /**
         * Generate Pipeline ID
         */
        function generatePipelineId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PIP-${year}-${random}`;
        }

        /**
         * Handle Pipeline form submission
         */
        async function handlePipelineSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generatePipelineId();
                const lead = document.getElementById('input-lead').value;
                const empresa = document.getElementById('input-empresa').value;
                const email = document.getElementById('input-email').value;
                const telefono = document.getElementById('input-telefono').value;
                const etapa = document.getElementById('input-etapa').value;
                const valor = document.getElementById('input-valor').value;
                const probabilidad = document.getElementById('input-probabilidad').value;
                const fechaContacto = document.getElementById('input-fecha-contacto').value;
                const fechaCierre = document.getElementById('input-fecha-cierre').value;
                const estado = document.getElementById('input-estado').value;
                const fuente = document.getElementById('input-fuente').value;
                const notas = document.getElementById('input-notas').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data
                const rowData = [[
                    id,
                    lead,
                    empresa,
                    email,
                    telefono,
                    etapa,
                    valor,
                    probabilidad,
                    fechaContacto,
                    fechaCierre,
                    estado,
                    fuente,
                    notas,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.PIPELINE, `A${editRow}:N${editRow}`, rowData);
                    showToast('Lead actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.PIPELINE, rowData);
                    showToast('Lead guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-pipeline').reset();
                submitBtn.textContent = 'Guardar Lead';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadPipelineView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error(' Error saving lead:', error);
                showToast('Error al guardar lead', 'error');
            }
        }

        /**
         * Edit Pipeline lead
         */
        function editPipelineLead(rowNumber, rowData) {
            const [id, lead, empresa, email, telefono, etapa, valor, probabilidad, fechaContacto, fechaCierre, estado, fuente, notas] = rowData;

            // Scroll to form
            document.getElementById('form-pipeline').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-lead').value = lead || '';
            document.getElementById('input-empresa').value = empresa || '';
            document.getElementById('input-email').value = email || '';
            document.getElementById('input-telefono').value = telefono || '';
            document.getElementById('input-etapa').value = etapa || '';
            document.getElementById('input-valor').value = valor || '';
            document.getElementById('input-probabilidad').value = probabilidad || '';
            document.getElementById('input-fecha-contacto').value = fechaContacto || '';
            document.getElementById('input-fecha-cierre').value = fechaCierre || '';
            document.getElementById('input-estado').value = estado || '';
            document.getElementById('input-fuente').value = fuente || '';
            document.getElementById('input-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-nuevo-lead button[type="submit"]');
            submitBtn.textContent = 'Actualizar Lead';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
        }

        /**
         * Delete Pipeline lead
         */
        async function deletePipelineLead(rowNumber) {
            if (!confirm('驴Est谩s seguro de eliminar este lead?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.PIPELINE, `A${rowNumber}:N${rowNumber}`);

                showToast('Lead eliminado exitosamente', 'success');

                // Reload table
                await loadPipelineView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error(' Error deleting lead:', error);
                showToast('Error al eliminar lead', 'error');
            }
        }

        // ====================
        // PROYECTOS VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allProyectosData = [];

        /**
         * Load and render Proyectos data
         */
        async function loadProyectosView() {
            try {
                console.log(' Loading Proyectos view...');

                const proyectosData = await sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS);
                allProyectosData = proyectosData || [];
                renderProyectosTable(allProyectosData);

                console.log(' Proyectos view loaded');
            } catch (error) {
                console.error(' Error loading Proyectos:', error);
                showToast('Error al cargar Proyectos', 'error');
            }
        }

        /**
         * Filter Proyectos table by search term
         */
        function filterProyectosTable(searchTerm) {
            if (!searchTerm) {
                renderProyectosTable(allProyectosData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allProyectosData.filter(row => {
                const [id, nombre, cliente] = row;
                return (
                    (nombre && nombre.toLowerCase().includes(searchLower)) ||
                    (cliente && cliente.toLowerCase().includes(searchLower))
                );
            });
            renderProyectosTable(filtered);
        }

        /**
         * Render Proyectos table
         */
        function renderProyectosTable(data) {
            const tbody = document.getElementById('table-proyectos-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No hay proyectos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, cliente, emailCliente, tipoProyecto, estado, fase, fechaInicio, fechaEntregaEst, fechaEntregaReal, valor, progreso, promotor, notas] = row;

                // Generate badge colors
                const estadoBadge = getBadge(estado, getProyectoEstadoColor(estado));
                const faseBadge = getBadge(fase, 'blue');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${nombre || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${cliente || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${tipoProyecto || '-'}</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm">${faseBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(valor) || 0)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${progreso}%</td>
                        <td class="px-4 py-3 text-sm text-right space-x-2">
                            <button onclick='editProyecto(${index + 2}, ${JSON.stringify(row)})' class="text-blue-600 hover:text-blue-800 font-medium">
                                锔 Editar
                            </button>
                            <button onclick="deleteProyecto(${index + 2})" class="text-red-600 hover:text-red-800 font-medium">
                                锔 Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get proyecto estado color
         */
        function getProyectoEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'green';
                case 'Pausado': return 'yellow';
                case 'Completado': return 'blue';
                case 'Cancelado': return 'red';
                default: return 'gray';
            }
        }

        /**
         * Generate Proyecto ID
         */
        function generateProyectoId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PRJ-${year}-${random}`;
        }

        /**
         * Handle Proyectos form submission
         */
        async function handleProyectosSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateProyectoId();
                const nombre = document.getElementById('input-proyecto-nombre').value;
                const cliente = document.getElementById('input-proyecto-cliente').value;
                const emailCliente = document.getElementById('input-proyecto-email').value;
                const tipoProyecto = document.getElementById('input-proyecto-tipo').value;
                const estado = document.getElementById('input-proyecto-estado').value;
                const fase = document.getElementById('input-proyecto-fase').value;
                const fechaInicio = document.getElementById('input-proyecto-fecha-inicio').value;
                const fechaEntregaEst = document.getElementById('input-proyecto-fecha-entrega-est').value;
                const fechaEntregaReal = document.getElementById('input-proyecto-fecha-entrega-real').value;
                const valor = document.getElementById('input-proyecto-valor').value;
                const progreso = document.getElementById('input-proyecto-progreso').value;
                const promotor = document.getElementById('input-proyecto-promotor').value;
                const notas = document.getElementById('input-proyecto-notas').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data
                const rowData = [[
                    id,
                    nombre,
                    cliente,
                    emailCliente,
                    tipoProyecto,
                    estado,
                    fase,
                    fechaInicio,
                    fechaEntregaEst,
                    fechaEntregaReal,
                    valor,
                    progreso,
                    promotor,
                    notas,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.PROYECTOS, `A${editRow}:O${editRow}`, rowData);
                    showToast('Proyecto actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.PROYECTOS, rowData);
                    showToast('Proyecto guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-proyectos').reset();
                submitBtn.textContent = 'Guardar Proyecto';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadProyectosView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error(' Error saving proyecto:', error);
                showToast('Error al guardar proyecto', 'error');
            }
        }

        /**
         * Edit Proyecto
         */
        function editProyecto(rowNumber, rowData) {
            const [id, nombre, cliente, emailCliente, tipoProyecto, estado, fase, fechaInicio, fechaEntregaEst, fechaEntregaReal, valor, progreso, promotor, notas] = rowData;

            // Scroll to form
            document.getElementById('form-proyectos').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-proyecto-nombre').value = nombre || '';
            document.getElementById('input-proyecto-cliente').value = cliente || '';
            document.getElementById('input-proyecto-email').value = emailCliente || '';
            document.getElementById('input-proyecto-tipo').value = tipoProyecto || '';
            document.getElementById('input-proyecto-estado').value = estado || '';
            document.getElementById('input-proyecto-fase').value = fase || '';
            document.getElementById('input-proyecto-fecha-inicio').value = fechaInicio || '';
            document.getElementById('input-proyecto-fecha-entrega-est').value = fechaEntregaEst || '';
            document.getElementById('input-proyecto-fecha-entrega-real').value = fechaEntregaReal || '';
            document.getElementById('input-proyecto-valor').value = valor || '';
            document.getElementById('input-proyecto-progreso').value = progreso || '';
            document.getElementById('input-proyecto-promotor').value = promotor || '';
            document.getElementById('input-proyecto-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-proyectos button[type="submit"]');
            submitBtn.textContent = 'Actualizar Proyecto';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
        }

        /**
         * Delete Proyecto
         */
        async function deleteProyecto(rowNumber) {
            if (!confirm('驴Est谩s seguro de eliminar este proyecto?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.PROYECTOS, `A${rowNumber}:O${rowNumber}`);

                showToast('Proyecto eliminado exitosamente', 'success');

                // Reload table
                await loadProyectosView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error(' Error deleting proyecto:', error);
                showToast('Error al eliminar proyecto', 'error');
            }
        }

        // ====================
        // FACTURACIN VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allFacturacionData = [];

        /**
         * Load and render Facturaci贸n data
         */
        async function loadFacturacionView() {
            try {
                console.log(' Loading Facturaci贸n view...');

                const facturacionData = await sheetsAPI.readSheet(CONFIG.SHEETS.FACTURACION);
                allFacturacionData = facturacionData || [];
                renderFacturacionTable(allFacturacionData);

                console.log(' Facturaci贸n view loaded');
            } catch (error) {
                console.error(' Error loading Facturaci贸n:', error);
                showToast('Error al cargar Facturaci贸n', 'error');
            }
        }

        /**
         * Filter Facturaci贸n table by search term
         */
        function filterFacturacionTable(searchTerm) {
            if (!searchTerm) {
                renderFacturacionTable(allFacturacionData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allFacturacionData.filter(row => {
                const [id, proyecto, cliente] = row;
                return (
                    (proyecto && proyecto.toLowerCase().includes(searchLower)) ||
                    (cliente && cliente.toLowerCase().includes(searchLower))
                );
            });
            renderFacturacionTable(filtered);
        }

        /**
         * Render Facturaci贸n table
         */
        function renderFacturacionTable(data) {
            const tbody = document.getElementById('table-facturacion-body');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No hay facturas registradas</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, proyecto, cliente, monto, iva, montoTotal, fechaEmision, fechaVencimiento, fechaPago, estado, metodoPago, referencia, notas] = row;

                // Generate badge colors
                const estadoBadge = getBadge(estado, getFacturaEstadoColor(estado));

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${id || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${proyecto || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${cliente || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(montoTotal) || 0)}</td>
                        <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${fechaEmision || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${fechaVencimiento || '-'}</td>
                        <td class="px-4 py-3 text-sm text-right space-x-2">
                            <button onclick='editFactura(${index + 2}, ${JSON.stringify(row)})' class="text-blue-600 hover:text-blue-800 font-medium">
                                锔 Editar
                            </button>
                            <button onclick="deleteFactura(${index + 2})" class="text-red-600 hover:text-red-800 font-medium">
                                锔 Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get factura estado color
         */
        function getFacturaEstadoColor(estado) {
            switch (estado) {
                case 'Pendiente': return 'yellow';
                case 'Pagada': return 'green';
                case 'Vencida': return 'red';
                case 'Cancelada': return 'gray';
                default: return 'gray';
            }
        }

        /**
         * Generate Factura ID
         */
        function generateFacturaId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `FAC-${year}-${random}`;
        }

        /**
         * Calculate Monto Total (Monto + IVA)
         */
        function calculateMontoTotal() {
            const monto = parseFloat(document.getElementById('input-factura-monto').value) || 0;
            const iva = parseFloat(document.getElementById('input-factura-iva').value) || 0;
            const montoTotal = monto + (monto * iva / 100);
            document.getElementById('input-factura-total').value = formatCurrency(montoTotal);
            return montoTotal;
        }

        /**
         * Handle Facturaci贸n form submission
         */
        async function handleFacturacionSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateFacturaId();
                const proyecto = document.getElementById('input-factura-proyecto').value;
                const cliente = document.getElementById('input-factura-cliente').value;
                const monto = document.getElementById('input-factura-monto').value;
                const iva = document.getElementById('input-factura-iva').value;
                const montoTotal = calculateMontoTotal();
                const fechaEmision = document.getElementById('input-factura-fecha-emision').value;
                const fechaVencimiento = document.getElementById('input-factura-fecha-vencimiento').value;
                const fechaPago = document.getElementById('input-factura-fecha-pago').value;
                const estado = document.getElementById('input-factura-estado').value;
                const metodoPago = document.getElementById('input-factura-metodo').value;
                const referencia = document.getElementById('input-factura-referencia').value;
                const notas = document.getElementById('input-factura-notas').value;
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data
                const rowData = [[
                    id,
                    proyecto,
                    cliente,
                    monto,
                    iva,
                    montoTotal,
                    fechaEmision,
                    fechaVencimiento,
                    fechaPago,
                    estado,
                    metodoPago,
                    referencia,
                    notas,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.FACTURACION, `A${editRow}:N${editRow}`, rowData);
                    showToast('Factura actualizada exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.FACTURACION, rowData);
                    showToast('Factura guardada exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-facturacion').reset();
                document.getElementById('input-factura-total').value = '';
                submitBtn.textContent = 'Guardar Factura';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadFacturacionView();

                // Reload dashboard (to update KPIs)
                loadDashboardData();

            } catch (error) {
                console.error(' Error saving factura:', error);
                showToast('Error al guardar factura', 'error');
            }
        }

        /**
         * Edit Factura
         */
        function editFactura(rowNumber, rowData) {
            const [id, proyecto, cliente, monto, iva, montoTotal, fechaEmision, fechaVencimiento, fechaPago, estado, metodoPago, referencia, notas] = rowData;

            // Scroll to form
            document.getElementById('form-facturacion').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-factura-proyecto').value = proyecto || '';
            document.getElementById('input-factura-cliente').value = cliente || '';
            document.getElementById('input-factura-monto').value = monto || '';
            document.getElementById('input-factura-iva').value = iva || '';
            document.getElementById('input-factura-total').value = montoTotal || '';
            document.getElementById('input-factura-fecha-emision').value = fechaEmision || '';
            document.getElementById('input-factura-fecha-vencimiento').value = fechaVencimiento || '';
            document.getElementById('input-factura-fecha-pago').value = fechaPago || '';
            document.getElementById('input-factura-estado').value = estado || '';
            document.getElementById('input-factura-metodo').value = metodoPago || '';
            document.getElementById('input-factura-referencia').value = referencia || '';
            document.getElementById('input-factura-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-facturacion button[type="submit"]');
            submitBtn.textContent = 'Actualizar Factura';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
        }

        /**
         * Delete Factura
         */
        async function deleteFactura(rowNumber) {
            if (!confirm('驴Est谩s seguro de eliminar esta factura?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.FACTURACION, `A${rowNumber}:N${rowNumber}`);

                showToast('Factura eliminada exitosamente', 'success');

                // Reload table
                await loadFacturacionView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error(' Error deleting factura:', error);
                showToast('Error al eliminar factura', 'error');
            }
        }

        // ====================
        // CONTACTOS VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allContactosData = [];

        /**
         * Load Contactos View
         */
        async function loadContactosView() {
            try {
                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.CONTACTOS, 'A2:O');
                allContactosData = data || [];
                renderContactosTable(allContactosData);
            } catch (error) {
                console.error(' Error loading contactos:', error);
                showToast('Error al cargar contactos', 'error');
            }
        }

        /**
         * Filter Contactos table by search term
         */
        function filterContactosTable(searchTerm) {
            if (!searchTerm) {
                renderContactosTable(allContactosData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allContactosData.filter(row => {
                const [id, nombre, email, telefono, empresa] = row;
                return (
                    (nombre && nombre.toLowerCase().includes(searchLower)) ||
                    (empresa && empresa.toLowerCase().includes(searchLower)) ||
                    (email && email.toLowerCase().includes(searchLower))
                );
            });
            renderContactosTable(filtered);
        }

        /**
         * Render Contactos Table
         */
        function renderContactosTable(data) {
            const tbody = document.getElementById('table-contactos-body');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">No hay contactos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, email, telefono, empresa, cargo, tipo, fuente, linkedin, ciudad, pais] = row;
                return `
                    <tr>
                        <td class="py-3 px-4 border-b border-gray-700">${id || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${nombre || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${email || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${telefono || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${empresa || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm bg-gray-700 text-gray-300">${tipo || ''}</span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-700 space-x-2">
                            <button onclick='editContacto(${index + 2}, ${JSON.stringify(row)})' class="text-blue-400 hover:text-blue-300">
                                锔 Editar
                            </button>
                            <button onclick="deleteContacto(${index + 2})" class="text-red-400 hover:text-red-300">
                                锔 Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Generate Contacto ID
         */
        function generateContactoId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `CON-${year}-${random}`;
        }

        /**
         * Handle Contactos form submission
         */
        async function handleContactosSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateContactoId();
                const nombre = document.getElementById('input-contacto-nombre').value;
                const email = document.getElementById('input-contacto-email').value;
                const telefono = document.getElementById('input-contacto-telefono').value;
                const empresa = document.getElementById('input-contacto-empresa').value;
                const cargo = document.getElementById('input-contacto-cargo').value;
                const tipo = document.getElementById('input-contacto-tipo').value;
                const fuente = document.getElementById('input-contacto-fuente').value;
                const linkedin = document.getElementById('input-contacto-linkedin').value;
                const ciudad = document.getElementById('input-contacto-ciudad').value;
                const pais = document.getElementById('input-contacto-pais').value;
                const tags = document.getElementById('input-contacto-tags').value;
                const notas = document.getElementById('input-contacto-notas').value;
                const fechaCreacion = isEditing ? editRow.fechaCreacion : new Date().toISOString().slice(0, 19).replace('T', ' ');
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data (15 columns A-O)
                const rowData = [[
                    id,
                    nombre,
                    email,
                    telefono,
                    empresa,
                    cargo,
                    tipo,
                    fuente,
                    linkedin,
                    ciudad,
                    pais,
                    tags,
                    notas,
                    fechaCreacion,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.CONTACTOS, `A${editRow}:O${editRow}`, rowData);
                    showToast('Contacto actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.CONTACTOS, rowData);
                    showToast('Contacto guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-contactos').reset();
                submitBtn.textContent = 'Guardar Contacto';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');

                // Reload table
                await loadContactosView();

            } catch (error) {
                console.error(' Error saving contacto:', error);
                showToast('Error al guardar contacto', 'error');
            }
        }

        /**
         * Edit Contacto
         */
        function editContacto(rowNumber, rowData) {
            const [id, nombre, email, telefono, empresa, cargo, tipo, fuente, linkedin, ciudad, pais, tags, notas, fechaCreacion] = rowData;

            // Scroll to form
            document.getElementById('form-contactos').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-contacto-nombre').value = nombre || '';
            document.getElementById('input-contacto-email').value = email || '';
            document.getElementById('input-contacto-telefono').value = telefono || '';
            document.getElementById('input-contacto-empresa').value = empresa || '';
            document.getElementById('input-contacto-cargo').value = cargo || '';
            document.getElementById('input-contacto-tipo').value = tipo || '';
            document.getElementById('input-contacto-fuente').value = fuente || '';
            document.getElementById('input-contacto-linkedin').value = linkedin || '';
            document.getElementById('input-contacto-ciudad').value = ciudad || '';
            document.getElementById('input-contacto-pais').value = pais || '';
            document.getElementById('input-contacto-tags').value = tags || '';
            document.getElementById('input-contacto-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-contactos button[type="submit"]');
            submitBtn.textContent = 'Actualizar Contacto';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
            submitBtn.setAttribute('data-fecha-creacion', fechaCreacion);
        }

        /**
         * Delete Contacto
         */
        async function deleteContacto(rowNumber) {
            if (!confirm('驴Est谩s seguro de eliminar este contacto?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.CONTACTOS, `A${rowNumber}:O${rowNumber}`);

                showToast('Contacto eliminado exitosamente', 'success');

                // Reload table
                await loadContactosView();

            } catch (error) {
                console.error(' Error deleting contacto:', error);
                showToast('Error al eliminar contacto', 'error');
            }
        }

        // ====================
        // PROMOTORES VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allPromotoresData = [];

        /**
         * Load Promotores View
         */
        async function loadPromotoresView() {
            try {
                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROMOTORES, 'A2:Q');
                allPromotoresData = data || [];
                renderPromotoresTable(allPromotoresData);
            } catch (error) {
                console.error(' Error loading promotores:', error);
                showToast('Error al cargar promotores', 'error');
            }
        }

        /**
         * Filter Promotores table by search term
         */
        function filterPromotoresTable(searchTerm) {
            if (!searchTerm) {
                renderPromotoresTable(allPromotoresData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allPromotoresData.filter(row => {
                const [id, nombre] = row;
                return (nombre && nombre.toLowerCase().includes(searchLower));
            });
            renderPromotoresTable(filtered);
        }

        /**
         * Render Promotores Table
         */
        function renderPromotoresTable(data) {
            const tbody = document.getElementById('table-promotores-body');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">No hay promotores registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, nombre, email, telefono, estado, comision] = row;
                const estadoColor = getPromotorEstadoColor(estado);
                return `
                    <tr>
                        <td class="py-3 px-4 border-b border-gray-700">${id || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${nombre || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${email || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${telefono || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm bg-${estadoColor}-500/20 text-${estadoColor}-400">${estado || ''}</span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-700">${comision || '0'}%</td>
                        <td class="py-3 px-4 border-b border-gray-700 space-x-2">
                            <button onclick='editPromotor(${index + 2}, ${JSON.stringify(row)})' class="text-blue-400 hover:text-blue-300">
                                锔 Editar
                            </button>
                            <button onclick="deletePromotor(${index + 2})" class="text-red-400 hover:text-red-300">
                                锔 Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get Promotor Estado Color
         */
        function getPromotorEstadoColor(estado) {
            switch (estado) {
                case 'Activo': return 'green';
                case 'Inactivo': return 'gray';
                case 'Suspendido': return 'red';
                default: return 'gray';
            }
        }

        /**
         * Generate Promotor ID
         */
        function generatePromotorId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `PROM-${year}-${random}`;
        }

        /**
         * Handle Promotores form submission
         */
        async function handlePromotoresSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generatePromotorId();
                const nombre = document.getElementById('input-promotor-nombre').value;
                const email = document.getElementById('input-promotor-email').value;
                const telefono = document.getElementById('input-promotor-telefono').value;
                const estado = document.getElementById('input-promotor-estado').value;
                const comision = document.getElementById('input-promotor-comision').value;
                const banco = document.getElementById('input-promotor-banco').value;
                const cuenta = document.getElementById('input-promotor-cuenta').value;
                const notas = document.getElementById('input-promotor-notas').value;
                const fechaCreacion = isEditing ? submitBtn.getAttribute('data-fecha-creacion') : new Date().toISOString().slice(0, 19).replace('T', ' ');
                const fechaActualizacion = new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Initialize or preserve metrics (17 columns A-Q)
                const referidosActivos = isEditing ? (submitBtn.getAttribute('data-referidos') || '0') : '0';
                const proyectosGanados = isEditing ? (submitBtn.getAttribute('data-proyectos') || '0') : '0';
                const tasaConversion = isEditing ? (submitBtn.getAttribute('data-tasa') || '0%') : '0%';
                const comisionTotal = isEditing ? (submitBtn.getAttribute('data-total') || '$0') : '$0';
                const comisionPagada = isEditing ? (submitBtn.getAttribute('data-pagada') || '$0') : '$0';
                const comisionPendiente = isEditing ? (submitBtn.getAttribute('data-pendiente') || '$0') : '$0';

                // Create row data
                const rowData = [[
                    id,
                    nombre,
                    email,
                    telefono,
                    estado,
                    comision,
                    referidosActivos,
                    proyectosGanados,
                    tasaConversion,
                    comisionTotal,
                    comisionPagada,
                    comisionPendiente,
                    banco,
                    cuenta,
                    notas,
                    fechaCreacion,
                    fechaActualizacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.PROMOTORES, `A${editRow}:Q${editRow}`, rowData);
                    showToast('Promotor actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.PROMOTORES, rowData);
                    showToast('Promotor guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-promotores').reset();
                submitBtn.textContent = 'Guardar Promotor';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');
                submitBtn.removeAttribute('data-fecha-creacion');
                submitBtn.removeAttribute('data-referidos');
                submitBtn.removeAttribute('data-proyectos');
                submitBtn.removeAttribute('data-tasa');
                submitBtn.removeAttribute('data-total');
                submitBtn.removeAttribute('data-pagada');
                submitBtn.removeAttribute('data-pendiente');

                // Reload table
                await loadPromotoresView();

            } catch (error) {
                console.error(' Error saving promotor:', error);
                showToast('Error al guardar promotor', 'error');
            }
        }

        /**
         * Edit Promotor
         */
        function editPromotor(rowNumber, rowData) {
            const [id, nombre, email, telefono, estado, comision, referidosActivos, proyectosGanados, tasaConversion, comisionTotal, comisionPagada, comisionPendiente, banco, cuenta, notas, fechaCreacion] = rowData;

            // Scroll to form
            document.getElementById('form-promotores').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-promotor-nombre').value = nombre || '';
            document.getElementById('input-promotor-email').value = email || '';
            document.getElementById('input-promotor-telefono').value = telefono || '';
            document.getElementById('input-promotor-estado').value = estado || '';
            document.getElementById('input-promotor-comision').value = comision || '';
            document.getElementById('input-promotor-banco').value = banco || '';
            document.getElementById('input-promotor-cuenta').value = cuenta || '';
            document.getElementById('input-promotor-notas').value = notas || '';

            // Change button text and add data attributes
            const submitBtn = document.querySelector('#form-promotores button[type="submit"]');
            submitBtn.textContent = 'Actualizar Promotor';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
            submitBtn.setAttribute('data-fecha-creacion', fechaCreacion);
            submitBtn.setAttribute('data-referidos', referidosActivos);
            submitBtn.setAttribute('data-proyectos', proyectosGanados);
            submitBtn.setAttribute('data-tasa', tasaConversion);
            submitBtn.setAttribute('data-total', comisionTotal);
            submitBtn.setAttribute('data-pagada', comisionPagada);
            submitBtn.setAttribute('data-pendiente', comisionPendiente);
        }

        /**
         * Delete Promotor
         */
        async function deletePromotor(rowNumber) {
            if (!confirm('驴Est谩s seguro de eliminar este promotor?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.PROMOTORES, `A${rowNumber}:Q${rowNumber}`);

                showToast('Promotor eliminado exitosamente', 'success');

                // Reload table
                await loadPromotoresView();

            } catch (error) {
                console.error(' Error deleting promotor:', error);
                showToast('Error al eliminar promotor', 'error');
            }
        }

        // ====================
        // GASTOS VIEW FUNCTIONS
        // ====================

        // Store data for search/filter
        let allGastosData = [];

        /**
         * Load Gastos View
         */
        async function loadGastosView() {
            try {
                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.GASTOS, 'A2:M');
                allGastosData = data || [];
                renderGastosTable(allGastosData);
            } catch (error) {
                console.error(' Error loading gastos:', error);
                showToast('Error al cargar gastos', 'error');
            }
        }

        /**
         * Filter Gastos table by search term
         */
        function filterGastosTable(searchTerm) {
            if (!searchTerm) {
                renderGastosTable(allGastosData);
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const filtered = allGastosData.filter(row => {
                const [id, fecha, concepto, categoria] = row;
                return (
                    (concepto && concepto.toLowerCase().includes(searchLower)) ||
                    (categoria && categoria.toLowerCase().includes(searchLower))
                );
            });
            renderGastosTable(filtered);
        }

        /**
         * Render Gastos Table
         */
        function renderGastosTable(data) {
            const tbody = document.getElementById('table-gastos-body');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">No hay gastos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const [id, fecha, concepto, categoria, monto, metodoPago, proveedor, proyecto, estado] = row;
                const estadoColor = getGastoEstadoColor(estado);
                return `
                    <tr>
                        <td class="py-3 px-4 border-b border-gray-700">${id || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${fecha || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${concepto || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${categoria || ''}</td>
                        <td class="py-3 px-4 border-b border-gray-700">${formatCurrency(monto)}</td>
                        <td class="py-3 px-4 border-b border-gray-700">
                            <span class="px-3 py-1 rounded-full text-sm bg-${estadoColor}-500/20 text-${estadoColor}-400">${estado || ''}</span>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-700 space-x-2">
                            <button onclick='editGasto(${index + 2}, ${JSON.stringify(row)})' class="text-blue-400 hover:text-blue-300">
                                锔 Editar
                            </button>
                            <button onclick="deleteGasto(${index + 2})" class="text-red-400 hover:text-red-300">
                                锔 Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Get Gasto Estado Color
         */
        function getGastoEstadoColor(estado) {
            switch (estado) {
                case 'Pagado': return 'green';
                case 'Pendiente': return 'yellow';
                case 'Rechazado': return 'red';
                default: return 'gray';
            }
        }

        /**
         * Generate Gasto ID
         */
        function generateGastoId() {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `GAS-${year}-${random}`;
        }

        /**
         * Handle Gastos form submission
         */
        async function handleGastosSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const isEditing = submitBtn.hasAttribute('data-edit-row');
            const editRow = submitBtn.getAttribute('data-edit-row');
            const editId = submitBtn.getAttribute('data-edit-id');

            try {
                // Get form values
                const id = isEditing ? editId : generateGastoId();
                const fecha = document.getElementById('input-gasto-fecha').value;
                const concepto = document.getElementById('input-gasto-concepto').value;
                const categoria = document.getElementById('input-gasto-categoria').value;
                const monto = document.getElementById('input-gasto-monto').value;
                const metodoPago = document.getElementById('input-gasto-metodo').value;
                const proveedor = document.getElementById('input-gasto-proveedor').value;
                const proyecto = document.getElementById('input-gasto-proyecto').value;
                const estado = document.getElementById('input-gasto-estado').value;
                const facturaRecibo = document.getElementById('input-gasto-factura').value;
                const esRecurrente = document.getElementById('input-gasto-recurrente').value;
                const notas = document.getElementById('input-gasto-notas').value;
                const fechaCreacion = isEditing ? submitBtn.getAttribute('data-fecha-creacion') : new Date().toISOString().slice(0, 19).replace('T', ' ');

                // Create row data (13 columns A-M)
                const rowData = [[
                    id,
                    fecha,
                    concepto,
                    categoria,
                    monto,
                    metodoPago,
                    proveedor,
                    proyecto,
                    estado,
                    facturaRecibo,
                    esRecurrente,
                    notas,
                    fechaCreacion
                ]];

                if (isEditing) {
                    // Update existing row
                    await sheetsAPI.updateSheet(CONFIG.SHEETS.GASTOS, `A${editRow}:M${editRow}`, rowData);
                    showToast('Gasto actualizado exitosamente', 'success');
                } else {
                    // Create new row
                    await sheetsAPI.writeSheet(CONFIG.SHEETS.GASTOS, rowData);
                    showToast('Gasto guardado exitosamente', 'success');
                }

                // Reset form
                document.getElementById('form-gastos').reset();
                submitBtn.textContent = 'Guardar Gasto';
                submitBtn.removeAttribute('data-edit-row');
                submitBtn.removeAttribute('data-edit-id');
                submitBtn.removeAttribute('data-fecha-creacion');

                // Reload table
                await loadGastosView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error(' Error saving gasto:', error);
                showToast('Error al guardar gasto', 'error');
            }
        }

        /**
         * Edit Gasto
         */
        function editGasto(rowNumber, rowData) {
            const [id, fecha, concepto, categoria, monto, metodoPago, proveedor, proyecto, estado, facturaRecibo, esRecurrente, notas, fechaCreacion] = rowData;

            // Scroll to form
            document.getElementById('form-gastos').scrollIntoView({ behavior: 'smooth' });

            // Pre-fill form
            document.getElementById('input-gasto-fecha').value = fecha || '';
            document.getElementById('input-gasto-concepto').value = concepto || '';
            document.getElementById('input-gasto-categoria').value = categoria || '';
            document.getElementById('input-gasto-monto').value = monto || '';
            document.getElementById('input-gasto-metodo').value = metodoPago || '';
            document.getElementById('input-gasto-proveedor').value = proveedor || '';
            document.getElementById('input-gasto-proyecto').value = proyecto || '';
            document.getElementById('input-gasto-estado').value = estado || '';
            document.getElementById('input-gasto-factura').value = facturaRecibo || '';
            document.getElementById('input-gasto-recurrente').value = esRecurrente || '';
            document.getElementById('input-gasto-notas').value = notas || '';

            // Change button text and add data attribute
            const submitBtn = document.querySelector('#form-gastos button[type="submit"]');
            submitBtn.textContent = 'Actualizar Gasto';
            submitBtn.setAttribute('data-edit-row', rowNumber);
            submitBtn.setAttribute('data-edit-id', id);
            submitBtn.setAttribute('data-fecha-creacion', fechaCreacion);
        }

        /**
         * Delete Gasto
         */
        async function deleteGasto(rowNumber) {
            if (!confirm('驴Est谩s seguro de eliminar este gasto?')) {
                return;
            }

            try {
                // Delete row (clear content)
                await sheetsAPI.deleteSheet(CONFIG.SHEETS.GASTOS, `A${rowNumber}:M${rowNumber}`);

                showToast('Gasto eliminado exitosamente', 'success');

                // Reload table
                await loadGastosView();

                // Reload dashboard
                loadDashboardData();

            } catch (error) {
                console.error(' Error deleting gasto:', error);
                showToast('Error al eliminar gasto', 'error');
            }
        }

        // ====================
        // DROPDOWN POPULATION FUNCTIONS
        // ====================

        /**
         * Populate Clientes dropdown in Proyectos from Contactos
         */
        async function populateClientesDropdown() {
            const dropdown = document.getElementById('input-proyecto-cliente');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value=""> Cargando clientes...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.CONTACTOS, 'A2:O');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Selecciona un cliente...</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, email, telefono, empresa] = row;
                        if (nombre) {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.setAttribute('data-email', email || '');
                            option.textContent = `${nombre}${empresa ? ` (${empresa})` : ''}`;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    console.log(` ${count} clientes cargados`);
                } else {
                    // Empty state
                    dropdown.innerHTML = '<option value="">锔 No hay contactos - Ve a Contactos para agregar</option>';
                }
            } catch (error) {
                console.error(' Error loading clientes:', error);
                dropdown.innerHTML = '<option value=""> Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de clientes', 'error');
            }
        }

        /**
         * Populate Promotores dropdown in Proyectos from Promotores
         */
        async function populatePromotoresDropdown() {
            const dropdown = document.getElementById('input-proyecto-promotor');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value=""> Cargando promotores...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROMOTORES, 'A2:Q');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Sin promotor</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, email, telefono, estado] = row;
                        if (nombre && estado === 'Activo') {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.textContent = nombre;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    if (count === 0) {
                        dropdown.innerHTML = '<option value="">锔 No hay promotores activos</option>';
                    } else {
                        console.log(` ${count} promotores activos cargados`);
                    }
                } else {
                    // Empty state
                    dropdown.innerHTML = '<option value="">锔 No hay promotores - Ve a Promotores para agregar</option>';
                }
            } catch (error) {
                console.error(' Error loading promotores:', error);
                dropdown.innerHTML = '<option value=""> Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de promotores', 'error');
            }
        }

        /**
         * Populate Proyectos dropdown in Facturaci贸n from Proyectos
         */
        async function populateProyectosDropdownFacturacion() {
            const dropdown = document.getElementById('input-factura-proyecto');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value=""> Cargando proyectos...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS, 'A2:O');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Selecciona un proyecto...</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, cliente] = row;
                        if (nombre) {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.setAttribute('data-cliente', cliente || '');
                            option.textContent = `${nombre}${cliente ? ` - ${cliente}` : ''}`;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    console.log(` ${count} proyectos cargados`);
                } else {
                    // Empty state
                    dropdown.innerHTML = '<option value="">锔 No hay proyectos - Ve a Proyectos para crear</option>';
                }
            } catch (error) {
                console.error(' Error loading proyectos:', error);
                dropdown.innerHTML = '<option value=""> Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de proyectos', 'error');
            }
        }

        /**
         * Populate Proyectos dropdown in Gastos from Proyectos
         */
        async function populateProyectosDropdownGastos() {
            const dropdown = document.getElementById('input-gasto-proyecto');

            try {
                // Show loading state
                dropdown.innerHTML = '<option value=""> Cargando proyectos...</option>';
                dropdown.disabled = true;

                const data = await sheetsAPI.readSheet(CONFIG.SHEETS.PROYECTOS, 'A2:O');

                // Reset dropdown
                dropdown.innerHTML = '<option value="">Sin proyecto asociado</option>';
                dropdown.disabled = false;

                if (data && data.length > 0) {
                    let count = 0;
                    data.forEach(row => {
                        const [id, nombre, cliente] = row;
                        if (nombre) {
                            const option = document.createElement('option');
                            option.value = nombre;
                            option.textContent = `${nombre}${cliente ? ` - ${cliente}` : ''}`;
                            dropdown.appendChild(option);
                            count++;
                        }
                    });
                    console.log(` ${count} proyectos cargados para gastos`);
                } else {
                    // Empty state (opcional, so just keep default)
                    console.log('锔 No hay proyectos disponibles');
                }
            } catch (error) {
                console.error(' Error loading proyectos:', error);
                dropdown.innerHTML = '<option value=""> Error al cargar - Intenta refrescar</option>';
                dropdown.disabled = false;
                showToast('Error al cargar lista de proyectos', 'error');
            }
        }

        /**
         * Handle Cliente selection in Proyectos (auto-fill email)
         */
        function handleClienteSelection() {
            const dropdown = document.getElementById('input-proyecto-cliente');
            const emailInput = document.getElementById('input-proyecto-email');

            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const email = selectedOption.getAttribute('data-email') || '';

            emailInput.value = email;
        }

        /**
         * Handle Proyecto selection in Facturaci贸n (auto-fill cliente)
         */
        function handleProyectoSelectionFacturacion() {
            const dropdown = document.getElementById('input-factura-proyecto');
            const clienteInput = document.getElementById('input-factura-cliente');

            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const cliente = selectedOption.getAttribute('data-cliente') || '';

            clienteInput.value = cliente;
        }

        // Initialize navigation
        function initNavigation() {
            // Navigation
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.currentTarget.dataset.view;

                    // Update active state
                    document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    // Show view
                    document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
                    document.getElementById(`view-${view}`).classList.remove('hidden');
                });
            });

            // Mobile menu toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('hidden');
            });

            // Pipeline view event listeners
            document.getElementById('form-pipeline').addEventListener('submit', handlePipelineSubmit);
            document.getElementById('btn-refresh-pipeline').addEventListener('click', loadPipelineView);

            // Search filter for Pipeline
            document.getElementById('search-pipeline').addEventListener('input', (e) => {
                filterPipelineTable(e.target.value);
            });

            // Load Pipeline view when navigating to it
            document.querySelector('[data-view="pipeline"]').addEventListener('click', () => {
                setTimeout(() => loadPipelineView(), 100);
            });

            // Proyectos view event listeners
            document.getElementById('form-proyectos').addEventListener('submit', handleProyectosSubmit);
            document.getElementById('btn-refresh-proyectos').addEventListener('click', loadProyectosView);

            // Auto-fill email when cliente is selected
            document.getElementById('input-proyecto-cliente').addEventListener('change', handleClienteSelection);

            // Search filter for Proyectos
            document.getElementById('search-proyectos').addEventListener('input', (e) => {
                filterProyectosTable(e.target.value);
            });

            // Load Proyectos view when navigating to it
            document.querySelector('[data-view="proyectos"]').addEventListener('click', () => {
                setTimeout(async () => {
                    await loadProyectosView();
                    await populateClientesDropdown();
                    await populatePromotoresDropdown();
                }, 100);
            });

            // Facturaci贸n view event listeners
            document.getElementById('form-facturacion').addEventListener('submit', handleFacturacionSubmit);
            document.getElementById('btn-refresh-facturacion').addEventListener('click', loadFacturacionView);

            // Auto-calculate monto total when monto or IVA changes
            document.getElementById('input-factura-monto').addEventListener('input', calculateMontoTotal);
            document.getElementById('input-factura-iva').addEventListener('change', calculateMontoTotal);

            // Auto-fill cliente when proyecto is selected
            document.getElementById('input-factura-proyecto').addEventListener('change', handleProyectoSelectionFacturacion);

            // Search filter for Facturaci贸n
            document.getElementById('search-facturacion').addEventListener('input', (e) => {
                filterFacturacionTable(e.target.value);
            });

            // Load Facturaci贸n view when navigating to it
            document.querySelector('[data-view="facturacion"]').addEventListener('click', () => {
                setTimeout(async () => {
                    await loadFacturacionView();
                    await populateProyectosDropdownFacturacion();
                }, 100);
            });

            // Contactos view event listeners
            document.getElementById('form-contactos').addEventListener('submit', handleContactosSubmit);
            document.getElementById('btn-refresh-contactos').addEventListener('click', loadContactosView);

            // Search filter for Contactos
            document.getElementById('search-contactos').addEventListener('input', (e) => {
                filterContactosTable(e.target.value);
            });

            // Load Contactos view when navigating to it
            document.querySelector('[data-view="contactos"]').addEventListener('click', () => {
                setTimeout(() => loadContactosView(), 100);
            });

            // Promotores view event listeners
            document.getElementById('form-promotores').addEventListener('submit', handlePromotoresSubmit);
            document.getElementById('btn-refresh-promotores').addEventListener('click', loadPromotoresView);

            // Search filter for Promotores
            document.getElementById('search-promotores').addEventListener('input', (e) => {
                filterPromotoresTable(e.target.value);
            });

            // Load Promotores view when navigating to it
            document.querySelector('[data-view="promotores"]').addEventListener('click', () => {
                setTimeout(() => loadPromotoresView(), 100);
            });

            // Gastos view event listeners
            document.getElementById('form-gastos').addEventListener('submit', handleGastosSubmit);
            document.getElementById('btn-refresh-gastos').addEventListener('click', loadGastosView);

            // Search filter for Gastos
            document.getElementById('search-gastos').addEventListener('input', (e) => {
                filterGastosTable(e.target.value);
            });

            // Load Gastos view when navigating to it
            document.querySelector('[data-view="gastos"]').addEventListener('click', () => {
                setTimeout(async () => {
                    await loadGastosView();
                    await populateProyectosDropdownGastos();
                }, 100);
            });
        }
    </script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
